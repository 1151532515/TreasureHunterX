{"version":3,"sources":["../../../../assets/scripts/assets/scripts/ResultPanel.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","onCloseDelegate","type","Object","default","onAgainClicked","winnerPanel","Node","loserPanel","resultCompareNode","avatars","SpriteFrame","myAvatarNode","onLoad","resultPanelNode","node","againButtonNode","getChildByName","homeButtonNode","againBtnOnClick","evt","onClose","homeBtnOnClick","closeWSConnection","director","loadScene","showPlayerInfo","players","self","winnerNameNode","loserNameNode","compareProgressNode","winnerInfo","loserInfo","playerId","playerInfo","score","getComponent","Label","string","constants","PLAYER_NAME","joinIndex","progressComp","ProgressBar","winnerScore","parseInt","loserScore","ratio","Math","abs","progress","winnerAvatar","loserAvatar","Sprite","spriteFrame","selfPlayerInfo","JSON","parse","sys","localStorage","selfPlayer","remoteUrl","avatar","console","log","loader","load","url","err","texture","error","sf","setTexture","showMyAvatar","myJoinIndex","myInfo","id","showRibbon","ribbonNode","loadRes","parent","removeChild"],"mappings":"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","file":"ResultPanel.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n\n  extends: cc.Component,\n\n  properties: {\n    onCloseDelegate: {\n      type: cc.Object,\n      default: null\n    },\n    onAgainClicked: {\n      type: cc.Object,\n      default: null\n    },\n    winnerPanel: {\n      type: cc.Node,\n      default: null\n    },\n    loserPanel: {\n      type: cc.Node,\n      default: null\n    },\n    resultCompareNode: {\n      type: cc.Node,\n      default: null\n    },\n\n    avatars: {\n      type: [cc.SpriteFrame],\n      default: []\n    },\n\n    myAvatarNode: {\n      type: cc.Node,\n      default: null,\n    },\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    const resultPanelNode = this.node;\n    const againButtonNode = resultPanelNode.getChildByName(\"againBtn\");  \n    const homeButtonNode = resultPanelNode.getChildByName(\"homeBtn\");  \n  },\n\n  againBtnOnClick(evt) {\n    this.onClose();\n    if (!this.onAgainClicked) return;\n    this.onAgainClicked();\n  },\n\n  homeBtnOnClick(evt) {\n    window.closeWSConnection();\n    cc.director.loadScene('login');\n  },\n\n  showPlayerInfo(players) {\n    const self = this;\n    const resultPanelNode = this.node;\n    const winnerNameNode = resultPanelNode.getChildByName(\"winnerName\");\n    const loserNameNode = resultPanelNode.getChildByName(\"loserName\");\n    const resultCompareNode = this.resultCompareNode;\n    const compareProgressNode = resultCompareNode.getChildByName(\"progressbar\");\n    let winnerInfo = null;\n    let loserInfo = null;\n    \n    for(let playerId in players) {\n      const playerInfo = players[playerId];\n      if(!winnerInfo) {\n        winnerInfo =  playerInfo; \n        continue;\n      }\n      if(playerInfo.score >= winnerInfo.score) {\n        loserInfo = winnerInfo;\n        winnerInfo = playerInfo;\n      }else {\n        loserInfo = playerInfo;\n      }\n    }\n    //TODO Hardecode the name\n    winnerNameNode.getComponent(cc.Label).string = constants.PLAYER_NAME[winnerInfo.joinIndex];\n    loserNameNode.getComponent(cc.Label).string = constants.PLAYER_NAME[loserInfo.joinIndex];\n  \n    const progressComp = compareProgressNode.getComponent(cc.ProgressBar);\n    const winnerScore = parseInt(winnerInfo.score);\n    const loserScore = parseInt(loserInfo.score); \n    let ratio = 0.5; \n    if(winnerScore != loserScore){\n      ratio = (loserScore * winnerScore <= 0) ? 1 \n              : Math.abs(winnerScore) / Math.abs((loserScore + winnerScore));\n    }\n    progressComp.progress = ratio; \n    \n    resultCompareNode.getChildByName(\"winnerScore\").getComponent(cc.Label).string = winnerScore;\n    resultCompareNode.getChildByName(\"loserScore\").getComponent(cc.Label).string = loserScore;\n    \n    /*\n   const plistDir = \"textures/StatusBar\";\n\n   cc.loader.loadRes(plistDir, cc.SpriteAtlas, function (err, altas) {\n    if(err){\n      cc.warn(err);\n      return;\n    }\n    //hardecode avatart by joinIndex\n    //let winnerAvatar = altas.getSpriteFrame(winnerInfo.joinIndex == 2 ? \"BlueAvatar\" : \"RedAvatar\")\n    //let loserAvatar = altas.getSpriteFrame(loserInfo.joinIndex == 2 ? \"BlueAvatar\" : \"RedAvatar\")\n    let winnerAvatar = self.avatars[winnerInfo.joinIndex == 2 ? 0 : 1]\n    let loserAvatar = self.avatars[loserInfo.joinIndex == 2 ? 0 : 1]\n    //let loserAvatar = altas.getSpriteFrame(loserInfo.joinIndex == 2 ? \"BlueAvatar\" : \"RedAvatar\")\n    resultPanelNode.getChildByName(\"winnerPortrait\").getComponent(cc.Sprite).spriteFrame = winnerAvatar;\n    resultPanelNode.getChildByName(\"loserPortrait\").getComponent(cc.Sprite).spriteFrame = loserAvatar;\n   });\n   */\n\n   //let loserAvatar = altas.getSpriteFrame(loserInfo.joinIndex == 2 ? \"BlueAvatar\" : \"RedAvatar\")\n\n   /*\n   for (let i in players) {\n     const playerInfo = players[i];\n     const playerInfoNode = this.playersInfoNode[playerInfo.joinIndex];\n\n     (() => { //远程加载头像\n       let remoteUrl = playerInfo.avatar;\n       if(remoteUrl == ''){\n         console.log('用户'+ i +' 没有头像, 提供临时头像');\n         remoteUrl = 'http://wx.qlogo.cn/mmopen/xzq2UIB49VaicY1Hk3jDLk6e8nISmsQuEcqxicEMuC1jKx75QnwibDLWnRHoEmMZdKOJWjspUd8aSD8DfoUYLEqQJ6rcHibNP5Gib/0';\n       }\n       cc.loader.load({url: remoteUrl, type: 'jpg'}, function (err, texture) {\n         if(err != null){\n           console.error(err);\n         }else{\n           const sf = new cc.SpriteFrame();\n           sf.setTexture(texture);\n           playerInfoNode.getChildByName('avatarMask').getChildByName('avatar').getComponent(cc.Sprite).spriteFrame = sf;\n         }\n       });\n     })();\n   }\n   */\n\n   let winnerAvatar = self.avatars[winnerInfo.joinIndex == 2 ? 1 : 0]\n   let loserAvatar = self.avatars[loserInfo.joinIndex == 2 ? 1 : 0]\n   resultPanelNode.getChildByName(\"winnerPortrait\").getComponent(cc.Sprite).spriteFrame = winnerAvatar;\n   resultPanelNode.getChildByName(\"loserPortrait\").getComponent(cc.Sprite).spriteFrame = loserAvatar;\n\n   //this.showRibbon(winnerInfo, resultPanelNode.getChildByName(\"ribbon\"));  \n   //this.showMyAvatar(players);  \n\n   (() => { //远程加载头像\n     const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n     let remoteUrl = selfPlayerInfo.avatar;\n     if(remoteUrl == ''){\n       console.log('自己没有没有头像, 提供临时头像');\n       remoteUrl = 'http://wx.qlogo.cn/mmopen/xzq2UIB49VaicY1Hk3jDLk6e8nISmsQuEcqxicEMuC1jKx75QnwibDLWnRHoEmMZdKOJWjspUd8aSD8DfoUYLEqQJ6rcHibNP5Gib/0';\n     }\n     cc.loader.load({url: remoteUrl, type: 'jpg'}, function (err, texture) {\n       if(err != null){\n         console.error(err);\n       }else{\n         const sf = new cc.SpriteFrame();\n         sf.setTexture(texture);\n\n         self.myAvatarNode.getComponent(cc.Sprite).spriteFrame = sf;\n         //playerInfoNode.getChildByName('avatarMask').getChildByName('avatar').getComponent(cc.Sprite).spriteFrame = sf;\n       }\n     });\n   })();\n\n  },\n\n  showMyAvatar(players){\n    const self = this;\n    //console.warn(\"!!!!!!!!!!!!!!!!!!!\");\n    //Get joinindex\n    const myJoinIndex = (() => {\n      const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n      console.log(selfPlayerInfo)\n\n      let myInfo = null;\n      for(let id in players){\n        if(selfPlayerInfo.playerId == id){\n          myInfo = players[id];\n          break;\n        }\n      }\n\n      return myInfo.joinIndex;\n    })();\n\n\n    if(myJoinIndex == 2){ //第二加入, 显示蓝色头像\n      this.myAvatarNode.getComponent(cc.Sprite).spriteFrame = self.avatars[1];\n    }else if(myJoinIndex == 1){ //第一加入, 显示红色头像\n      this.myAvatarNode.getComponent(cc.Sprite).spriteFrame = self.avatars[0];\n    }else{\n      console.error('错误显示自己的头像')\n    }\n  },\n \n  showRibbon(winnerInfo, ribbonNode) {\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const texture = (selfPlayerInfo.playerId == winnerInfo.id) ? \"textures/resultPanel/WinRibbon\" : \"textures/resultPanel/loseRibbon\";\n    cc.loader.loadRes(texture, cc.SpriteFrame, function (err, spriteFrame) {\n      if(err) {\n        console.log(err);\n        return;\n      }\n      ribbonNode.getComponent(cc.Sprite).spriteFrame = spriteFrame;\n    });\n\n  },\n  \n  onClose(evt) {\n    if (this.node.parent) {\n      this.node.parent.removeChild(this.node); \n    }\n    if (!this.onCloseDelegate) { \n      return;\n    }\n    this.onCloseDelegate();\n  }\n});\n"]}