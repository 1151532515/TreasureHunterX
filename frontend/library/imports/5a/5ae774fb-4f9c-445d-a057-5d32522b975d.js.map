{"version":3,"sources":["../../../../assets/scripts/assets/scripts/ResultPanel.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","onCloseDelegate","type","Object","default","onAgainClicked","myAvatarNode","Node","myNameNode","rankingNodes","myRandNode","onLoad","resultPanelNode","node","againButtonNode","getChildByName","homeButtonNode","againBtnOnClick","evt","onClose","homeBtnOnClick","closeWSConnection","director","loadScene","showPlayerInfo","players","showRanking","showMyAvatar","showMyName","selfPlayerInfo","JSON","parse","sys","localStorage","selfPlayer","name","displayName","getComponent","Label","string","self","sortablePlayers","playerId","push","sortedPlayers","sort","a","b","score","forEach","p","id","nameToDisplay","isEmptyString","str","rank","active","remoteUrl","avatar","log","loader","load","url","err","texture","console","sf","SpriteFrame","setTexture","Sprite","spriteFrame","showRibbon","winnerInfo","ribbonNode","loadRes","parent","removeChild"],"mappings":"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","file":"ResultPanel.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n\n  extends: cc.Component,\n\n  properties: {\n    onCloseDelegate: {\n      type: cc.Object,\n      default: null\n    },\n    onAgainClicked: {\n      type: cc.Object,\n      default: null\n    },\n\n    myAvatarNode: {\n      type: cc.Node,\n      default: null,\n    },\n\n    myNameNode: {\n      type: cc.Node,\n      default: null,\n    },\n\n    rankingNodes: {\n      type: [cc.Node],\n      default: [],\n    },\n\n    myRandNode: {\n      type: cc.Node,\n      default: null,\n    },\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    const resultPanelNode = this.node;\n    const againButtonNode = resultPanelNode.getChildByName(\"againBtn\");\n    const homeButtonNode = resultPanelNode.getChildByName(\"homeBtn\");\n  },\n\n  againBtnOnClick(evt) {\n    this.onClose();\n    if (!this.onAgainClicked) return;\n    this.onAgainClicked();\n  },\n\n  homeBtnOnClick(evt) {\n    window.closeWSConnection();\n    cc.director.loadScene('login');\n  },\n\n  showPlayerInfo(players) {\n    this.showRanking(players);\n    this.showMyAvatar();\n    this.showMyName();\n  },\n\n\n  showMyName(){\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n    let name = 'No name';\n    if(selfPlayerInfo.displayName == null || selfPlayerInfo.displayName == ''){\n      name = selfPlayerInfo.name\n    }else{\n      name = selfPlayerInfo.displayName\n    }\n    this.myNameNode.getComponent(cc.Label).string = name;\n\n\n  },\n\n  showRanking(players){\n    const self = this;\n    const sortablePlayers = [];\n\n    for (let playerId in players) {\n      \n      sortablePlayers.push(players[playerId])\n    }\n    const sortedPlayers = sortablePlayers.sort((a, b) => {\n      if(a.score == null){//为null的必定排后面\n        return 1;\n      }else if(b.score == null){//为null的必定排后面\n        return -1;\n      }else{\n        if(a.score < b.score){//分数大的排前面\n          return 1;\n        }else{\n          return -1;\n        }\n      }\n    })\n\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n    sortedPlayers.forEach((p, id) => {\n      const nameToDisplay = (() =>{\n        function isEmptyString(str){\n          return str == null || str == ''\n        }\n        if(!isEmptyString(p.displayName)){\n          return p.displayName\n        }else if(!isEmptyString(p.name)){\n          return p.name\n        }else{\n          return \"No name\"\n        }\n      })();\n\n      if(selfPlayerInfo.playerId == p.id){ //显示我的排名\n        const rank = id + 1;\n        //self.myRandNode.getComponent(cc.Label).string = \"No.\" + rank;\n        if(rank != 1){\n          self.myRandNode.active = false;\n        }\n      }\n\n      self.rankingNodes[id].getChildByName('name').getComponent(cc.Label).string = nameToDisplay;\n      //self.rankingNodes[id].getChildByName('score').getComponent(cc.Label).string = p.score;\n    })\n  },\n\n  showMyAvatar() {\n    const self = this;\n    (() => { //加载自己的头像\n      const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n      let remoteUrl = selfPlayerInfo.avatar;\n      if (remoteUrl == null || remoteUrl == '') {\n        cc.log(`No avatar to show for myself, check storage.`);\n        return;\n      }else{\n        cc.loader.load({\n          url: remoteUrl,\n          type: 'jpg'\n        }, function(err, texture) {\n          if (err != null || texture == null) {\n            console.log(err);\n          } else {\n            const sf = new cc.SpriteFrame();\n            sf.setTexture(texture);\n            self.myAvatarNode.getComponent(cc.Sprite).spriteFrame = sf;\n          }\n        });\n      }\n    })();\n  },\n\n  showRibbon(winnerInfo, ribbonNode) {\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const texture = (selfPlayerInfo.playerId == winnerInfo.id) ? \"textures/resultPanel/WinRibbon\" : \"textures/resultPanel/loseRibbon\";\n    cc.loader.loadRes(texture, cc.SpriteFrame, function(err, spriteFrame) {\n      if (err) {\n        console.log(err);\n        return;\n      }\n      ribbonNode.getComponent(cc.Sprite).spriteFrame = spriteFrame;\n    });\n\n  },\n\n  onClose(evt) {\n    if (this.node.parent) {\n      this.node.parent.removeChild(this.node);\n    }\n    if (!this.onCloseDelegate) {\n      return;\n    }\n    this.onCloseDelegate();\n  }\n});\n"]}