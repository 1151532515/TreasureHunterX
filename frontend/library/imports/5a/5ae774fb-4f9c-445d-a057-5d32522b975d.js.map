{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\ResultPanel.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","onCloseDelegate","type","Object","default","onAgainClicked","myAvatarNode","Node","myNameNode","rankingNodes","winNode","onLoad","againBtnOnClick","evt","onClose","homeBtnOnClick","mapIns","clearLocalStorageAndBackToLoginScene","showPlayerInfo","playerMetas","showRanking","showMyAvatar","showMyName","selfPlayerInfo","JSON","parse","sys","localStorage","getItem","name","displayName","myNameNodeLabel","getComponent","Label","string","self","sortablePlayers","playerId","p","id","push","sortedPlayers","sort","a","b","score","k","nameToDisplay","isEmptyString","str","rank","active","getChildByName","remoteUrl","avatar","log","loader","load","url","err","texture","console","sf","SpriteFrame","setTexture","Sprite","spriteFrame","showRibbon","winnerInfo","ribbonNode","loadRes","node","parent","removeChild"],"mappings":"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","file":"ResultPanel.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\ncc.Class({\r\n  extends: cc.Component,\r\n  properties: {\r\n    onCloseDelegate: {\r\n      type: cc.Object,\r\n      default: null\r\n    },\r\n    onAgainClicked: {\r\n      type: cc.Object,\r\n      default: null\r\n    },\r\n    myAvatarNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    myNameNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    rankingNodes: {\r\n      type: [cc.Node],\r\n      default: [],\r\n    },\r\n    winNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n  },\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n  onLoad() {\r\n  },\r\n\r\n  againBtnOnClick(evt) {\r\n    this.onClose();\r\n    if (!this.onAgainClicked) return;\r\n    this.onAgainClicked();\r\n  },\r\n\r\n  homeBtnOnClick(evt) {\r\n    if (null == window.mapIns) return;    \r\n    window.mapIns.clearLocalStorageAndBackToLoginScene();\r\n  },\r\n\r\n  showPlayerInfo(playerMetas) {\r\n    this.showRanking(playerMetas);\r\n    this.showMyAvatar();\r\n    this.showMyName();\r\n  },\r\n\r\n  showMyName() {\r\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n    let name = 'No name';\r\n    if (null == selfPlayerInfo.displayName || \"\" == selfPlayerInfo.displayName) {\r\n      name = selfPlayerInfo.name;\r\n    } else {\r\n      name = selfPlayerInfo.displayName;\r\n    }\r\n    if (!this.myNameNode) return;\r\n    const myNameNodeLabel = this.myNameNode.getComponent(cc.Label);\r\n    if (!myNameNodeLabel || null == name) return;\r\n    myNameNodeLabel.string = name;\r\n  },\r\n\r\n  showRanking(playerMetas) {\r\n    const self = this;\r\n    const sortablePlayers = [];\r\n\r\n    for (let playerId in playerMetas) {\r\n      const p = playerMetas[playerId];\r\n      p.id = playerId; //附带上id\r\n      sortablePlayers.push(p);\r\n    }\r\n    const sortedPlayers = sortablePlayers.sort((a, b) => {\r\n      if (a.score == null) { //为null的必定排后面\r\n        return 1;\r\n      } else if (b.score == null) { //为null的必定排后面\r\n        return -1;\r\n      } else {\r\n        if (a.score < b.score) { //分数大的排前面\r\n          return 1;\r\n        } else {\r\n          return -1;\r\n        }\r\n      }\r\n    })\r\n\r\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n    for (let k in sortedPlayers) {\r\n      const p = sortedPlayers[k]; \r\n      const nameToDisplay = (() => {\r\n        function isEmptyString(str) {\r\n          return str == null || str == '';\r\n        }\r\n        if (!isEmptyString(p.displayName)) {\r\n          return p.displayName;\r\n        } else if (!isEmptyString(p.name)) {\r\n          return p.name;\r\n        } else {\r\n          return \"\";\r\n        }\r\n      })();\r\n\r\n      if (selfPlayerInfo.playerId == p.id) { //如果不是第一名就不显示WIN字样\r\n        const rank = p.id + 1;\r\n        if (rank != 1 && null != self.winNode) {\r\n          self.winNode.active = false;\r\n        }\r\n      }\r\n\r\n      self.rankingNodes[p.id].getChildByName('name').getComponent(cc.Label).string = nameToDisplay;\r\n      self.rankingNodes[p.id].getChildByName('score').getComponent(cc.Label).string = p.score;\r\n    } \r\n  },\r\n\r\n  showMyAvatar() {\r\n    const self = this;\r\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n    let remoteUrl = selfPlayerInfo.avatar;\r\n    if (remoteUrl == null || remoteUrl == '') {\r\n      cc.log(`No avatar to show for myself, check storage.`);\r\n      return;\r\n    } else {\r\n      cc.loader.load({\r\n        url: remoteUrl,\r\n        type: 'jpg'\r\n      }, function(err, texture) {\r\n        if (err != null || texture == null) {\r\n          console.log(err);\r\n        } else {\r\n          const sf = new cc.SpriteFrame();\r\n          sf.setTexture(texture);\r\n          self.myAvatarNode.getComponent(cc.Sprite).spriteFrame = sf;\r\n        }\r\n      });\r\n    }\r\n  },\r\n\r\n  showRibbon(winnerInfo, ribbonNode) {\r\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n    const texture = (selfPlayerInfo.playerId == winnerInfo.id) ? \"textures/resultPanel/WinRibbon\" : \"textures/resultPanel/loseRibbon\";\r\n    cc.loader.loadRes(texture, cc.SpriteFrame, function(err, spriteFrame) {\r\n      if (err) {\r\n        console.log(err);\r\n        return;\r\n      }\r\n      ribbonNode.getComponent(cc.Sprite).spriteFrame = spriteFrame;\r\n    });\r\n\r\n  },\r\n\r\n  onClose(evt) {\r\n    if (this.node.parent) {\r\n      this.node.parent.removeChild(this.node);\r\n    }\r\n    if (!this.onCloseDelegate) {\r\n      return;\r\n    }\r\n    this.onCloseDelegate();\r\n  }\r\n});\r\n"]}