{"version":3,"sources":["../../../../assets/scripts/assets/scripts/ResultPanel.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","onCloseDelegate","type","Object","default","onAgainClicked","myAvatarNode","Node","myNameNode","rankingNodes","winNode","onLoad","resultPanelNode","node","againButtonNode","getChildByName","homeButtonNode","againBtnOnClick","evt","clientSession","readyState","WebSocket","CLOSED","console","warn","onClose","homeBtnOnClick","sys","platform","WECHAT_GAME","director","loadScene","showPlayerInfo","players","showRanking","showMyAvatar","showMyName","selfPlayerInfo","JSON","parse","localStorage","getItem","name","displayName","myNameNodeLabel","getComponent","Label","string","self","sortablePlayers","playerId","p","id","push","sortedPlayers","sort","a","b","score","forEach","nameToDisplay","isEmptyString","str","rank","active","remoteUrl","avatar","log","loader","load","url","err","texture","sf","SpriteFrame","setTexture","Sprite","spriteFrame","showRibbon","winnerInfo","ribbonNode","loadRes","parent","removeChild"],"mappings":"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","file":"ResultPanel.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n\n  extends: cc.Component,\n\n  properties: {\n    onCloseDelegate: {\n      type: cc.Object,\n      default: null\n    },\n    onAgainClicked: {\n      type: cc.Object,\n      default: null\n    },\n    myAvatarNode: {\n      type: cc.Node,\n      default: null,\n    },\n    myNameNode: {\n      type: cc.Node,\n      default: null,\n    },\n    rankingNodes: {\n      type: [cc.Node],\n      default: [],\n    },\n    winNode: {\n      type: cc.Node,\n      default: null,\n    },\n\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    const resultPanelNode = this.node;\n    const againButtonNode = resultPanelNode.getChildByName(\"againBtn\");\n    const homeButtonNode = resultPanelNode.getChildByName(\"homeBtn\");\n  },\n\n  againBtnOnClick(evt) {\n    if(null != window.clientSession && window.clientSession.readyState != WebSocket.CLOSED) {\n      console.warn('服务器端尚未断连, 不响应操作');\n      return;\n    }else{\n      this.onClose();\n      if (!this.onAgainClicked) return;\n      this.onAgainClicked();\n    }\n  },\n\n  homeBtnOnClick(evt) {\n    if(null != window.clientSession && window.clientSession.readyState != WebSocket.CLOSED) {\n      console.warn('服务器端尚未断连, 不响应操作');\n      return;//如果还没断连, 不响应操作, 直到服务器端主动断连\n    }else{//跳回登录页面\n      if(cc.sys.platform == cc.sys.WECHAT_GAME){\n        cc.director.loadScene('wechatGameLogin');\n      }else{\n        cc.director.loadScene('login');\n      }\n    }\n  },\n\n  showPlayerInfo(players) {\n    this.showRanking(players);\n    this.showMyAvatar();\n    this.showMyName();\n  },\n\n\n  showMyName() {\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n    let name = 'No name';\n    if (null == selfPlayerInfo.displayName || \"\" == selfPlayerInfo.displayName) {\n      name = selfPlayerInfo.name;\n    } else {\n      name = selfPlayerInfo.displayName;\n    }\n    if (!this.myNameNode) return;\n    const myNameNodeLabel = this.myNameNode.getComponent(cc.Label); \n    if (!myNameNodeLabel || null == name) return;\n    myNameNodeLabel.string = name;\n  },\n\n  showRanking(players) {\n    const self = this;\n    const sortablePlayers = [];\n\n    for (let playerId in players) {\n      const p = players[playerId];\n      p.id = playerId; //附带上id\n      sortablePlayers.push(p);\n    }\n    const sortedPlayers = sortablePlayers.sort((a, b) => {\n      if (a.score == null) { //为null的必定排后面\n        return 1;\n      } else if (b.score == null) { //为null的必定排后面\n        return -1;\n      } else {\n        if (a.score < b.score) { //分数大的排前面\n          return 1;\n        } else {\n          return -1;\n        }\n      }\n    })\n\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n    sortedPlayers.forEach((p, id) => {\n      const nameToDisplay = (() => {\n        function isEmptyString(str) {\n          return str == null || str == '';\n        }\n        if (!isEmptyString(p.displayName)) {\n          return p.displayName;\n        } else if (!isEmptyString(p.name)) {\n          return p.name;\n        } else {\n          return \"No name\";\n        }\n      })();\n\n      if (selfPlayerInfo.playerId == p.id) { //如果不是第一名就不显示WIN字样\n        const rank = id + 1;\n        if (rank != 1 && null != self.winNode) {\n          self.winNode.active = false;\n        }\n      }\n\n      self.rankingNodes[id].getChildByName('name').getComponent(cc.Label).string = nameToDisplay;\n      self.rankingNodes[id].getChildByName('score').getComponent(cc.Label).string = p.score;\n    })\n  },\n\n  showMyAvatar() {\n    const self = this;\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n    let remoteUrl = selfPlayerInfo.avatar;\n    if (remoteUrl == null || remoteUrl == '') {\n      cc.log(`No avatar to show for myself, check storage.`);\n      return;\n    } else {\n      cc.loader.load({\n        url: remoteUrl,\n        type: 'jpg'\n      }, function(err, texture) {\n        if (err != null || texture == null) {\n          console.log(err);\n        } else {\n          const sf = new cc.SpriteFrame();\n          sf.setTexture(texture);\n          self.myAvatarNode.getComponent(cc.Sprite).spriteFrame = sf;\n        }\n      });\n    }\n  },\n\n  showRibbon(winnerInfo, ribbonNode) {\n    const selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n    const texture = (selfPlayerInfo.playerId == winnerInfo.id) ? \"textures/resultPanel/WinRibbon\" : \"textures/resultPanel/loseRibbon\";\n    cc.loader.loadRes(texture, cc.SpriteFrame, function(err, spriteFrame) {\n      if (err) {\n        console.log(err);\n        return;\n      }\n      ribbonNode.getComponent(cc.Sprite).spriteFrame = spriteFrame;\n    });\n\n  },\n\n  onClose(evt) {\n    if (this.node.parent) {\n      this.node.parent.removeChild(this.node);\n    }\n    if (!this.onCloseDelegate) {\n      return;\n    }\n    this.onCloseDelegate();\n  }\n});\n"]}