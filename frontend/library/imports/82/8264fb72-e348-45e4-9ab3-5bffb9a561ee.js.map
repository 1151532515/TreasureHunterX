{"version":3,"sources":["../../../../assets/scripts/assets/scripts/WechatGameLogin.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","cavasNode","default","type","Node","backgroundNode","loadingPrefab","Prefab","tipsLabel","Label","onLoad","mapIns","console","warn","counter","sys","platform","WECHAT_GAME","mta","document","createElement","src","setAttribute","s","getElementsByTagName","parentNode","insertBefore","self","getRetCodeList","getRegexList","loader","loadRes","err","textAsset","error","message","showTips","checkIntAuthTokenExpire","then","intAuthToken","JSON","parse","localStorage","getItem","useTokenLogin","wx","authorize","scope","success","login","res","log","code","getUserInfo","userInfo","useWXCodeMiniGameLogin","fail","sysInfo","getSystemInfoSync","width","screenWidth","height","screenHeight","button","createUserInfoButton","text","style","left","top","backgroundColor","color","fontSize","textAlign","lineHeight","onTap","destroy","onDestroy","string","retCodeDict","constants","RET_CODE","regexList","EMAIL","PHONE","STREET_META","LNG_LAT_TEXT","SEO_KEYWORD","PASSWORD","SMS_CAPTCHA_CODE","ADMIN_HANDLE","onSMSCaptchaGetButtonClicked","evt","timerEnable","checkPhoneNumber","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","SMS_CAPTCHA","GET","data","phoneCountryCode","phoneCountryCodeInput","getComponent","EditBox","phoneNum","phoneNumberInput","ret","OK","phoneNumberTips","captchaTips","DUPLICATED","ALERT","TIP_LABEL","LOG_OUT","INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER","t","IS_TEST_ACC","smsLoginCaptchaInput","smsLoginCaptcha","SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY","countdownTime","smsLoginCaptchaButton","off","removeChild","smsGetCaptchaNode","smsWaitCountdownNode","parent","total","countdownTimer","setInterval","getChildByName","on","clearInterval","Promise","resolve","reject","selfPlayer","Date","getTime","expiresAt","phoneNumberRegexp","phoneNumberString","test","checkCaptcha","captchaRegexp","captchaString","length","_intAuthToken","INT_AUTH_TOKEN","LOGIN","resp","onLoggedIn","xhr","status","errMsg","clearBoundRoomIdInBothVolatileAndPersistentStorage","timeout","enableInteractiveControls","enabled","onLoginButtonClicked","loginParams","onWechatLoggedIn","date","Number","playerId","displayName","avatar","setItem","stringify","removeItem","WECHAT_LOGIN_FAILS","isUsingX5BlinkKernelOrWebkitWeChatKernel","initWxSdk","bind","name","director","loadScene","TOKEN_EXPIRED","SMS_CAPTCHA_NOT_MATCH","INCORRECT_CAPTCHA","SMS_CAPTCHA_CODE_NOT_EXISTING","INCORRECT_PHONE_NUMBER","INVALID_REQUEST_PARAM","INCORRECT_PHONE_COUNTRY_CODE","useWXCodeLogin","_code","WECHAT","history","replaceState","location","pathname","_userInfo","WECHATGAME","avatarUrl","nickName","mockWechatLoggedIn","getWechatCode","wechatServerEndpoint","wechatAddress","trim","AUTHORIZE_PATH","APPID_LITERAL","REDIRECT_RUI_KEY","encode","href","RESPONSE_TYPE","SCOPE","FIN","origUrl","protocol","host","shareLink","updateAppMsgShareDataObj","dataUrl","title","desc","link","imgUrl","menuShareTimelineObj","wxConfigUrl","isUsingWebkitWechatKernel","atFirstLocationHref","JSCONFIG","jsConfig","configData","debug","CC_DEBUG","appId","app_id","timestamp","toString","nonceStr","nonce_str","jsApiList","signature","config","ready","onMenuShareAppMessage","onMenuShareTimeline"],"mappings":"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","file":"WechatGameLogin.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    cavasNode: {\n      default: null,\n      type: cc.Node\n    },\n    backgroundNode: {\n      default: null,\n      type: cc.Node\n    },\n    loadingPrefab: {\n      default: null,\n      type: cc.Prefab\n    },\n    tipsLabel: {\n      default: null,\n      type: cc.Label,\n    },\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    if(window.mapIns){\n      console.warn('+++++++ WechatLogin onLoad(), mapIns.counter:', window.mapIns.counter);\n    }else{\n      console.warn('+++++++ WechatLogin onLoad(), mapIns.counter:', 0);\n    }\n\n\n    //kobako: 腾讯统计代码\n    if(cc.sys.platform != cc.sys.WECHAT_GAME){\n      var mta = document.createElement(\"script\");\n      mta.src = \"//pingjs.qq.com/h5/stats.js?v2.0.4\";\n      mta.setAttribute(\"name\", \"MTAH5\");\n      mta.setAttribute(\"sid\", \"500674632\");\n      var s = document.getElementsByTagName(\"script\")[0];\n      s.parentNode.insertBefore(mta, s);\n    }\n\n    //window.atFirstLocationHref = window.location.href.split('#')[0];\n    const self = this;\n    self.getRetCodeList();\n    self.getRegexList();\n\n\n    cc.loader.loadRes(\"pbfiles/room_downsync_frame\", function(err, textAsset /* cc.TextAsset */ ) {\n      if (err) {\n        cc.error(err.message || err);\n        return;\n      }\n\n      self.showTips('登录中...');\n\n      self.checkIntAuthTokenExpire().then(\n        () => {\n          self.showTips('登录状态未过期, 自动登录中...');\n          const intAuthToken = JSON.parse(cc.sys.localStorage.getItem('selfPlayer')).intAuthToken;\n          self.useTokenLogin(intAuthToken);\n        },\n        () => { //调用wx.login然后请求登录\n\n          wx.authorize({\n            scope: \"scope.userInfo\",\n            success(){\n              self.showTips('授权成功, 登录中...');\n\n              wx.login({\n                success(res){\n                  console.log('wx login success, res:');\n                  console.log(res);\n                  const code = res.code;\n\n                  wx.getUserInfo({\n                    success(res){\n                      const userInfo = res.userInfo;\n                      console.log('Get user info ok:');\n                      console.log(userInfo);\n                      self.useWXCodeMiniGameLogin(code, userInfo);\n                    },\n                    fail(){\n                      cc.error('wx.getUserInfo失败');\n                    },\n                  })\n\n    \n                  //self.useWXCodeLogin(res.code);\n                },\n                fail(err){\n                  if (err) {\n                    cc.error('wx.login失败');\n                    cc.error(err.message || err);\n                  }\n                },\n              });\n            },\n            fail(){ //授权失败, 创建授权按钮\n              self.showTips('点击屏幕授权后登录');\n              console.error('授权失败, 创建授权按钮')\n              let sysInfo = wx.getSystemInfoSync();\n              //获取微信界面大小\n              let width = sysInfo.screenWidth;\n              let height = sysInfo.screenHeight;\n              let button = wx.createUserInfoButton({\n                type: 'text',\n                text: '',\n                style: {\n                    left: 0,\n                    top: 0,\n                    width: width,\n                    height: height,\n                    backgroundColor: '#00000000',//最后两位为透明度\n                    color: '#ffffff',\n                    fontSize: 20,\n                    textAlign: \"center\",\n                    lineHeight: height,\n                },\n              });\n              button.onTap((res) => {\n                console.log(res);\n                if(null != res.userInfo){\n                  const userInfo = res.userInfo;\n                  self.showTips('授权成功, 登录中...');\n\n                  wx.login({\n                    success(res){\n                      console.log('wx.login success, res:');\n                      console.log(res);\n                      const code = res.code;\n                      self.useWXCodeMiniGameLogin(code, userInfo);\n                      //完全登录成功后删除按钮\n                      button.destroy();\n                    },\n                    fail(err){\n                      if (err) {\n                        cc.error('wx.login失败');\n                        cc.error(err.message || err);\n                      }\n                    },\n                  });\n\n                }\n              })\n            }\n          })\n        }\n      );\n    });\n  },\n\n  onDestroy(){\n    if(window.mapIns){\n      console.warn('+++++++ WechatLogin onDestroy(), mapIns.counter:', window.mapIns.counter);\n    }else{\n      console.warn('+++++++ WechatLogin onDestroy(), mapIns.counter:', 0);\n    }\n  },\n\n  showTips(text){\n    if(this.tipsLabel != null){\n      this.tipsLabel.string = text;\n    }else{\n      console.log('Login scene showTips failed')\n    }\n  },\n\n  getRetCodeList() {\n    const self = this;\n    self.retCodeDict = constants.RET_CODE;\n  },\n\n  getRegexList() {\n    const self = this;\n    self.regexList = {\n      EMAIL: /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/,\n      PHONE: /^\\+?[0-9]{8,14}$/,\n      STREET_META: /^.{5,100}$/,\n      LNG_LAT_TEXT: /^[0-9]+(\\.[0-9]{4,6})$/,\n      SEO_KEYWORD: /^.{2,50}$/,\n      PASSWORD: /^.{6,50}$/,\n      SMS_CAPTCHA_CODE: /^[0-9]{4}$/,\n      ADMIN_HANDLE: /^.{4,50}$/,\n    };\n  },\n\n  onSMSCaptchaGetButtonClicked(evt) {\n    var timerEnable = true;\n    const self = this;\n    if (!self.checkPhoneNumber('getCaptcha')) {\n      return;\n    }\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.GET,\n      type: 'GET',\n      data: {\n        phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n        phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string\n      },\n      success: function(res) {\n        switch (res.ret) {\n          case self.retCodeDict.OK:\n            self.phoneNumberTips.getComponent(cc.Label).string = '';\n            self.captchaTips.getComponent(cc.Label).string = '';\n            break;\n          case self.retCodeDict.DUPLICATED:\n            self.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n            break;\n          case self.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n            break;\n          case self.retCodeDict.IS_TEST_ACC:\n            self.smsLoginCaptchaInput.getComponent(cc.EditBox).string = res.smsLoginCaptcha;\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.TEST_USER\");\n            timerEnable = false;\n            // clearInterval(self.countdownTimer);\n            break;\n          case self.retCodeDict.SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_FREEQUENT_REQUIRE\");\n          default:\n            break;\n        }\n        if (timerEnable)\n          self.countdownTime(self);\n      }\n    });\n  },\n\n  countdownTime(self) {\n    self.smsLoginCaptchaButton.off('click', self.onSMSCaptchaGetButtonClicked);\n    self.smsLoginCaptchaButton.removeChild(self.smsGetCaptchaNode);\n    self.smsWaitCountdownNode.parent = self.smsLoginCaptchaButton;\n    var total = 20; // Magic number\n    self.countdownTimer = setInterval(function() {\n      if (total === 0) {\n        self.smsWaitCountdownNode.parent.removeChild(self.smsWaitCountdownNode);\n        self.smsGetCaptchaNode.parent = self.smsLoginCaptchaButton;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = 20;\n        self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\n        clearInterval(self.countdownTimer);\n      } else {\n        total--;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = total;\n      }\n    }, 1000)\n\n  },\n\n  checkIntAuthTokenExpire() {\n    return new Promise((resolve, reject) => {\n      if (!cc.sys.localStorage.getItem('selfPlayer')) {\n        reject();\n        return;\n      }\n      const selfPlayer = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n      (selfPlayer.intAuthToken && new Date().getTime() < selfPlayer.expiresAt) ? resolve() : reject();\n    })\n  },\n\n  checkPhoneNumber(type) {\n    const self = this;\n    const phoneNumberRegexp = self.regexList.PHONE;\n    var phoneNumberString = self.phoneNumberInput.getComponent(cc.EditBox).string;\n    if (phoneNumberString) {\n      return true;\n      if (!phoneNumberRegexp.test(phoneNumberString)) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'getCaptcha' || type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n      }\n      return false;\n    }\n  },\n\n  checkCaptcha(type) {\n    const self = this;\n    const captchaRegexp = self.regexList.SMS_CAPTCHA_CODE;\n    var captchaString = self.smsLoginCaptchaInput.getComponent(cc.EditBox).string;\n\n    if (captchaString) {\n      if (self.smsLoginCaptchaInput.getComponent(cc.EditBox).string.length !== 4 || (!captchaRegexp.test(captchaString))) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n      }\n      return false;\n    }\n  },\n\n  useTokenLogin(_intAuthToken) {\n    var self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        intAuthToken: _intAuthToken\n      },\n      success: function(resp) {\n        self.onLoggedIn(resp);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"useTokenLogin\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\n      },\n      timeout: function() {\n        self.enableInteractiveControls(true);\n      },\n    });\n  },\n\n  enableInteractiveControls(enabled) {\n\n  },\n\n  onLoginButtonClicked(evt) {\n    const self = this;\n    if (!self.checkPhoneNumber('login') || !self.checkCaptcha('login')) {\n      return;\n    }\n    self.loginParams = {\n      phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n      phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string,\n      smsLoginCaptcha: self.smsLoginCaptchaInput.getComponent(cc.EditBox).string\n    };\n    self.enableInteractiveControls(false);\n\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: self.loginParams,\n      success: function(resp) {\n        self.onLoggedIn(resp);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\n      },\n      timeout: function() {\n        self.enableInteractiveControls(true);\n      }\n    });\n  },\n  onWechatLoggedIn(res) {\n    const self = this;\n    if (res.ret === self.retCodeDict.OK) {\n      //根据服务器返回信息设置selfPlayer\n      self.enableInteractiveControls(false);\n      const date = Number(res.expiresAt);\n      const selfPlayer = {\n        expiresAt: date,\n        playerId: res.playerId,\n        intAuthToken: res.intAuthToken,\n        displayName: res.displayName,\n        avatar: res.avatar,\n      }\n      cc.sys.localStorage.setItem('selfPlayer', JSON.stringify(selfPlayer));\n      \n      self.useTokenLogin(res.intAuthToken);\n    } else {\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorCode = \" + res.ret);\n    }\n  },\n\n  onLoggedIn(res) {\n    const self = this;\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\n    if (res.ret === self.retCodeDict.OK) {\n\n      if(window.isUsingX5BlinkKernelOrWebkitWeChatKernel()) {\n        window.initWxSdk = self.initWxSdk.bind(self);\n        window.initWxSdk();\n      }\n      self.enableInteractiveControls(false);\n      const date = Number(res.expiresAt);\n      const selfPlayer = {\n        expiresAt: date,\n        playerId: res.playerId,\n        intAuthToken: res.intAuthToken,\n        avatar: res.avatar,\n        displayName: res.displayName,\n        //kobako: 新增\n        name: res.name,\n      }\n      cc.sys.localStorage.setItem('selfPlayer', JSON.stringify(selfPlayer));\n      cc.log(`cc.sys.localStorage.selfPlayer = ${cc.sys.localStorage.getItem('selfPlayer')}`);\n      if (self.countdownTimer) {\n        clearInterval(self.countdownTimer);\n      }\n\n      cc.director.loadScene('default_map');\n    } else {\n      console.warn('onLoggedIn failed!')\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      self.enableInteractiveControls(true);\n      switch (res.ret) {\n        case self.retCodeDict.DUPLICATED:\n          this.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n          break;\n        case this.retCodeDict.TOKEN_EXPIRED:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.TOKEN_EXPIRED;\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_NOT_MATCH:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_CAPTCHA:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_CODE_NOT_EXISTING:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_NUMBER:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INVALID_REQUEST_PARAM:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.INCORRECT_PHONE_COUNTRY_CODE;\n          break;\n        default:\n          break;\n      }\n    }\n  },\n\n  useWXCodeLogin(_code) {\n    const self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        code: _code\n      },\n      success: function(res) {\n        self.onWechatLoggedIn(res);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        cc.sys.localStorage.removeItem(\"selfPlayer\");\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorMsg =\" + errMsg);\n        window.history.replaceState({}, null, window.location.pathname);\n      },\n    });\n  },\n\n  //对比useWxCodeLogin函数只是请求了不同url\n  useWXCodeMiniGameLogin(_code, _userInfo) {\n    const self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHATGAME + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        code: _code,\n        avatarUrl: _userInfo.avatarUrl,\n        nickName: _userInfo.nickName,\n      },\n      success: function(res) {\n        self.onWechatLoggedIn(res);\n      },\n      error: function(xhr, status, errMsg) {\n\n        //Mock page navigation\n        //self.mockWechatLoggedIn();\n\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        cc.sys.localStorage.removeItem(\"selfPlayer\");\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorMsg =\" + errMsg);\n        window.history.replaceState({}, null, window.location.pathname);\n      },\n    });\n  },\n\n  mockWechatLoggedIn(){\n    cc.director.loadScene('default_map');\n  },\n\n\n  getWechatCode(evt) {\n    let self = this;\n    self.showTips('');\n    const wechatServerEndpoint = wechatAddress.PROTOCOL + \"://\" + wechatAddress.HOST + ((null != wechatAddress.PORT && \"\" != wechatAddress.PORT.trim()) ? (\":\" + wechatAddress.PORT) : \"\");\n    const url = wechatServerEndpoint + constants.WECHAT.AUTHORIZE_PATH + \"?\" + wechatAddress.APPID_LITERAL + \"&\" + constants.WECHAT.REDIRECT_RUI_KEY + NetworkUtils.encode(window.location.href) + \"&\" + constants.WECHAT.RESPONSE_TYPE + \"&\" + constants.WECHAT.SCOPE + constants.WECHAT.FIN;\n    console.log(\"To visit wechat auth addr: \" + url);\n    window.location.href = url;\n  },\n\n  initWxSdk() {\n    const selfPlayer = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n    const origUrl = window.location.protocol + \"//\" + window.location.host + window.location.pathname;\n    /*\n    * The `shareLink` must \n    * - have its 2nd-order-domain registered as trusted 2nd-order under the targetd `res.jsConfig.app_id`, and\n    * - extracted from current window.location.href.   \n    */\n    const shareLink = origUrl;\n    const updateAppMsgShareDataObj = {\n      type: 'link', // 分享类型,music、video或link，不填默认为link\n      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空\n      title: document.title, // 分享标题\n      desc: 'Let\\'s play together!', // 分享描述\n      link: shareLink + (cc.sys.localStorage.getItem('boundRoomId') ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.getItem('boundRoomId'))),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {\n        // 设置成功\n      }\n    };\n    const menuShareTimelineObj = {\n      title: document.title, // 分享标题\n      link: shareLink + (cc.sys.localStorage.getItem('boundRoomId') ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.getItem('boundRoomId'))),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {}\n    };\n\n    const wxConfigUrl = (window.isUsingWebkitWechatKernel() ? window.atFirstLocationHref : window.location.href); \n    //接入微信登录接口\n    NetworkUtils.ajax({\n      \"url\": backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.JSCONFIG,\n      type: \"POST\",\n      data: {\n        \"url\": wxConfigUrl,\n        \"intAuthToken\": selfPlayer.intAuthToken,\n      },\n      success: function(res) {\n        if (constants.RET_CODE.OK != res.ret) {\n          console.log(\"cannot get the wsConfig. retCode == \" + res.ret);\n          return;\n        }\n        const jsConfig = res.jsConfig;\n        console.log(updateAppMsgShareDataObj);\n        const configData = {\n          debug: CC_DEBUG, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\n          appId: jsConfig.app_id, // 必填，公众号的唯一标识\n          timestamp: jsConfig.timestamp.toString(), // 必填，生成签名的时间戳\n          nonceStr: jsConfig.nonce_str, // 必填，生成签名的随机串\n          jsApiList: ['onMenuShareAppMessage', 'onMenuShareTimeline'],\n          signature: jsConfig.signature, // 必填，签名\n        };\n        console.log(\"config url: \" + wxConfigUrl);\n        console.log(\"wx.config: \");\n        console.log(configData);\n        wx.config(configData);\n        console.log(\"Current window.location.href: \" + window.location.href);\n        wx.ready(function() {\n          console.log(\"Here is wx.ready.\")\n          wx.onMenuShareAppMessage(updateAppMsgShareDataObj);\n          wx.onMenuShareTimeline(menuShareTimelineObj);\n        });\n        wx.error(function(res) {\n          console.error(\"wx config fails and error is \" + JSON.stringify(res));\n        });\n      },\n      error: function(xhr, status, errMsg) {\n        console.log(\"cannot get the wsConfig. errMsg == \" + errMsg);\n      },\n    });\n  },\n});\n"]}