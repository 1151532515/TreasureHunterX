{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\WechatGameLogin.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","cavasNode","default","type","Node","backgroundNode","loadingPrefab","Prefab","tipsLabel","Label","onLoad","wx","onShow","res","log","mapIns","counter","onHide","mode","closeWSConnection","self","getRetCodeList","getRegexList","loader","loadRes","err","textAsset","error","message","showTips","checkIntAuthTokenExpire","then","intAuthToken","JSON","parse","sys","localStorage","getItem","useTokenLogin","authorize","scope","success","login","console","code","getUserInfo","userInfo","useWXCodeMiniGameLogin","fail","sysInfo","getSystemInfoSync","width","screenWidth","height","screenHeight","button","createUserInfoButton","text","style","left","top","backgroundColor","color","fontSize","textAlign","lineHeight","onTap","destroy","onDestroy","string","retCodeDict","constants","RET_CODE","regexList","EMAIL","PHONE","STREET_META","LNG_LAT_TEXT","SEO_KEYWORD","PASSWORD","SMS_CAPTCHA_CODE","ADMIN_HANDLE","onSMSCaptchaGetButtonClicked","evt","timerEnable","checkPhoneNumber","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","SMS_CAPTCHA","GET","data","phoneCountryCode","phoneCountryCodeInput","getComponent","EditBox","phoneNum","phoneNumberInput","ret","OK","phoneNumberTips","captchaTips","DUPLICATED","ALERT","TIP_LABEL","LOG_OUT","INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER","t","IS_TEST_ACC","smsLoginCaptchaInput","smsLoginCaptcha","SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY","countdownTime","smsLoginCaptchaButton","off","removeChild","smsGetCaptchaNode","smsWaitCountdownNode","parent","total","countdownTimer","setInterval","getChildByName","on","clearInterval","Promise","resolve","reject","selfPlayer","Date","getTime","expiresAt","phoneNumberRegexp","phoneNumberString","test","checkCaptcha","captchaRegexp","captchaString","length","_intAuthToken","INT_AUTH_TOKEN","LOGIN","resp","onLoggedIn","xhr","status","errMsg","clearBoundRoomIdInBothVolatileAndPersistentStorage","director","loadScene","timeout","enableInteractiveControls","enabled","onLoginButtonClicked","loginParams","onWechatLoggedIn","date","Number","playerId","displayName","avatar","setItem","stringify","removeItem","WECHAT_LOGIN_FAILS","isUsingX5BlinkKernelOrWebkitWeChatKernel","initWxSdk","bind","name","warn","TOKEN_EXPIRED","SMS_CAPTCHA_NOT_MATCH","INCORRECT_CAPTCHA","SMS_CAPTCHA_CODE_NOT_EXISTING","INCORRECT_PHONE_NUMBER","INVALID_REQUEST_PARAM","INCORRECT_PHONE_COUNTRY_CODE","useWXCodeLogin","_code","WECHAT","history","replaceState","location","pathname","_userInfo","WECHATGAME","avatarUrl","nickName","mockWechatLoggedIn","getWechatCode","wechatServerEndpoint","wechatAddress","trim","AUTHORIZE_PATH","APPID_LITERAL","REDIRECT_RUI_KEY","encode","href","RESPONSE_TYPE","SCOPE","FIN","origUrl","protocol","host","shareLink","updateAppMsgShareDataObj","dataUrl","title","document","desc","link","imgUrl","menuShareTimelineObj","wxConfigUrl","isUsingWebkitWechatKernel","atFirstLocationHref","JSCONFIG","jsConfig","configData","debug","CC_DEBUG","appId","app_id","timestamp","toString","nonceStr","nonce_str","jsApiList","signature","config","ready","onMenuShareAppMessage","onMenuShareTimeline"],"mappings":"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","file":"WechatGameLogin.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    cavasNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    backgroundNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    loadingPrefab: {\r\n      default: null,\r\n      type: cc.Prefab\r\n    },\r\n    tipsLabel: {\r\n      default: null,\r\n      type: cc.Label,\r\n    },\r\n  },\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n\r\n  onLoad() {\r\n\r\n    wx.onShow((res) => { \r\n      cc.log(`+++++ wx onShow(), mapIns.counter: ${window.mapIns.counter}`);\r\n    });\r\n\r\n    wx.onHide((res) => {\r\n      cc.log(`+++++ wx onHide(), mapIns.counter: ${window.mapIns.counter}, onHide.res: ${res}`);\r\n      if ('close' == res.mode) { \r\n        window.closeWSConnection();\r\n      } else { \r\n        // Deliberately left blank.\r\n      }\r\n    });\r\n\r\n    const self = this;\r\n    self.getRetCodeList();\r\n    self.getRegexList();\r\n\r\n    cc.loader.loadRes(\"pbfiles/room_downsync_frame\", function(err, textAsset /* cc.TextAsset */ ) {\r\n      if (err) {\r\n        cc.error(err.message || err);\r\n        return;\r\n      }\r\n\r\n      self.showTips(\"自动登录中\");\r\n      self.checkIntAuthTokenExpire().then(\r\n        () => {\r\n          self.showTips(\"自动登录中...\");\r\n          const intAuthToken = JSON.parse(cc.sys.localStorage.getItem('selfPlayer')).intAuthToken;\r\n          self.useTokenLogin(intAuthToken);\r\n        },\r\n        () => { \r\n          // 调用wx.login然后请求登录。\r\n          wx.authorize({\r\n            scope: \"scope.userInfo\",\r\n            success() {\r\n              self.showTips(\"授权成功, 登录中...\");\r\n              wx.login({\r\n                success(res) {\r\n                  console.log('wx login success, res:');\r\n                  console.log(res);\r\n                  const code = res.code;\r\n\r\n                  wx.getUserInfo({\r\n                    success(res) {\r\n                      const userInfo = res.userInfo;\r\n                      console.log('Get user info ok:');\r\n                      console.log(userInfo);\r\n                      self.useWXCodeMiniGameLogin(code, userInfo);\r\n                    },\r\n                    fail() {\r\n                      cc.error('wx.getUserInfo失败');\r\n                    },\r\n                  })\r\n\r\n\r\n                //self.useWXCodeLogin(res.code);\r\n                },\r\n                fail(err) {\r\n                  if (err) {\r\n                    cc.error('wx.login失败');\r\n                    cc.error(err.message || err);\r\n                  }\r\n                },\r\n              });\r\n            },\r\n            fail() { //授权失败, 创建授权按钮\r\n              self.showTips('点击屏幕授权后登录');\r\n              console.error('授权失败, 创建授权按钮')\r\n              let sysInfo = wx.getSystemInfoSync();\r\n              //获取微信界面大小\r\n              let width = sysInfo.screenWidth;\r\n              let height = sysInfo.screenHeight;\r\n              let button = wx.createUserInfoButton({\r\n                type: 'text',\r\n                text: '',\r\n                style: {\r\n                  left: 0,\r\n                  top: 0,\r\n                  width: width,\r\n                  height: height,\r\n                  backgroundColor: '#00000000', //最后两位为透明度\r\n                  color: '#ffffff',\r\n                  fontSize: 20,\r\n                  textAlign: \"center\",\r\n                  lineHeight: height,\r\n                },\r\n              });\r\n              button.onTap((res) => {\r\n                console.log(res);\r\n                if (null != res.userInfo) {\r\n                  const userInfo = res.userInfo;\r\n                  self.showTips('授权成功, 登录中...');\r\n\r\n                  wx.login({\r\n                    success(res) {\r\n                      console.log('wx.login success, res:');\r\n                      console.log(res);\r\n                      const code = res.code;\r\n                      self.useWXCodeMiniGameLogin(code, userInfo);\r\n                      //完全登录成功后删除按钮\r\n                      button.destroy();\r\n                    },\r\n                    fail(err) {\r\n                      if (err) {\r\n                        cc.error('wx.login失败');\r\n                        cc.error(err.message || err);\r\n                      }\r\n                    },\r\n                  });\r\n\r\n                }\r\n              })\r\n            }\r\n          })\r\n        }\r\n      );\r\n    });\r\n  },\r\n\r\n  onDestroy() {\r\n    if (window.mapIns) {\r\n      cc.log(`+++++++ WechatGameLogin onDestroy(), mapIns.counter: ${window.mapIns.counter}`);\r\n    } else {\r\n      cc.log(`+++++++ WechatGameLogin onDestroy(), mapIns.counter: 0`);\r\n    }\r\n  },\r\n\r\n  showTips(text) {\r\n    if (this.tipsLabel != null) {\r\n      this.tipsLabel.string = text;\r\n    } else {\r\n      cc.log('Login scene showTips failed')\r\n    }\r\n  },\r\n\r\n  getRetCodeList() {\r\n    const self = this;\r\n    self.retCodeDict = constants.RET_CODE;\r\n  },\r\n\r\n  getRegexList() {\r\n    const self = this;\r\n    self.regexList = {\r\n      EMAIL: /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/,\r\n      PHONE: /^\\+?[0-9]{8,14}$/,\r\n      STREET_META: /^.{5,100}$/,\r\n      LNG_LAT_TEXT: /^[0-9]+(\\.[0-9]{4,6})$/,\r\n      SEO_KEYWORD: /^.{2,50}$/,\r\n      PASSWORD: /^.{6,50}$/,\r\n      SMS_CAPTCHA_CODE: /^[0-9]{4}$/,\r\n      ADMIN_HANDLE: /^.{4,50}$/,\r\n    };\r\n  },\r\n\r\n  onSMSCaptchaGetButtonClicked(evt) {\r\n    var timerEnable = true;\r\n    const self = this;\r\n    if (!self.checkPhoneNumber('getCaptcha')) {\r\n      return;\r\n    }\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\r\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.GET,\r\n      type: 'GET',\r\n      data: {\r\n        phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\r\n        phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string\r\n      },\r\n      success: function(res) {\r\n        switch (res.ret) {\r\n          case self.retCodeDict.OK:\r\n            self.phoneNumberTips.getComponent(cc.Label).string = '';\r\n            self.captchaTips.getComponent(cc.Label).string = '';\r\n            break;\r\n          case self.retCodeDict.DUPLICATED:\r\n            self.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\r\n            break;\r\n          case self.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER:\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n            break;\r\n          case self.retCodeDict.IS_TEST_ACC:\r\n            self.smsLoginCaptchaInput.getComponent(cc.EditBox).string = res.smsLoginCaptcha;\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.TEST_USER\");\r\n            timerEnable = false;\r\n            // clearInterval(self.countdownTimer);\r\n            break;\r\n          case self.retCodeDict.SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY:\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_FREEQUENT_REQUIRE\");\r\n          default:\r\n            break;\r\n        }\r\n        if (timerEnable)\r\n          self.countdownTime(self);\r\n      }\r\n    });\r\n  },\r\n\r\n  countdownTime(self) {\r\n    self.smsLoginCaptchaButton.off('click', self.onSMSCaptchaGetButtonClicked);\r\n    self.smsLoginCaptchaButton.removeChild(self.smsGetCaptchaNode);\r\n    self.smsWaitCountdownNode.parent = self.smsLoginCaptchaButton;\r\n    var total = 20; // Magic number\r\n    self.countdownTimer = setInterval(function() {\r\n      if (total === 0) {\r\n        self.smsWaitCountdownNode.parent.removeChild(self.smsWaitCountdownNode);\r\n        self.smsGetCaptchaNode.parent = self.smsLoginCaptchaButton;\r\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = 20;\r\n        self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\r\n        clearInterval(self.countdownTimer);\r\n      } else {\r\n        total--;\r\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = total;\r\n      }\r\n    }, 1000)\r\n\r\n  },\r\n\r\n  checkIntAuthTokenExpire() {\r\n    return new Promise((resolve, reject) => {\r\n      if (!cc.sys.localStorage.getItem('selfPlayer')) {\r\n        reject();\r\n        return;\r\n      }\r\n      const selfPlayer = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n      (selfPlayer.intAuthToken && new Date().getTime() < selfPlayer.expiresAt) ? resolve() : reject();\r\n    })\r\n  },\r\n\r\n  checkPhoneNumber(type) {\r\n    const self = this;\r\n    const phoneNumberRegexp = self.regexList.PHONE;\r\n    var phoneNumberString = self.phoneNumberInput.getComponent(cc.EditBox).string;\r\n    if (phoneNumberString) {\r\n      return true;\r\n      if (!phoneNumberRegexp.test(phoneNumberString)) {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n        return false;\r\n      } else {\r\n        return true;\r\n      }\r\n    } else {\r\n      if (type === 'getCaptcha' || type === 'login') {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n      }\r\n      return false;\r\n    }\r\n  },\r\n\r\n  checkCaptcha(type) {\r\n    const self = this;\r\n    const captchaRegexp = self.regexList.SMS_CAPTCHA_CODE;\r\n    var captchaString = self.smsLoginCaptchaInput.getComponent(cc.EditBox).string;\r\n\r\n    if (captchaString) {\r\n      if (self.smsLoginCaptchaInput.getComponent(cc.EditBox).string.length !== 4 || (!captchaRegexp.test(captchaString))) {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\r\n        return false;\r\n      } else {\r\n        return true;\r\n      }\r\n    } else {\r\n      if (type === 'login') {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\r\n      }\r\n      return false;\r\n    }\r\n  },\r\n\r\n  useTokenLogin(_intAuthToken) {\r\n    var self = this;\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: {\r\n        intAuthToken: _intAuthToken\r\n      },\r\n      success: function(resp) {\r\n        self.onLoggedIn(resp);\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        cc.log(`Login attempt \"useTokenLogin\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\r\n        cc.director.loadScene('wechatGameLogin');\r\n      },\r\n      timeout: function() {\r\n        self.enableInteractiveControls(true);\r\n      },\r\n    });\r\n  },\r\n\r\n  enableInteractiveControls(enabled) {},\r\n\r\n  onLoginButtonClicked(evt) {\r\n    const self = this;\r\n    if (!self.checkPhoneNumber('login') || !self.checkCaptcha('login')) {\r\n      return;\r\n    }\r\n    self.loginParams = {\r\n      phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\r\n      phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string,\r\n      smsLoginCaptcha: self.smsLoginCaptchaInput.getComponent(cc.EditBox).string\r\n    };\r\n    self.enableInteractiveControls(false);\r\n\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\r\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: self.loginParams,\r\n      success: function(resp) {\r\n        self.onLoggedIn(resp);\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\r\n      },\r\n      timeout: function() {\r\n        self.enableInteractiveControls(true);\r\n      }\r\n    });\r\n  },\r\n  onWechatLoggedIn(res) {\r\n    const self = this;\r\n    if (res.ret === self.retCodeDict.OK) {\r\n      //根据服务器返回信息设置selfPlayer\r\n      self.enableInteractiveControls(false);\r\n      const date = Number(res.expiresAt);\r\n      const selfPlayer = {\r\n        expiresAt: date,\r\n        playerId: res.playerId,\r\n        intAuthToken: res.intAuthToken,\r\n        displayName: res.displayName,\r\n        avatar: res.avatar,\r\n      }\r\n      cc.sys.localStorage.setItem('selfPlayer', JSON.stringify(selfPlayer));\r\n\r\n      self.useTokenLogin(res.intAuthToken);\r\n    } else {\r\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorCode = \" + res.ret);\r\n    }\r\n  },\r\n\r\n  onLoggedIn(res) {\r\n    const self = this;\r\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\r\n    if (res.ret === self.retCodeDict.OK) {\r\n\r\n      if (window.isUsingX5BlinkKernelOrWebkitWeChatKernel()) {\r\n        window.initWxSdk = self.initWxSdk.bind(self);\r\n        window.initWxSdk();\r\n      }\r\n      self.enableInteractiveControls(false);\r\n      const date = Number(res.expiresAt);\r\n      const selfPlayer = {\r\n        expiresAt: date,\r\n        playerId: res.playerId,\r\n        intAuthToken: res.intAuthToken,\r\n        avatar: res.avatar,\r\n        displayName: res.displayName,\r\n        name: res.name,\r\n      }\r\n      cc.sys.localStorage.setItem('selfPlayer', JSON.stringify(selfPlayer));\r\n      cc.log(`cc.sys.localStorage.selfPlayer = ${cc.sys.localStorage.getItem('selfPlayer')}`);\r\n      if (self.countdownTimer) {\r\n        clearInterval(self.countdownTimer);\r\n      }\r\n\r\n      cc.director.loadScene('default_map');\r\n    } else {\r\n      cc.warn('onLoggedIn failed!')\r\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      self.enableInteractiveControls(true);\r\n      switch (res.ret) {\r\n        case self.retCodeDict.DUPLICATED:\r\n          this.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\r\n          break;\r\n        case this.retCodeDict.TOKEN_EXPIRED:\r\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.TOKEN_EXPIRED;\r\n          break;\r\n        case this.retCodeDict.SMS_CAPTCHA_NOT_MATCH:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_CAPTCHA:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.SMS_CAPTCHA_CODE_NOT_EXISTING:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_PHONE_NUMBER:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\r\n          break;\r\n        case this.retCodeDict.INVALID_REQUEST_PARAM:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE:\r\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.INCORRECT_PHONE_COUNTRY_CODE;\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n\r\n      cc.director.loadScene('wechatGameLogin');\r\n    }\r\n  },\r\n\r\n  useWXCodeLogin(_code) {\r\n    const self = this;\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: {\r\n        code: _code\r\n      },\r\n      success: function(res) {\r\n        self.onWechatLoggedIn(res);\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        cc.sys.localStorage.removeItem(\"selfPlayer\");\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n        self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorMsg =\" + errMsg);\r\n        window.history.replaceState({}, null, window.location.pathname);\r\n      },\r\n    });\r\n  },\r\n\r\n  //对比useWxCodeLogin函数只是请求了不同url\r\n  useWXCodeMiniGameLogin(_code, _userInfo) {\r\n    const self = this;\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHATGAME + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: {\r\n        code: _code,\r\n        avatarUrl: _userInfo.avatarUrl,\r\n        nickName: _userInfo.nickName,\r\n      },\r\n      success: function(res) {\r\n        self.onWechatLoggedIn(res);\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n\r\n        //Mock page navigation\r\n        //self.mockWechatLoggedIn();\r\n\r\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        cc.sys.localStorage.removeItem(\"selfPlayer\");\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n        self.showTips(constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorMsg =\" + errMsg);\r\n        window.history.replaceState({}, null, window.location.pathname);\r\n      },\r\n    });\r\n  },\r\n\r\n  mockWechatLoggedIn() {\r\n    cc.director.loadScene('default_map');\r\n  },\r\n\r\n\r\n  getWechatCode(evt) {\r\n    let self = this;\r\n    self.showTips(\"\");\r\n    const wechatServerEndpoint = wechatAddress.PROTOCOL + \"://\" + wechatAddress.HOST + ((null != wechatAddress.PORT && \"\" != wechatAddress.PORT.trim()) ? (\":\" + wechatAddress.PORT) : \"\");\r\n    const url = wechatServerEndpoint + constants.WECHAT.AUTHORIZE_PATH + \"?\" + wechatAddress.APPID_LITERAL + \"&\" + constants.WECHAT.REDIRECT_RUI_KEY + NetworkUtils.encode(window.location.href) + \"&\" + constants.WECHAT.RESPONSE_TYPE + \"&\" + constants.WECHAT.SCOPE + constants.WECHAT.FIN;\r\n    console.log(\"To visit wechat auth addr: \" + url);\r\n    window.location.href = url;\r\n  },\r\n\r\n  initWxSdk() {\r\n    const selfPlayer = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n    const origUrl = window.location.protocol + \"//\" + window.location.host + window.location.pathname;\r\n    /*\r\n    * The `shareLink` must \r\n    * - have its 2nd-order-domain registered as trusted 2nd-order under the targetd `res.jsConfig.app_id`, and\r\n    * - extracted from current window.location.href.   \r\n    */\r\n    const shareLink = origUrl;\r\n    const updateAppMsgShareDataObj = {\r\n      type: 'link', // 分享类型,music、video或link，不填默认为link\r\n      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空\r\n      title: document.title, // 分享标题\r\n      desc: 'Let\\'s play together!', // 分享描述\r\n      link: shareLink + (cc.sys.localStorage.getItem('boundRoomId') ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.getItem('boundRoomId'))),\r\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\r\n      success: function() {\r\n        // 设置成功\r\n      }\r\n    };\r\n    const menuShareTimelineObj = {\r\n      title: document.title, // 分享标题\r\n      link: shareLink + (cc.sys.localStorage.getItem('boundRoomId') ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.getItem('boundRoomId'))),\r\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\r\n      success: function() {}\r\n    };\r\n\r\n    const wxConfigUrl = (window.isUsingWebkitWechatKernel() ? window.atFirstLocationHref : window.location.href);\r\n    //接入微信登录接口\r\n    NetworkUtils.ajax({\r\n      \"url\": backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.JSCONFIG,\r\n      type: \"POST\",\r\n      data: {\r\n        \"url\": wxConfigUrl,\r\n        \"intAuthToken\": selfPlayer.intAuthToken,\r\n      },\r\n      success: function(res) {\r\n        if (constants.RET_CODE.OK != res.ret) {\r\n          console.log(\"cannot get the wsConfig. retCode == \" + res.ret);\r\n          return;\r\n        }\r\n        const jsConfig = res.jsConfig;\r\n        console.log(updateAppMsgShareDataObj);\r\n        const configData = {\r\n          debug: CC_DEBUG, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\r\n          appId: jsConfig.app_id, // 必填，公众号的唯一标识\r\n          timestamp: jsConfig.timestamp.toString(), // 必填，生成签名的时间戳\r\n          nonceStr: jsConfig.nonce_str, // 必填，生成签名的随机串\r\n          jsApiList: ['onMenuShareAppMessage', 'onMenuShareTimeline'],\r\n          signature: jsConfig.signature, // 必填，签名\r\n        };\r\n        console.log(\"config url: \" + wxConfigUrl);\r\n        console.log(\"wx.config: \");\r\n        console.log(configData);\r\n        wx.config(configData);\r\n        console.log(\"Current window.location.href: \" + window.location.href);\r\n        wx.ready(function() {\r\n          console.log(\"Here is wx.ready.\")\r\n          wx.onMenuShareAppMessage(updateAppMsgShareDataObj);\r\n          wx.onMenuShareTimeline(menuShareTimelineObj);\r\n        });\r\n        wx.error(function(res) {\r\n          console.error(\"wx config fails and error is \" + JSON.stringify(res));\r\n        });\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        console.log(\"cannot get the wsConfig. errMsg == \" + errMsg);\r\n      },\r\n    });\r\n  },\r\n});\r\n"]}