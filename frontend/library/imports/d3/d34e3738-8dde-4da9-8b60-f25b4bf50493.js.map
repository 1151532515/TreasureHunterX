{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\TouchEventsManager.js"],"names":["cc","Class","extends","Component","properties","translationListenerNode","default","type","Node","zoomingListenerNode","stickhead","base","joyStickEps","Float","magicLeanLowerBound","magicLeanUpperBound","pollerFps","Integer","linearScaleFacBase","minScale","maxScale","maxMovingBufferLength","zoomingScaleFacBase","zoomingSpeedBase","linearSpeedBase","canvasNode","mapNode","linearMovingEps","scaleByEps","start","onLoad","cachedStickHeadPosition","v2","activeDirection","dx","dy","maxHeadDistance","width","_initTouchEvent","_cachedMapNodePosTarget","_cachedZoomRawTarget","mapScriptIns","getComponent","initialized","_startMainLoop","onDestroy","clearInterval","mainLoopTimer","self","zoomingSpeed","setInterval","_inputControlEnabled","length","shift","getNumberOfRunningActions","nextMapNodePosTarget","linearSpeed","finalDiffVec","pos","sub","position","finalDiffVecMag","mag","durationSeconds","log","bufferedTargetPos","x","y","runAction","sequence","moveTo","callFunc","_isMapOverMoved","setPosition","processed","setScale","scale","on","EventType","TOUCH_START","event","_touchStartEvent","TOUCH_MOVE","_translationEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","inTouchPoints","Map","_zoomingEvent","mapTargetPos","virtualPlayerPos","tileCollisionManager","isOutOfMapNode","theListenerNode","target","_touches","touch","set","_id","ALL_MAP_STATES","VISUAL","state","size","has","currentTouch","diffVec","_point","_startPoint","distance","overMoved","ratio","mul","firstTouch","secondTouch","startMagnitude","currentMagnitude","scaleBy","Math","abs","mainCamera","targetScale","zoomRatio","mainCameraNode","children","child","diffVecMag","delete","_touchCancelEvent","update","dt","inMultiTouch","eps","cachedStickHeadPositionMag","normalizedDir","discretizeDirection","continuousDx","continuousDy","ret","criticalRatio"],"mappings":"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","file":"TouchEventsManager.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["\r\ncc.Class({\r\n  extends: cc.Component,\r\n  properties: {\r\n    // For joystick begins.\r\n    translationListenerNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    zoomingListenerNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    stickhead: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    base: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    joyStickEps: {\r\n      default: 0.10,\r\n      type: cc.Float\r\n    },\r\n    magicLeanLowerBound: {\r\n      default: 0.414, // Tangent of (PI/8).\r\n      type: cc.Float\r\n    },\r\n    magicLeanUpperBound: {\r\n      default: 2.414, // Tangent of (3*PI/8).\r\n      type: cc.Float\r\n    },\r\n    // For joystick ends.\r\n    pollerFps: {\r\n      default: 10,\r\n      type: cc.Integer\r\n    },\r\n    linearScaleFacBase: {\r\n      default: 1.00,\r\n      type: cc.Float\r\n    },\r\n    minScale: {\r\n      default: 1.00,\r\n      type: cc.Float\r\n    },\r\n    maxScale: {\r\n      default: 2.50,\r\n      type: cc.Float\r\n    },\r\n    maxMovingBufferLength: {\r\n      default: 1,\r\n      type: cc.Integer\r\n    },\r\n    zoomingScaleFacBase: {\r\n      default: 0.10,\r\n      type: cc.Float\r\n    },\r\n    zoomingSpeedBase: {\r\n      default: 4.0,\r\n      type: cc.Float\r\n    },\r\n    linearSpeedBase: {\r\n      default: 320.0,\r\n      type: cc.Float\r\n    },\r\n    canvasNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    mapNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    linearMovingEps: {\r\n      default: 0.10,\r\n      type: cc.Float\r\n    },\r\n    scaleByEps: {\r\n      default: 0.0375,\r\n      type: cc.Float\r\n    },\r\n  },\r\n\r\n  start() {},\r\n\r\n  onLoad() {\r\n    this.cachedStickHeadPosition = cc.v2(0.0, 0.0);\r\n    this.activeDirection = {\r\n      dx: 0.0,\r\n      dy: 0.0\r\n    };\r\n    this.maxHeadDistance = (0.5 * this.base.width);\r\n\r\n    this._initTouchEvent();\r\n    this._cachedMapNodePosTarget = [];\r\n    this._cachedZoomRawTarget = null;\r\n\r\n    this.mapScriptIns = this.mapNode.getComponent(\"Map\");\r\n    this.initialized = true;\r\n\r\n    this._startMainLoop();\r\n  },\r\n\r\n  onDestroy() {\r\n    clearInterval(this.mainLoopTimer); \r\n  },\r\n\r\n  _startMainLoop() {\r\n    const self = this;\r\n    const linearSpeedBase = self.linearSpeedBase;\r\n    const zoomingSpeed = self.zoomingSpeedBase;\r\n\r\n    self.mainLoopTimer = setInterval(() => {\r\n      if (false == self.mapScriptIns._inputControlEnabled) return;\r\n      if (null != self._cachedMapNodePosTarget) {\r\n        while (self.maxMovingBufferLength < self._cachedMapNodePosTarget.length) {\r\n          self._cachedMapNodePosTarget.shift();\r\n        }\r\n        if (0 < self._cachedMapNodePosTarget.length && 0 == self.mapNode.getNumberOfRunningActions()) {\r\n          const nextMapNodePosTarget = self._cachedMapNodePosTarget.shift();\r\n          const linearSpeed = linearSpeedBase;\r\n          const finalDiffVec = nextMapNodePosTarget.pos.sub(self.mapNode.position);\r\n          const finalDiffVecMag = finalDiffVec.mag();\r\n          if (self.linearMovingEps > finalDiffVecMag) {\r\n            // Jittering.\r\n            // cc.log(\"Map node moving by finalDiffVecMag == %s is just jittering.\", finalDiffVecMag);\r\n            return;\r\n          }\r\n          const durationSeconds = finalDiffVecMag / linearSpeed;\r\n          cc.log(\"Map node moving to %o in %s/%s == %s seconds.\", nextMapNodePosTarget.pos, finalDiffVecMag, linearSpeed, durationSeconds);\r\n          const bufferedTargetPos = cc.v2(nextMapNodePosTarget.pos.x, nextMapNodePosTarget.pos.y);\r\n          self.mapNode.runAction(cc.sequence(\r\n            cc.moveTo(durationSeconds, bufferedTargetPos),\r\n            cc.callFunc(() => {\r\n              if (self._isMapOverMoved(self.mapNode.position)) {\r\n                self.mapNode.setPosition(bufferedTargetPos);\r\n              }\r\n            }, self)\r\n          ));\r\n        }\r\n      }\r\n      if (null != self._cachedZoomRawTarget && false == self._cachedZoomRawTarget.processed) {\r\n        cc.log(`Processing self._cachedZoomRawTarget == ${self._cachedZoomRawTarget}`);\r\n        self._cachedZoomRawTarget.processed = true;\r\n        self.mapNode.setScale(self._cachedZoomRawTarget.scale);\r\n      }\r\n    }, 1000 / self.pollerFps);\r\n  },\r\n\r\n  _initTouchEvent() {\r\n    const self = this;\r\n    const translationListenerNode = (self.translationListenerNode ? self.translationListenerNode : self.mapNode);  \r\n    const zoomingListenerNode = (self.zoomingListenerNode ? self.zoomingListenerNode : self.mapNode); \r\n\r\n    translationListenerNode.on(cc.Node.EventType.TOUCH_START, function(event) {\r\n      self._touchStartEvent(event);\r\n    });\r\n    translationListenerNode.on(cc.Node.EventType.TOUCH_MOVE, function(event) {\r\n      self._translationEvent(event);\r\n    });\r\n    translationListenerNode.on(cc.Node.EventType.TOUCH_END, function(event) {\r\n      self._touchEndEvent(event);\r\n    });\r\n    translationListenerNode.on(cc.Node.EventType.TOUCH_CANCEL, function(event) {\r\n      self._touchEndEvent(event);\r\n    });\r\n    translationListenerNode.inTouchPoints = new Map(); \r\n\r\n    zoomingListenerNode.on(cc.Node.EventType.TOUCH_START, function(event) {\r\n      self._touchStartEvent(event);\r\n    });\r\n    zoomingListenerNode.on(cc.Node.EventType.TOUCH_MOVE, function(event) {\r\n      self._zoomingEvent(event);\r\n    });\r\n    zoomingListenerNode.on(cc.Node.EventType.TOUCH_END, function(event) {\r\n      self._touchEndEvent(event);\r\n    });\r\n    zoomingListenerNode.on(cc.Node.EventType.TOUCH_CANCEL, function(event) {\r\n      self._touchEndEvent(event);\r\n    });\r\n    zoomingListenerNode.inTouchPoints = new Map(); \r\n  },\r\n\r\n  _isMapOverMoved(mapTargetPos) {\r\n    const virtualPlayerPos = cc.v2(-mapTargetPos.x, -mapTargetPos.y);\r\n    return tileCollisionManager.isOutOfMapNode(this.mapNode, virtualPlayerPos);\r\n  },\r\n\r\n  _touchStartEvent(event) {\r\n    const theListenerNode = event.target; \r\n    for (let touch of event._touches) {\r\n      theListenerNode.inTouchPoints.set(touch._id, touch);\r\n    }\r\n  },\r\n\r\n  _translationEvent(event) {\r\n    if (ALL_MAP_STATES.VISUAL != this.mapScriptIns.state) {\r\n      return;\r\n    }\r\n    const theListenerNode = event.target; \r\n    const linearScaleFacBase = this.linearScaleFacBase; // Not used yet.\r\n    if (1 != theListenerNode.inTouchPoints.size) {\r\n      return;\r\n    }\r\n    if (!theListenerNode.inTouchPoints.has(event.currentTouch._id))  {\r\n      return;\r\n    }\r\n    const diffVec = event.currentTouch._point.sub(event.currentTouch._startPoint);\r\n    const distance = diffVec.mag();\r\n    const overMoved = (distance > this.maxHeadDistance);\r\n    if (overMoved) {\r\n      const ratio = (this.maxHeadDistance / distance);\r\n      this.cachedStickHeadPosition = diffVec.mul(ratio);\r\n    } else {\r\n      const ratio = (distance / this.maxHeadDistance);\r\n      this.cachedStickHeadPosition = diffVec.mul(ratio);\r\n    }\r\n  },\r\n\r\n  _zoomingEvent(event) {\r\n    if (ALL_MAP_STATES.VISUAL != this.mapScriptIns.state) {\r\n      return;\r\n    }\r\n    const theListenerNode = event.target; \r\n    if (2 != theListenerNode.inTouchPoints.size) {\r\n       return;\r\n    }\r\n    if (2 == event._touches.length) {\r\n      const firstTouch = event._touches[0];\r\n      const secondTouch = event._touches[1];\r\n\r\n      const startMagnitude = firstTouch._startPoint.sub(secondTouch._startPoint).mag();\r\n      const currentMagnitude = firstTouch._point.sub(secondTouch._point).mag();\r\n\r\n      let scaleBy = (currentMagnitude / startMagnitude);\r\n      scaleBy = 1 + (scaleBy - 1) * this.zoomingScaleFacBase;\r\n      if (1 < scaleBy && Math.abs(scaleBy - 1) < this.scaleByEps) {\r\n        // Jitterring.\r\n        cc.log(`ScaleBy == ${scaleBy} is just jittering.`);\r\n        return;\r\n      }\r\n      if (1 > scaleBy && Math.abs(scaleBy - 1) < 0.5 * this.scaleByEps) {\r\n        // Jitterring.\r\n        cc.log(`ScaleBy == ${scaleBy} is just jittering.`);\r\n        return;\r\n      }\r\n      if (!this.mainCamera) return;\r\n      const targetScale = this.mainCamera.zoomRatio * scaleBy;\r\n      if (this.minScale > targetScale || targetScale > this.maxScale) {\r\n        return;\r\n      }\r\n      this.mainCamera.zoomRatio = targetScale;\r\n      for (let child of this.mainCameraNode.children) {\r\n        child.setScale(1/targetScale); \r\n      }\r\n    }\r\n  },\r\n\r\n  _touchEndEvent(event) {\r\n    const theListenerNode = event.target; \r\n    do {\r\n      if (!theListenerNode.inTouchPoints.has(event.currentTouch._id)) {\r\n        break;\r\n      }\r\n      const diffVec = event.currentTouch._point.sub(event.currentTouch._startPoint);\r\n      const diffVecMag = diffVec.mag();\r\n      if (this.linearMovingEps <= diffVecMag) {\r\n        break;\r\n      }\r\n      // Only triggers map-state-switch when `diffVecMag` is sufficiently small.\r\n\r\n      if (ALL_MAP_STATES.VISUAL != this.mapScriptIns.state) {\r\n        break;\r\n      }\r\n\r\n      // TODO: Handle single-finger-click event.\r\n    } while (false);\r\n    this.cachedStickHeadPosition = cc.v2(0.0, 0.0);\r\n    for (let touch of event._touches) {\r\n      if (touch){\r\n        theListenerNode.inTouchPoints.delete(touch._id);\r\n      }\r\n    }\r\n  },\r\n\r\n  _touchCancelEvent(event) {},\r\n\r\n  update(dt) {\r\n    if (this.inMultiTouch) return;\r\n    if (true != this.initialized) return;\r\n    this.stickhead.setPosition(this.cachedStickHeadPosition);\r\n    const eps = this.joyStickEps;\r\n\r\n    if (Math.abs(this.cachedStickHeadPosition.x) < eps && Math.abs(this.cachedStickHeadPosition.y) < eps) {\r\n      this.activeDirection.dx = 0;\r\n      this.activeDirection.dy = 0;\r\n      return;\r\n    }\r\n\r\n    // TODO: Really normalize the following `normalizedDir`.\r\n    const cachedStickHeadPositionMag = this.cachedStickHeadPosition.mag(); \r\n    const normalizedDir = {\r\n      dx: this.cachedStickHeadPosition.x/cachedStickHeadPositionMag,\r\n      dy: this.cachedStickHeadPosition.y/cachedStickHeadPositionMag,\r\n    }; \r\n    this.activeDirection = normalizedDir;\r\n  },\r\n\r\n  discretizeDirection(continuousDx, continuousDy, eps) {\r\n    let ret = {\r\n      dx: 0,\r\n      dy: 0,\r\n    };\r\n    if (Math.abs(continuousDx) < eps) {\r\n      ret.dx = 0;\r\n      ret.dy = continuousDy > 0 ? +1 : -1;\r\n    } else if (Math.abs(continuousDy) < eps) {\r\n      ret.dx = continuousDx > 0 ? +2 : -2;\r\n      ret.dy = 0;\r\n    } else {\r\n      const criticalRatio = continuousDy / continuousDx;\r\n      if (criticalRatio > this.magicLeanLowerBound && criticalRatio < this.magicLeanUpperBound) {\r\n        ret.dx = continuousDx > 0 ? +2 : -2;\r\n        ret.dy = continuousDx > 0 ? +1 : -1;\r\n      } else if (criticalRatio > -this.magicLeanUpperBound && criticalRatio < -this.magicLeanLowerBound) {\r\n        ret.dx = continuousDx > 0 ? +2 : -2;\r\n        ret.dy = continuousDx > 0 ? -1 : +1;\r\n      } else {\r\n        if (Math.abs(criticalRatio) < 1) {\r\n          ret.dx = continuousDx > 0 ? +2 : -2;\r\n          ret.dy = 0;\r\n        } else {\r\n          ret.dx = 0;\r\n          ret.dy = continuousDy > 0 ? +1 : -1;\r\n        }\r\n      }\r\n    }\r\n    return ret;\r\n  },\r\n});\r\n"]}