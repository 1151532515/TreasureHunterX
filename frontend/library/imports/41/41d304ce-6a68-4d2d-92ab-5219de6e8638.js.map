{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","cc","Class","extends","Component","properties","selfPlayer","canvasNode","type","Node","default","tiledAnimPrefab","Prefab","selfPlayerPrefab","npcPlayerPrefab","type2NpcPlayerPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","boundRoomIdLabel","Label","countdownLabel","_onPerUpsyncFrame","instance","selfPlayerId","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","id","dir","dx","parseFloat","dy","x","y","wrapped","msgId","Date","now","act","data","clientSession","send","JSON","stringify","onDestroy","self","upsyncLoopInterval","clearInterval","inputControlTimer","onLoad","mapNode","node","parent","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","otherPlayerNodeDict","confirmLogoutNode","instantiate","getComponent","width","height","clientUpsyncFps","handleClientSessionCloseOrError","sys","localStorage","loadScene","initPersistentSessionClient","state","tiledMapIns","TiledMap","parse","playerId","spawnSelfPlayer","_inputControlEnabled","setupInputControls","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","Animation","setPosition","posInMapNode","sizeInMapNode","setScale","origSize","setAnchorPoint","v2","safelyAddChild","setLocalZOrder","addClip","animationClip","play","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","getChildByName","sheltersZReducer","newShelter","newShelterColliderIns","setInterval","bind","handleDownsyncRoomFrame","roomFrame","string","countdownMillis","toString","frameId","sentAt","refFrameId","players","playerIdStrList","Object","keys","i","length","k","parseInt","anotherPlayer","renderAnotherControlledPlayer","mapIns","log","targetNode","newScheduledDirection","ctrl","discretizeDirection","joyStickEps","scheduleNewDirection","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","newScheduledDirectionInWorldCoordinate","activeDirection","dPjX","dPjY","newScheduledDirectionInLocalCoordinate","enableInputControls","disableInputControls","newPlayer","uid","update","dt","boundRoomId","transitToState","s","logout","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","closeFlag","closeWSConnection","removeItem","onLogoutClicked","evt","getScale","onLogoutConfirmationDismissed","removeChild"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    selfPlayer: null,\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    selfPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    npcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    type2NpcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    boundRoomIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    countdownLabel: {\n      type: cc.Label,\n      default: null\n    },\n  },\n\n  _onPerUpsyncFrame() {\n    const instance = this; \n    if (\n      null == instance.selfPlayerId ||\n      null == instance.selfPlayerScriptIns ||\n      null == instance.selfPlayerScriptIns.scheduledDirection\n    ) return;\n    const upsyncFrameData = {\n      id: instance.selfPlayerId,\n      dir: {\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\n      },\n      x: parseFloat(instance.selfPlayer.x),\n      y: parseFloat(instance.selfPlayer.y), \n    };\n    const wrapped = {\n      msgId: Date.now(),\n      act: \"PlayerUpsyncCmd\",\n      data: upsyncFrameData, \n    }\n    window.clientSession.send(JSON.stringify(wrapped)); \n  },\n\n  // LIFE-CYCLE CALLBACKS:\n  onDestroy() {\n    const self = this;\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n    if (self.inputControlTimer) {\n      clearInterval(self.inputControlTimer)\n    }\n  },\n\n  onLoad() {\n    const self = this;\n    self.msgId = 0;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n\n    self.otherPlayerNodeDict = {};\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n    self.confirmLogoutNode.width = canvasNode.width;\n    self.confirmLogoutNode.height = canvasNode.height;\n\n    self.clientUpsyncFps = 24;\n    self.upsyncLoopInterval = null;\n\n    window.handleClientSessionCloseOrError = function() {\n      if (null != cc.sys.localStorage.selfPlayer) {\n        cc.sys.localStorage.selfPlayer = null;\n        delete cc.sys.localStorage.selfPlayer;\n        cc.director.loadScene('login');\n      } \n    }; \n    initPersistentSessionClient(() => {\n      self.state = ALL_MAP_STATES.VISUAL;\n      const tiledMapIns = self.node.getComponent(cc.TiledMap); \n      self.selfPlayerId = JSON.parse(cc.sys.localStorage.selfPlayer).playerId;\n      self.spawnSelfPlayer();\n      self.selfPlayerScriptIns = self.selfPlayer.getComponent(\"SelfPlayer\");\n      this._inputControlEnabled = true;\n      self.setupInputControls();\n\n      const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node); \n      for (let frameAnim of boundaryObjs.frameAnimations) {\n        const animNode = cc.instantiate(self.tiledAnimPrefab);  \n        const anim = animNode.getComponent(cc.Animation); \n        animNode.setPosition(frameAnim.posInMapNode);\n        animNode.width = frameAnim.sizeInMapNode.width;\n        animNode.height = frameAnim.sizeInMapNode.height;\n        animNode.setScale(frameAnim.sizeInMapNode.width/frameAnim.origSize.width, frameAnim.sizeInMapNode.height/frameAnim.origSize.height);\n        animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n        safelyAddChild(self.node, animNode);  \n        setLocalZOrder(animNode, 5);  \n        anim.addClip(frameAnim.animationClip, \"default\");\n        anim.play(\"default\");\n      } \n\n      self.barrierColliders = [];\n      for (let boundaryObj of boundaryObjs.barriers) {\n        const newBarrier = cc.instantiate(self.barrierPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newBarrier.setPosition(newBoundaryOffsetInMapNode);\n        newBarrier.setAnchorPoint(cc.v2(0, 0));\n        const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider); \n        newBarrierColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.barrierColliders.push(newBarrierColliderIns);\n        self.node.addChild(newBarrier);\n      }\n\n      const allLayers = tiledMapIns.getLayers();\n      for (let layer of allLayers) {\n        const layerType = layer.getProperty(\"type\"); \n        switch (layerType) {\n          case \"normal\":\n            setLocalZOrder(layer.node, 0);\n            break;\n          case \"barrier_and_shelter\":\n            setLocalZOrder(layer.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      const allObjectGroups = tiledMapIns.getObjectGroups(); \n      for (let objectGroup of allObjectGroups) {\n        const objectGroupType = objectGroup.getProperty(\"type\"); \n        switch (objectGroupType) {\n          case \"barrier_and_shelter\":\n            setLocalZOrder(objectGroup.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      if (this.joystickInputControllerNode.parent !== this.node.parent.parent.getChildByName('JoystickContainer')) {\n        this.joystickInputControllerNode.parent = this.node.parent.parent.getChildByName('JoystickContainer');\n      }\n      this.joystickInputControllerNode.parent.width = this.node.parent.width * 0.5;\n      this.joystickInputControllerNode.parent.height = this.node.parent.height;\n\n      for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n        const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newShelter.setPosition(newBoundaryOffsetInMapNode);\n        newShelter.setAnchorPoint(cc.v2(0, 0));\n        const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider); \n        newShelterColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.node.addChild(newShelter);\n      }\n      self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\n      window.handleDownsyncRoomFrame = function(roomFrame) {\n        self.countdownLabel.string = (roomFrame.countdownMillis/1000).toString();\n        const frameId = roomFrame.id;\n        const sentAt = roomFrame.sentAt;\n        const refFrameId = roomFrame.refFrameId;\n        const players = roomFrame.players;\n        const playerIdStrList = Object.keys(players);\n        for (let i = 0; i < playerIdStrList.length; ++i) {\n          const k = playerIdStrList[i];\n          const playerId = parseInt(k);\n          if (playerId == self.selfPlayerId) continue;\n          const anotherPlayer = players[k]; \n          self.renderAnotherControlledPlayer(self, anotherPlayer);\n        } \n      };\n    });\n  },\n\n  renderAnotherControlledPlayer: (mapIns, anotherPlayer) => {\n    const mapNode = mapIns.node;\n\n    cc.log(`Rendering anotherPlayer ${JSON.stringify(anotherPlayer)}`)\n    let targetNode = mapIns.otherPlayerNodeDict[anotherPlayer.id];\n    if (!targetNode) {\n      targetNode = cc.instantiate(mapIns.selfPlayerPrefab);\n      targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\n      mapNode.addChild(targetNode);\n      setLocalZOrder(targetNode, 5);\n      mapIns.otherPlayerNodeDict[anotherPlayer.id] = targetNode;\n    }\n    targetNode.setPosition(cc.v2(anotherPlayer.x, anotherPlayer.y));\n    const newScheduledDirection = mapIns.ctrl.discretizeDirection(anotherPlayer.dir.dx, anotherPlayer.dir.dy, mapIns.ctrl.joyStickEps);  \n    if (0 != newScheduledDirection.dx || 0 != newScheduledDirection.dy) { \n      targetNode.getComponent(\"SelfPlayer\").scheduleNewDirection(newScheduledDirection, true);\n    }\n  }, \n\n  setupInputControls() {\n    const instance = this;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const selfPlayerScriptIns = instance.selfPlayerScriptIns;\n\n    const ctrl = joystickInputControllerScriptIns;\n    instance.ctrl = ctrl;\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n\n      const newScheduledDirectionInWorldCoordinate = {\n        dx: ctrl.activeDirection.dPjX,\n        dy: ctrl.activeDirection.dPjY\n      };\n\n      const newScheduledDirectionInLocalCoordinate = newScheduledDirectionInWorldCoordinate;\n      selfPlayerScriptIns.scheduleNewDirection(newScheduledDirectionInLocalCoordinate);\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true; \n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  spawnSelfPlayer() {\n    const instance = this;\n    const newPlayer = cc.instantiate(instance.selfPlayerPrefab);\n    newPlayer.uid = 0;\n    newPlayer.setPosition(cc.v2(0, 0));\n    newPlayer.getComponent(\"SelfPlayer\").mapNode = instance.node;\n\n    instance.node.addChild(newPlayer);\n\n    setLocalZOrder(newPlayer, 5);\n    instance.selfPlayer = newPlayer;\n  },\n\n  update(dt) {\n    const self = this;\n    if (null != window.boundRoomId) {\n      self.boundRoomIdLabel.string = window.boundRoomId;  \n    }\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout() {\n    // Will be called within \"ConfirmLogou.js\".\n    const self = this;\n    const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const requestContent = {\n      intAuthToken: selfPlayer.intAuthToken\n    }\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n      type: \"POST\",\n      data: requestContent,\n      success: function(res) {\n        if (res.ret != constants.RET_CODE.OK) {\n          cc.log(`Logout failed: ${res}.`);\n        }\n        self.closeFlag = true;\n        window.closeWSConnection();\n        cc.sys.localStorage.removeItem('selfPlayer');\n        cc.director.loadScene('login');\n      }\n    });\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    const canvasNode = self.canvasNode;\n    self.confirmLogoutNode.setScale(1 / canvasNode.getScale());\n    safelyAddChild(canvasNode, self.confirmLogoutNode);\n    setLocalZOrder(self.confirmLogoutNode, 10);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n});\n\n"]}