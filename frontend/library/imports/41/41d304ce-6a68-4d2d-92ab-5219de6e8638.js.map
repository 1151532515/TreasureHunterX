{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","pumpkinPrefab","treasurePrefab","trapPrefab","acceleratorPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","guardTowerPrefab","forceBigEndianFloatingNumDecoding","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","speedShoes","pumpkin","guardTowers","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","pumpkinsLocalIdStrList","pumpkinLocalIdInBattle","treasuresLocalIdStrList","treasureLocalIdInBattle","speedShoesLocalIdStrList","speedShoesLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","console","log","accs","accsLocalIdStrList","accLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","resyncing","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onEnable","warn","mapIns","counter","onDisable","onDestroy","battleState","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleRoomDownsyncFrame","handleClientSessionCloseOrError","upsyncLoopInterval","clearInterval","inputControlTimer","_lazilyTriggerResync","lastResyncingStartedAt","state","resyncingHintPopup","popupSimplePressToGo","t","_onResyncCompleted","resyncingDurationMillis","parent","removeChild","labelString","hideYesButton","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","string","once","dismissDialog","bind","active","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","playersNode","Animation","play","start","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","pumpkinNodeDict","acceleratorNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","pumpkinInfoDict","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","towerNodeDict","findingPlayerNode","findingPlayerScriptIns","showPopupInCanvas","gameRuleNode","playersInfoNode","clearLocalStorageAndBackToLoginScene","musicEffectManagerScriptIns","stopAllMusic","closeWSConnection","clearSelfPlayer","sys","platform","WECHAT_GAME","director","loadScene","onLoad","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","confirmLogoutNode","resultPanelNode","width","height","resultPanelScriptIns","mapScriptIns","onAgainClicked","initPersistentSessionClient","initAfterWSConnected","gameRuleScriptIns","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","sizeInMapNode","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","hideGameRuleNode","parse","localStorage","getItem","_inputControlEnabled","setupInputControls","refFrameId","playersMatched","hideExitButton","initWxSdk","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","displayName","name","speed","score","joinIndex","anotherPlayer","pumpkinInfo","treasureInfo","acceleratorInfoDict","accelartors","accLocalIdStrList","accInfo","trapInfo","bulletInfo","guardTowerInfoDict","ids","localIdInBattle","tower","onBattleStarted","expectedRoomId","getExpectedRoomIdSync","disableGameRuleNode","modeButton","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","playBGM","spawnSelfPlayer","showPlayerInfo","clearInfo","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","boundRoomId","playersScriptIns","updateData","updateSpeed","toRemoveAcceleratorNodeDict","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemovePumpkinNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","acceleratorInfo","towerInfo","rotation","startAtPoint","endAtPoint","error","radian","Math","PI","abs","atan","angleTemp","angle","aBulletScriptIns","linearSpeed","aPumpkinScriptIns","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","playHighScoreTreasurePicked","playTreasurePicked","playCrashedByTrapBullet","err","s","byClick","localClearance","selfPlayerStr","selfPlayer","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","onGameRule1v1ModeClicked","cb","toShowNode","playerInfo","countDownScriptIns"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\nwindow.ALL_BATTLE_STATES = {\n  WAITING: 0,\n  IN_BATTLE: 1,\n  IN_SETTLEMENT: 2,\n  IN_DISMISSAL: 3,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    useDiffFrameAlgo: {\n      default: true\n    },\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player1Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player2Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    pumpkinPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    treasurePrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    trapPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    acceleratorPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    simplePressToGoDialogPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    boundRoomIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    countdownLabel: {\n      type: cc.Label,\n      default: null\n    },\n    trapBulletPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    resultPanelPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    gameRulePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    findingPlayerPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    countdownToBeginGamePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    playersInfoPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    guardTowerPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    forceBigEndianFloatingNumDecoding: {\n      default: false,\n    },\n  },\n\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\n    let newFullFrame = {\n      id: diffFrame.id,\n      treasures: refFullFrame.treasures,\n      traps: refFullFrame.traps,\n      bullets: refFullFrame.bullets,\n      players: refFullFrame.players,\n      speedShoes: refFullFrame.speedShoes,\n      pumpkin: refFullFrame.pumpkin,\n      guardTowers: refFullFrame.guardTowers, //TODO: 根据diffFrame信息增删或者移动守护塔\n    };\n    const players = diffFrame.players;\n    const playersLocalIdStrList = Object.keys(players);\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\n      const k = playersLocalIdStrList[i];\n      const playerId = parseInt(k);\n      if (true == diffFrame.players[playerId].removed) {\n        delete newFullFrame.players[playerId];\n      } else {\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\n      }\n    }\n\n    const pumpkin = diffFrame.pumpkin;\n    const pumpkinsLocalIdStrList = Object.keys(pumpkin);\n    for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\n      const k = pumpkinsLocalIdStrList[i];\n      const pumpkinLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.pumpkin[pumpkinLocalIdInBattle].removed) {\n        delete newFullFrame.pumpkin[pumpkinLocalIdInBattle];\n      } else {\n        newFullFrame.pumpkin[pumpkinLocalIdInBattle] = diffFrame.pumpkin[pumpkinLocalIdInBattle];\n      }\n    }\n\n    const treasures = diffFrame.treasures;\n    const treasuresLocalIdStrList = Object.keys(treasures);\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\n      const k = treasuresLocalIdStrList[i];\n      const treasureLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\n      } else {\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\n      }\n    }\n\n    const speedShoes = diffFrame.speedShoes;\n    const speedShoesLocalIdStrList = Object.keys(speedShoes);\n    for (let i = 0; i < speedShoesLocalIdStrList.length; ++i) {\n      const k = speedShoesLocalIdStrList[i];\n      const speedShoesLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.speedShoes[speedShoesLocalIdInBattle].removed) {\n        delete newFullFrame.speedShoes[speedShoesLocalIdInBattle];\n      } else {\n        newFullFrame.speedShoes[speedShoesLocalIdInBattle] = diffFrame.speedShoes[speedShoesLocalIdInBattle];\n      }\n    }\n\n    const traps = diffFrame.traps;\n    const trapsLocalIdStrList = Object.keys(traps);\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n      const k = trapsLocalIdStrList[i];\n      const trapLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\n        delete newFullFrame.traps[trapLocalIdInBattle];\n      } else {\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\n      }\n    }\n\n    const bullets = diffFrame.bullets;\n    const bulletsLocalIdStrList = Object.keys(bullets);\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n      const k = bulletsLocalIdStrList[i];\n      const bulletLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\n        console.log(\"Bullet with localIdInBattle == \", bulletLocalIdInBattle, \"is removed.\");\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\n      } else {\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\n      }\n    }\n\n    const accs = diffFrame.speedShoes;\n    const accsLocalIdStrList = Object.keys(accs);\n    for (let i = 0; i < accsLocalIdStrList.length; ++i) {\n      const k = accsLocalIdStrList[i];\n      const accLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.speedShoes[accLocalIdInBattle].removed) {\n        delete newFullFrame.speedShoes[accLocalIdInBattle];\n      } else {\n        newFullFrame.speedShoes[accLocalIdInBattle] = diffFrame.speedShoes[accLocalIdInBattle];\n      }\n    }\n    return newFullFrame;\n  },\n\n  _dumpToFullFrameCache: function(fullFrame) {\n    const self = this;\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\n      delete self.recentFrameCache[toDelFrameId];\n      --self.recentFrameCacheCurrentSize;\n    }\n    self.recentFrameCache[fullFrame.id] = fullFrame;\n    ++self.recentFrameCacheCurrentSize;\n  },\n\n  _onPerUpsyncFrame() {\n    const instance = this;\n    if (instance.resyncing) return;\n    if (\n      null == instance.selfPlayerInfo ||\n      null == instance.selfPlayerScriptIns ||\n      null == instance.selfPlayerScriptIns.scheduledDirection\n      ) return;\n    const upsyncFrameData = {\n      id: instance.selfPlayerInfo.id,\n      /**\n      * WARNING\n      *\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\n      */\n      dir: {\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\n      },\n      x: parseFloat(instance.selfPlayerNode.x),\n      y: parseFloat(instance.selfPlayerNode.y),\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\n    };\n    const wrapped = {\n      msgId: Date.now(),\n      act: \"PlayerUpsyncCmd\",\n      data: upsyncFrameData,\n    }\n    window.sendSafely(JSON.stringify(wrapped));\n  },\n\n  onEnable() {\n    cc.warn(`+++++++ Map onEnable(), mapIns.counter: ${window.mapIns.counter}`);\n  },\n\n  onDisable() {\n    cc.warn(`+++++++ Map onDisable(), mapIns.counter: ${window.mapIns.counter}`);\n  },\n\n  onDestroy() {\n    const self = this;\n    cc.warn(`+++++++ Map onDestroy(), mapIns.counter: ${window.mapIns.counter}`);\n    if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n    }\n    if (null != window.handleRoomDownsyncFrame) {\n      window.handleRoomDownsyncFrame = null;\n    }\n    if (null != window.handleClientSessionCloseOrError) {\n      window.handleClientSessionCloseOrError = null; \n    }\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n    if (self.inputControlTimer) {\n      clearInterval(self.inputControlTimer);\n    }\n  },\n\n  _lazilyTriggerResync() {\n    if (true == this.resyncing) return;\n    this.lastResyncingStartedAt = Date.now();\n    this.resyncing = true;\n\n    console.warn(\"_lazilyTriggerResync, resyncing\");\n\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\n      if (null == this.resyncingHintPopup) {\n        this.resyncingHintPopup = this.popupSimplePressToGo(i18n.t(\"gameTip.resyncing\"), true);\n      }\n    }\n  },\n\n  _onResyncCompleted() {\n    if (false == this.resyncing) return;\n    this.resyncing = false;\n    const resyncingDurationMillis = (Date.now() - this.lastResyncingStartedAt);\n    console.warn(\"_onResyncCompleted, resyncing took \", resyncingDurationMillis, \" milliseconds.\");\n    if (null != this.resyncingHintPopup && this.resyncingHintPopup.parent) {\n      this.resyncingHintPopup.parent.removeChild(this.resyncingHintPopup);\n    }\n  },\n\n  popupSimplePressToGo(labelString, hideYesButton) {\n    const self = this;\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\n\n    const canvasNode = self.canvasNode;\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\n    const postDismissalByYes = () => {\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      canvasNode.removeChild(simplePressToGoDialogNode);\n    }\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\n\n    if (true == hideYesButton) {\n      yesButton.active = false;\n    }\n\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\n    setLocalZOrder(simplePressToGoDialogNode, 20);\n    return simplePressToGoDialogNode;\n  },\n\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const millisToGo = 3000;\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\n    setTimeout(() => {\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\n    }, millisToGo);\n  },\n\n  _resetCurrentMatch() {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    self.countdownLabel.string = \"\";\n    if (self.playersNode) {\n      for (let i in self.playersNode) {\n        let node = self.playersNode[i];\n        node.getComponent(cc.Animation).play(\"Bottom\");\n        node.getComponent(\"SelfPlayer\").start();\n        node.active = true;\n      }\n    }\n    if (self.otherPlayerNodeDict) {\n      for (let i in self.otherPlayerNodeDict) {\n        let node = self.otherPlayerNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\n    }\n    if (self.treasureNodeDict) {\n      for (let i in self.treasureNodeDict) {\n        let node = self.treasureNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapBulletNodeDict) {\n      for (let i in self.trapBulletNodeDict) {\n        let node = self.trapBulletNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapNodeDict) {\n      for (let i in self.trapNodeDict) {\n        let node = self.trapNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.pumpkinNodeDict) {\n      for (let i in self.pumpkinNodeDict) {\n        let node = self.pumpkinNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.acceleratorNodeDict) {\n      for (let i in self.acceleratorNodeDict) {\n        let node = self.acceleratorNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\n    for (let child of self.mainCameraNode.children) {\n      child.setScale(1 / self.mainCamera.zoomRatio);\n    }\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\n    self.mainCameraNode.setPosition(cc.v2());\n\n    self.resyncing = false;\n    self.lastRoomDownsyncFrameId = 0;\n\n    self.recentFrameCache = {};\n    self.recentFrameCacheCurrentSize = 0;\n    self.recentFrameCacheMaxCount = 2048;\n    self.selfPlayerNode = null;\n    self.selfPlayerScriptIns = null;\n    self.selfPlayerInfo = null;\n    self.upsyncLoopInterval = null;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n\n    self.battleState = ALL_BATTLE_STATES.WAITING;\n\n    self.pumpkinInfoDict = {};\n    self.pumpkinNodeDict = {};\n    self.otherPlayerCachedDataDict = {};\n    self.otherPlayerNodeDict = {};\n    self.treasureInfoDict = {};\n    self.treasureNodeDict = {};\n    self.trapInfoDict = {};\n    self.trapBulletInfoDict = {};\n    self.trapBulletNodeDict = {};\n    self.trapNodeDict = {};\n    self.towerNodeDict = {};\n    self.acceleratorNodeDict = {};\n    if (self.findingPlayerNode) {\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n      findingPlayerScriptIns.init();\n    }\n    self.showPopupInCanvas(self.gameRuleNode);\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\n  },\n\n  clearLocalStorageAndBackToLoginScene(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const self = this;\n    if (self.musicEffectManagerScriptIns) {\n      self.musicEffectManagerScriptIns.stopAllMusic();\n    }\n    /**\n     * Here I deliberately removed the callback in the \"common `handleClientSessionCloseOrError` callback\"\n     * within which another invocation to `clearLocalStorageAndBackToLoginScene` will be made.\n     *\n     * It'll be re-assigned to the common one upon reentrance of `Map.onLoad`.\n     *\n     * -- YFLu 2019-04-06\n     */\n    window.handleClientSessionCloseOrError = () => {\n      console.warn('+++++++ Special handleClientSessionCloseOrError() assigned within `clearLocalStorageAndBackToLoginScene`, mapIns.counter:', window.mapIns.counter);\n      // TBD.\n      window.handleClientSessionCloseOrError = null; // To ensure that it's called at most once. \n    };\n    window.closeWSConnection();\n    window.clearSelfPlayer();\n    if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n    }\n    if (cc.sys.platform == cc.sys.WECHAT_GAME) {\n      cc.director.loadScene('wechatGameLogin');\n    } else {\n      cc.director.loadScene('login');\n    }\n  },\n\n  onLoad() {\n    const self = this;\n    window.mapIns = self;\n    window.forceBigEndianFloatingNumDecoding = self.forceBigEndianFloatingNumDecoding;\n\n    self.counter = (() => {\n      if (window.mapIns == null || null == window.mapIns.counter) {\n        return 0;\n      } else {\n        return window.mapIns.counter + 1;\n      }\n    })();\n\n    cc.warn('+++++++ Map onLoad(), map counter:', window.mapIns.counter);\n    window.handleClientSessionCloseOrError = function() {\n      console.warn('+++++++ Common handleClientSessionCloseOrError(), mapIns.counter:', window.mapIns.counter);\n\n      if (ALL_BATTLE_STATES.IN_SETTLEMENT == self.battleState) { //如果是游戏时间结束引起的断连\n        console.log(\"游戏结束引起的断连, 不需要回到登录页面\");\n      } else {\n        console.warn(\"意外断连，即将回到登录页面\");\n        self.clearLocalStorageAndBackToLoginScene(true);\n      }\n    };\n\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n    self.musicEffectManagerScriptIns = self.node.getComponent(\"MusicEffectManager\");\n\n    /** Init required prefab started. */\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n\n    // Initializes Result panel.\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\n    self.resultPanelNode.width = self.canvasNode.width;\n    self.resultPanelNode.height = self.canvasNode.height;\n\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.mapScriptIns = self;\n    resultPanelScriptIns.onAgainClicked = () => {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      self._resetCurrentMatch();\n      window.initPersistentSessionClient(self.initAfterWSConnected, null /* Deliberately NOT passing in any `expectedRoomId`. -- YFLu */);\n    };\n\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\n    self.gameRuleNode.width = self.canvasNode.width;\n    self.gameRuleNode.height = self.canvasNode.height;\n\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\n    self.gameRuleScriptIns.mapNode = self.node;\n\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\n    self.findingPlayerNode.width = self.canvasNode.width;\n    self.findingPlayerNode.height = self.canvasNode.height;\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.init();\n\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\n\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\n    self.countdownToBeginGameNode.width = self.canvasNode.width;\n    self.countdownToBeginGameNode.height = self.canvasNode.height;\n\n    self.playersNode = {};\n    const player1Node = cc.instantiate(self.player1Prefab);\n    const player2Node = cc.instantiate(self.player2Prefab);\n    Object.assign(self.playersNode, {\n      1: player1Node\n    });\n    Object.assign(self.playersNode, {\n      2: player2Node\n    });\n\n    /** Init required prefab ended. */\n\n    self.clientUpsyncFps = 20;\n    self._resetCurrentMatch();\n\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\n    for (let frameAnim of boundaryObjs.frameAnimations) {\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\n      const anim = animNode.getComponent(cc.Animation);\n      animNode.setPosition(frameAnim.posInMapNode);\n      animNode.width = frameAnim.sizeInMapNode.width;\n      animNode.height = frameAnim.sizeInMapNode.height;\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n      safelyAddChild(self.node, animNode);\n      setLocalZOrder(animNode, 5);\n      anim.addClip(frameAnim.animationClip, \"default\");\n      anim.play(\"default\");\n    }\n\n    self.barrierColliders = [];\n    for (let boundaryObj of boundaryObjs.barriers) {\n      const newBarrier = cc.instantiate(self.barrierPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\n      newBarrierColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.barrierColliders.push(newBarrierColliderIns);\n      self.node.addChild(newBarrier);\n    }\n    const allLayers = tiledMapIns.getLayers();\n    for (let layer of allLayers) {\n      const layerType = layer.getProperty(\"type\");\n      switch (layerType) {\n        case \"normal\":\n          setLocalZOrder(layer.node, 0);\n          break;\n        case \"barrier_and_shelter\":\n          setLocalZOrder(layer.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    const allObjectGroups = tiledMapIns.getObjectGroups();\n    for (let objectGroup of allObjectGroups) {\n      const objectGroupType = objectGroup.getProperty(\"type\");\n      switch (objectGroupType) {\n        case \"barrier_and_shelter\":\n          setLocalZOrder(objectGroup.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\n      newShelter.setAnchorPoint(cc.v2(0, 0));\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\n      newShelterColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.node.addChild(newShelter);\n    }\n\n    self.initAfterWSConnected = () => {\n      const self = window.mapIns;\n      self.hideGameRuleNode();\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n      Object.assign(self.selfPlayerInfo, {\n        id: self.selfPlayerInfo.playerId\n      });\n      self.transitToState(ALL_MAP_STATES.WAITING);\n      self._inputControlEnabled = false;\n      self.setupInputControls();\n\n      window.handleRoomDownsyncFrame = function(diffFrame) {\n        if (ALL_BATTLE_STATES.WAITING != self.battleState \n            && ALL_BATTLE_STATES.IN_BATTLE != self.battleState \n            && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) {\n          return;\n        }\n        const refFrameId = diffFrame.refFrameId;\n        if (-99 == refFrameId) {\n          //显示倒计时\n          self.playersMatched(diffFrame.players);\n          //隐藏返回按钮\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n          findingPlayerScriptIns.hideExitButton();\n        } else if (-98 == refFrameId) {\n          //显示匹配玩家\n          if (window.initWxSdk) {\n            window.initWxSdk();\n          }\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n          if (!self.findingPlayerNode.parent) {\n            self.showPopupInCanvas(self.findingPlayerNode);\n          }\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.players);\n          return;\n        }\n\n        const frameId = diffFrame.id;\n        if (frameId <= self.lastRoomDownsyncFrameId) {\n          // Log the obsolete frames?\n          return;\n        }\n        const isInitiatingFrame = (0 >= self.recentFrameCacheCurrentSize || 0 == refFrameId);\n        /*\n        if (frameId % 300 == 0) {\n          // WARNING: For testing only!\n          if (0 < frameId) {\n            self._lazilyTriggerResync(); \n          }\n          console.log(JSON.stringify(diffFrame));\n        }\n        */\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\n        if (\n          !isInitiatingFrame\n          && self.useDiffFrameAlgo\n          && (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\". \n          && null == cachedFullFrame\n        ) {\n          self._lazilyTriggerResync();\n          // Later incoming diffFrames will all suffice that `0 < self.recentFrameCacheCurrentSize && null == cachedFullFrame`, until `this._onResyncCompleted` is successfully invoked.\n          return;\n        }\n\n        if (isInitiatingFrame && 0 == refFrameId) {\n          // Reaching here implies that you've received the resync frame.\n          self._onResyncCompleted();\n        }\n        let countdownNanos = diffFrame.countdownNanos;\n        if (countdownNanos < 0) {\n          countdownNanos = 0;\n        }\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\n        if (isNaN(countdownSeconds)) {\n          cc.warn(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\n        }\n        self.countdownLabel.string = countdownSeconds;\n        const roomDownsyncFrame = ( //根据refFrameId和diffFrame计算出新的一帧\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\n          ?\n          diffFrame\n          :\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\n        );\n\n        if (countdownNanos <= 0) {\n          self.onBattleStopped(roomDownsyncFrame.players);\n          return;\n        }\n        self._dumpToFullFrameCache(roomDownsyncFrame);\n        const sentAt = roomDownsyncFrame.sentAt;\n\n        const players = roomDownsyncFrame.players;\n        const playerIdStrList = Object.keys(players);\n        self.otherPlayerCachedDataDict = {};\n        for (let i = 0; i < playerIdStrList.length; ++i) {\n          const k = playerIdStrList[i];\n          const playerId = parseInt(k);\n          if (playerId == self.selfPlayerInfo.id) {\n            const immediateSelfPlayerInfo = players[k];\n            Object.assign(self.selfPlayerInfo, {\n              displayName: (null == immediateSelfPlayerInfo.displayName ? (null == immediateSelfPlayerInfo.name ? \"\" : immediateSelfPlayerInfo.name) : immediateSelfPlayerInfo.displayName),\n              x: immediateSelfPlayerInfo.x,\n              y: immediateSelfPlayerInfo.y,\n              speed: immediateSelfPlayerInfo.speed,\n              battleState: immediateSelfPlayerInfo.battleState,\n              score: immediateSelfPlayerInfo.score,\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\n            });\n            continue;\n          }\n          const anotherPlayer = players[k];\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\n        }\n\n        //update pumpkin Info \n        self.pumpkinInfoDict = {};\n        const pumpkin = roomDownsyncFrame.pumpkin;\n        const pumpkinsLocalIdStrList = Object.keys(pumpkin);\n        for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\n          const k = pumpkinsLocalIdStrList[i];\n          const pumpkinLocalIdInBattle = parseInt(k);\n          const pumpkinInfo = pumpkin[k];\n          self.pumpkinInfoDict[pumpkinLocalIdInBattle] = pumpkinInfo;\n        }\n\n\n        //update treasureInfoDict\n        self.treasureInfoDict = {};\n        const treasures = roomDownsyncFrame.treasures;\n        const treasuresLocalIdStrList = Object.keys(treasures);\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) { //直接根据最新帧的数据覆盖掉treasureInfoDict\n          const k = treasuresLocalIdStrList[i];\n          const treasureLocalIdInBattle = parseInt(k);\n          const treasureInfo = treasures[k];\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\n        }\n\n        //update acceleratorInfoDict\n        self.acceleratorInfoDict = {};\n        const accelartors = roomDownsyncFrame.speedShoes;\n        const accLocalIdStrList = Object.keys(accelartors);\n        for (let i = 0; i < accLocalIdStrList.length; ++i) {\n          const k = accLocalIdStrList[i];\n          const accLocalIdInBattle = parseInt(k);\n          const accInfo = accelartors[k];\n          self.acceleratorInfoDict[accLocalIdInBattle] = accInfo;\n        }\n\n        //update trapInfoDict\n        self.trapInfoDict = {};\n        const traps = roomDownsyncFrame.traps;\n        const trapsLocalIdStrList = Object.keys(traps);\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n          const k = trapsLocalIdStrList[i];\n          const trapLocalIdInBattle = parseInt(k);\n          const trapInfo = traps[k];\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\n        }\n\n        self.trapBulletInfoDict = {};\n        const bullets = roomDownsyncFrame.bullets;\n        const bulletsLocalIdStrList = Object.keys(bullets);\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n          const k = bulletsLocalIdStrList[i];\n          const bulletLocalIdInBattle = parseInt(k);\n          const bulletInfo = bullets[k];\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\n        }\n\n        // Update `guardTowerInfoDict`.\n        self.guardTowerInfoDict = {};\n        const guardTowers = roomDownsyncFrame.guardTowers;\n        const ids = Object.keys(guardTowers);\n        for (let i = 0; i < ids.length; ++i) {\n          const id = ids[i];\n          const localIdInBattle = parseInt(id);\n          const tower = guardTowers[id];\n          self.guardTowerInfoDict[localIdInBattle] = tower;\n        }\n\n        if (0 == self.lastRoomDownsyncFrameId) {\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\n          if (1 == frameId) {\n            // No need to prompt upon rejoined.\n            self.popupSimplePressToGo(i18n.t(\"gameTip.start\"));\n          }\n          self.onBattleStarted();\n        }\n        self.lastRoomDownsyncFrameId = frameId;\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\n      };\n    }\n    \n    // The player is now viewing \"self.gameRuleNode\" with button(s) to start an actual battle. -- YFLu\n    const expectedRoomId = window.getExpectedRoomIdSync(); \n    console.warn(\"expectedRoomId: \", expectedRoomId);\n    if (null != expectedRoomId) {\n      self.disableGameRuleNode();\n      // The player is now viewing \"self.gameRuleNode\" with no button, and should wait for `self.initAfterWSConnected` to be called. -- YFLu\n      window.initPersistentSessionClient(self.initAfterWSConnected, expectedRoomId);\n    } else {\n      // Deliberately left blank. -- YFLu\n    }\n  },\n\n  disableGameRuleNode() {\n    const self = window.mapIns;\n    if (null != self.gameRuleNode && null != self.gameRuleNode.active && null != self.gameRuleScriptIns) {\n      self.gameRuleScriptIns.modeButton.active = false;\n    }\n  },\n\n  hideGameRuleNode() {\n    const self = window.mapIns;\n    if (null != self.gameRuleNode && null != self.gameRuleNode.active) {\n      self.gameRuleNode.active = false;\n    }\n  },\n\n  setupInputControls() {\n    const instance = window.mapIns;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const ctrl = joystickInputControllerScriptIns;\n    instance.ctrl = ctrl;\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n      if (instance.selfPlayerScriptIns != null && ctrl != null) {\n        instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\n      }\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true;\n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  onBattleStarted() {\n    cc.warn('On battle started!');\n    const self = window.mapIns;\n    if (self.musicEffectManagerScriptIns) {\n      self.musicEffectManagerScriptIns.playBGM();\n    }\n    const canvasNode = self.canvasNode;\n    self.spawnSelfPlayer();\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\n    self.enableInputControls();\n    if (self.countdownToBeginGameNode.parent) {\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\n    }\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n  },\n\n  onBattleStopped(players) {\n    const self = this;\n    if (self.musicEffectManagerScriptIns) {\n      self.musicEffectManagerScriptIns.stopAllMusic();\n    }\n    const canvasNode = self.canvasNode;\n    const resultPanelNode = self.resultPanelNode;\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.showPlayerInfo(players);\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage(); \n    // Such that it doesn't execute \"update(dt)\" anymore. \n    self.selfPlayerNode.active = false;\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\n    self.showPopupInCanvas(resultPanelNode);\n\n    // Clear player info\n    self.playersInfoNode.getComponent(\"PlayersInfo\").clearInfo();\n  },\n\n  spawnSelfPlayer() {\n    const instance = this;\n    const joinIndex = this.selfPlayerInfo.joinIndex;\n    const newPlayerNode = this.playersNode[joinIndex];\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\n    newPlayerNode.setPosition(toStartWithPos);\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\n\n    instance.node.addChild(newPlayerNode);\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\n    instance.selfPlayerScriptIns.showArrowTipNode();\n\n    setLocalZOrder(newPlayerNode, 5);\n    instance.selfPlayerNode = newPlayerNode;\n  },\n\n  update(dt) {\n\n    try {\n      const self = this;\n      const mapNode = self.node;\n      const canvasNode = mapNode.parent;\n      const canvasParentNode = canvasNode.parent;\n      if (null != window.boundRoomId) {\n        self.boundRoomIdLabel.string = window.boundRoomId;\n      }\n      if (null != self.selfPlayerInfo) {\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n        playersScriptIns.updateData(self.selfPlayerInfo);\n        if (null != self.selfPlayerScriptIns) {\n          self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\n        }\n      }\n\n      let toRemoveAcceleratorNodeDict = {};\n      Object.assign(toRemoveAcceleratorNodeDict, self.acceleratorNodeDict);\n\n      let toRemovePlayerNodeDict = {};\n      Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\n\n      let toRemoveTreasureNodeDict = {};\n      Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\n\n      let toRemoveTrapNodeDict = {};\n      Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\n\n      let toRemovePumpkinNodeDict = {};\n      Object.assign(toRemovePumpkinNodeDict, self.pumpkinNodeDict);\n\n      /*\n      * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\n      */\n      let toRemoveBulletNodeDict = {};\n      Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\n\n      for (let k in self.otherPlayerCachedDataDict) {\n        const playerId = parseInt(k);\n        const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\n        const newPos = cc.v2(\n          cachedPlayerData.x,\n          cachedPlayerData.y\n        );\n\n        //更新玩家信息展示\n        if (null != cachedPlayerData) {\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n          playersScriptIns.updateData(cachedPlayerData);\n        }\n        let targetNode = self.otherPlayerNodeDict[playerId];\n        if (!targetNode) {\n          targetNode = self.playersNode[cachedPlayerData.joinIndex];\n          targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\n          self.otherPlayerNodeDict[playerId] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n        const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\n        aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\n\n\n\n        const oldPos = cc.v2(\n          targetNode.x,\n          targetNode.y\n        );\n\n        const toMoveByVec = newPos.sub(oldPos);\n        const toMoveByVecMag = toMoveByVec.mag();\n        aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\n        const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\n        //const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\n        const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 1.0);\n        if (toMoveByVecMag < notToMoveDisThreshold) {\n          aControlledOtherPlayerScriptIns.activeDirection = { //任意一个值为0都不会改变方向\n            dx: 0,\n            dy: 0\n          };\n        } else {\n          if (toMoveByVecMag > toTeleportDisThreshold) { //如果移动过大 打印log但还是会移动\n            console.log(\"Player \", cachedPlayerData.id, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\n            aControlledOtherPlayerScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0\n            };\n            // TODO: Use `cc.Action`?\n            targetNode.setPosition(newPos);\n          } else {\n            // The common case which is suitable for interpolation.\n            const normalizedDir = {\n              dx: toMoveByVec.x / toMoveByVecMag,\n              dy: toMoveByVec.y / toMoveByVecMag,\n            };\n            aControlledOtherPlayerScriptIns.toMoveByVec = toMoveByVec;\n            aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\n\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n              aControlledOtherPlayerScriptIns.activeDirection = {\n                dx: 0,\n                dy: 0,\n              };\n            } else {\n              aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\n            }\n          }\n        }\n\n\n        if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\n          const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\n          aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\n        }\n\n        if (null != toRemovePlayerNodeDict[playerId]) {\n          delete toRemovePlayerNodeDict[playerId];\n        }\n\n\n      }\n\n      // 更新加速鞋显示 \n      for (let k in self.acceleratorInfoDict) {\n        const accLocalIdInBattle = parseInt(k);\n        const acceleratorInfo = self.acceleratorInfoDict[accLocalIdInBattle];\n        const newPos = cc.v2(\n          acceleratorInfo.x,\n          acceleratorInfo.y\n        );\n        let targetNode = self.acceleratorNodeDict[accLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.acceleratorPrefab);\n          self.acceleratorNodeDict[accLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n        if (null != toRemoveAcceleratorNodeDict[accLocalIdInBattle]) {\n          delete toRemoveAcceleratorNodeDict[accLocalIdInBattle];\n        }\n      }\n      // 更新陷阱显示 \n      for (let k in self.trapInfoDict) {\n        const trapLocalIdInBattle = parseInt(k);\n        const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\n        const newPos = cc.v2(\n          trapInfo.x,\n          trapInfo.y\n        );\n        let targetNode = self.trapNodeDict[trapLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.trapPrefab);\n          self.trapNodeDict[trapLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n        if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\n          delete toRemoveTrapNodeDict[trapLocalIdInBattle];\n        }\n      }\n\n      // 更新陷阱塔显示 \n      for (let k in self.guardTowerInfoDict) {\n        const trapLocalIdInBattle = parseInt(k);\n        const towerInfo = self.guardTowerInfoDict[trapLocalIdInBattle];\n        const newPos = cc.v2(\n          towerInfo.x,\n          towerInfo.y\n        );\n        let targetNode = self.towerNodeDict[trapLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.guardTowerPrefab);\n          self.towerNodeDict[trapLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n      }\n\n      // 更新bullet显示 \n      for (let k in self.trapBulletInfoDict) {\n        const bulletLocalIdInBattle = parseInt(k);\n        const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\n        const newPos = cc.v2(\n          bulletInfo.x,\n          bulletInfo.y\n        );\n        let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.trapBulletPrefab);\n\n          //kobako: 创建子弹node的时候设置旋转角度\n          targetNode.rotation = (() => {\n            if (null == bulletInfo.startAtPoint || null == bulletInfo.endAtPoint) {\n              console.error(`Init bullet direction error, startAtPoint:${startAtPoint}, endAtPoint:${endAtPoint}`);\n              return 0;\n            } else {\n\n              const dx = bulletInfo.endAtPoint.x - bulletInfo.startAtPoint.x;\n              const dy = bulletInfo.endAtPoint.y - bulletInfo.startAtPoint.y;\n              const radian = (() => {\n                if (dx == 0) {\n                  return Math.PI / 2;\n                } else {\n                  return Math.abs(Math.atan(dy / dx));\n                }\n              })();\n              const angleTemp = radian * 180 / Math.PI;\n              const angle = (() => {\n                if (dx >= 0) {\n                  if (dy >= 0) {\n                    //第一象限\n                    return 360 - angleTemp;\n                  //return angleTemp;\n                  } else {\n                    //第四象限\n                    return angleTemp;\n                  //return -angleTemp;\n                  }\n                } else {\n                  if (dy >= 0) {\n                    //第二象限\n                    return 360 - (180 - angleTemp);\n                  //return 180 - angleTemp;\n                  } else {\n                    //第三象限\n                    return 360 - (180 + angleTemp);\n                  //return 180 + angleTemp;\n                  }\n                }\n              })();\n              return angle;\n            }\n          })();\n          //\n\n          self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n        const aBulletScriptIns = targetNode.getComponent(\"Bullet\");\n        aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\n        aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \n\n        const oldPos = cc.v2(\n          targetNode.x,\n          targetNode.y,\n        );\n        const toMoveByVec = newPos.sub(oldPos);\n        const toMoveByVecMag = toMoveByVec.mag();\n        const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\n        const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\n        if (toMoveByVecMag < notToMoveDisThreshold) {\n          aBulletScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0,\n          };\n        } else {\n          if (toMoveByVecMag > toTeleportDisThreshold) {\n            console.log(\"Bullet \", bulletLocalIdInBattle, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\n            aBulletScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0\n            };\n            // TODO: Use `cc.Action`?\n            targetNode.setPosition(newPos);\n          } else {\n            // The common case which is suitable for interpolation.\n            const normalizedDir = {\n              dx: toMoveByVec.x / toMoveByVecMag,\n              dy: toMoveByVec.y / toMoveByVecMag,\n            };\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n              aBulletScriptIns.activeDirection = {\n                dx: 0,\n                dy: 0,\n              };\n            } else {\n              aBulletScriptIns.activeDirection = normalizedDir;\n            }\n          }\n        }\n        if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\n          delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\n        }\n      }\n\n      //更新南瓜少年的显示\n      for (let k in self.pumpkinInfoDict) {\n        const pumpkinLocalIdInBattle = parseInt(k);\n        const pumpkinInfo = self.pumpkinInfoDict[pumpkinLocalIdInBattle];\n        const newPos = cc.v2(pumpkinInfo.x, pumpkinInfo.y);\n        let targetNode = self.pumpkinNodeDict[pumpkinLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.pumpkinPrefab);\n          self.pumpkinNodeDict[pumpkinLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n        const aPumpkinScriptIns = targetNode.getComponent(\"Pumpkin\");\n        aPumpkinScriptIns.localIdInBattle = pumpkinLocalIdInBattle;\n        aPumpkinScriptIns.linearSpeed = pumpkinInfo.linearSpeed * 1000000000; // The `pumpkin.LinearSpeed` on server-side is denoted in pts/nanoseconds. \n\n        const oldPos = cc.v2(\n          targetNode.x,\n          targetNode.y,\n        );\n        const toMoveByVec = newPos.sub(oldPos);\n        const toMoveByVecMag = toMoveByVec.mag();\n        const toTeleportDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 100);\n        const notToMoveDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 0.5);\n        if (toMoveByVecMag < notToMoveDisThreshold) {\n          aPumpkinScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0,\n          };\n        } else {\n          if (toMoveByVecMag > toTeleportDisThreshold) {\n            console.log(\"Pumpkin \", pumpkinLocalIdInBattle, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\n            aPumpkinScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0\n            };\n            // TODO: Use `cc.Action`?\n            targetNode.setPosition(newPos);\n          } else {\n            // The common case which is suitable for interpolation.\n            const normalizedDir = {\n              dx: toMoveByVec.x / toMoveByVecMag,\n              dy: toMoveByVec.y / toMoveByVecMag,\n            };\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n              aPumpkinScriptIns.activeDirection = {\n                dx: 0,\n                dy: 0,\n              };\n            } else {\n              aPumpkinScriptIns.activeDirection = normalizedDir;\n            }\n          }\n        }\n        if (null != toRemovePumpkinNodeDict[pumpkinLocalIdInBattle]) {\n          delete toRemovePumpkinNodeDict[pumpkinLocalIdInBattle];\n        }\n      }\n\n      // 更新宝物显示 \n      for (let k in self.treasureInfoDict) {\n        const treasureLocalIdInBattle = parseInt(k);\n        const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\n        const newPos = cc.v2(\n          treasureInfo.x,\n          treasureInfo.y\n        );\n        let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\n        if (!targetNode) {\n          targetNode = cc.instantiate(self.treasurePrefab);\n          const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\n          treasureNodeScriptIns.setData(treasureInfo);\n          self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\n          safelyAddChild(mapNode, targetNode);\n          targetNode.setPosition(newPos);\n          setLocalZOrder(targetNode, 5);\n        }\n\n        if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\n          delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\n        }\n        if (0 < targetNode.getNumberOfRunningActions()) {\n          // A significant trick to smooth the position sync performance!\n          continue;\n        }\n        const oldPos = cc.v2(\n          targetNode.x,\n          targetNode.y\n        );\n        const toMoveByVec = newPos.sub(oldPos);\n        const durationSeconds = dt; // Using `dt` temporarily!\n        targetNode.runAction(cc.moveTo(durationSeconds, newPos));\n      }\n\n      // Coping with removed players.\n      for (let k in toRemovePlayerNodeDict) {\n        const playerId = parseInt(k);\n        toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\n        delete self.otherPlayerNodeDict[playerId];\n      }\n\n      // Coping with removed pumpkins.\n      for (let k in toRemovePumpkinNodeDict) {\n        const pumpkinLocalIdInBattle = parseInt(k);\n        toRemovePumpkinNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\n        delete self.pumpkinNodeDict[pumpkinLocalIdInBattle];\n      }\n\n      // Coping with removed treasures.\n      for (let k in toRemoveTreasureNodeDict) {\n        const treasureLocalIdInBattle = parseInt(k);\n        const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\n        treasureScriptIns.playPickedUpAnimAndDestroy();\n        if (self.musicEffectManagerScriptIns) {\n          if (2 == treasureScriptIns.type) {\n            self.musicEffectManagerScriptIns.playHighScoreTreasurePicked();\n          } else {\n            self.musicEffectManagerScriptIns.playTreasurePicked();\n          }\n        }\n        delete self.treasureNodeDict[treasureLocalIdInBattle];\n      }\n\n      // Coping with removed traps.\n      for (let k in toRemoveTrapNodeDict) {\n        const trapLocalIdInBattle = parseInt(k);\n        toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\n        delete self.trapNodeDict[trapLocalIdInBattle];\n      }\n\n      // Coping with removed accelerators.\n      for (let k in toRemoveAcceleratorNodeDict) {\n        const accLocalIdInBattle = parseInt(k);\n        toRemoveAcceleratorNodeDict[k].parent.removeChild(toRemoveAcceleratorNodeDict[k]);\n        delete self.acceleratorNodeDict[accLocalIdInBattle];\n      }\n\n      // Coping with removed bullets.\n      for (let k in toRemoveBulletNodeDict) {\n        const bulletLocalIdInBattle = parseInt(k);\n        toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\n        delete self.trapBulletNodeDict[bulletLocalIdInBattle];\n        if (self.musicEffectManagerScriptIns) {\n          self.musicEffectManagerScriptIns.playCrashedByTrapBullet();\n        }\n      }\n\n    } catch (err) {\n      console.warn(\"Map.update(dt)内发生了错误, 即将清空localStorage并回到登录页面\", err);\n      self.clearLocalStorageAndBackToLoginScene(true);\n    }\n\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const self = this;\n    const localClearance = () => {\n      self.clearLocalStorageAndBackToLoginScene(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\n    }\n\n    const selfPlayerStr = cc.sys.localStorage.getItem(\"selfPlayer\"); \n    if (null != selfPlayerStr) {\n      const selfPlayer = JSON.parse(selfPlayerStr);\n      const requestContent = {\n        intAuthToken: selfPlayer.intAuthToken\n      };\n      try {\n        NetworkUtils.ajax({\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n          type: \"POST\",\n          data: requestContent,\n          success: function(res) {\n            if (res.ret != constants.RET_CODE.OK) {\n              console.log(\"Logout failed: \", res);\n            }\n            localClearance();\n          },\n          error: function(xhr, status, errMsg) {\n            localClearance();\n          },\n          timeout: function() {\n            localClearance();\n          }\n        });\n      } catch (e) {} finally {\n        // For Safari (both desktop and mobile).\n        localClearance();\n      }\n    } else {\n      localClearance();\n    }\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.showPopupInCanvas(self.confirmLogoutNode);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n\n  onGameRule1v1ModeClicked(evt, cb) {\n    const self = this;\n    window.initPersistentSessionClient(self.initAfterWSConnected, null /* Deliberately NOT passing in any `expectedRoomId`. -- YFLu */);\n    self.hideGameRuleNode();\n  },\n\n  showPopupInCanvas(toShowNode) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\n    setLocalZOrder(toShowNode, 10);\n  },\n\n  playersMatched(players) {\n    console.log(\"Calling `playersMatched`\", players);\n\n    const self = this;\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.updatePlayersInfo(players);\n    window.setTimeout(() => {\n      if (self.findingPlayerNode.parent) {\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\n        self.transitToState(ALL_MAP_STATES.VISUAL);\n        for (let i in players) {\n          //更新在线玩家信息面板的信息\n          const playerInfo = players[i];\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n          playersScriptIns.updateData(playerInfo);\n        }\n      }\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\");\n      countDownScriptIns.setData();\n      self.showPopupInCanvas(self.countdownToBeginGameNode);\n      return;\n    }, 2000);\n  },\n\n});\n"]}