{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","pumpkinPrefab","treasurePrefab","trapPrefab","acceleratorPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","guardTowerPrefab","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","speedShoes","pumpkin","guardTowers","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","pumpkinsLocalIdStrList","pumpkinLocalIdInBattle","treasuresLocalIdStrList","treasureLocalIdInBattle","speedShoesLocalIdStrList","speedShoesLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","log","accs","accsLocalIdStrList","accLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","resyncing","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onDestroy","battleState","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleRoomDownsyncFrame","upsyncLoopInterval","clearInterval","inputControlTimer","_lazilyTriggerResync","state","resyncingHintPopup","popupSimplePressToGo","t","_onResyncCompleted","parent","removeChild","labelString","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","string","once","dismissDialog","bind","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","playersNode","Animation","play","start","active","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","pumpkinNodeDict","acceleratorNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","pumpkinInfoDict","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","towerNodeDict","findingPlayerNode","findingPlayerScriptIns","showPopopInCanvas","gameRuleNode","playersInfoNode","onLoad","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","musicEffectManagerScriptIns","confirmLogoutNode","resultPanelNode","resultPanelScriptIns","mapScriptIns","onAgainClicked","shouldReconnectState","sys","localStorage","clientSession","readyState","WebSocket","OPEN","initPersistentSessionClient","initAfterWSConncted","closeWSConnection","gameRuleScriptIns","width","height","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","sizeInMapNode","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","handleClientSessionCloseOrError","removeItem","parse","selfPlayer","_inputControlEnabled","setupInputControls","console","refFrameId","matchPlayersFinsihed","initWxSdk","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","speed","score","joinIndex","anotherPlayer","pumpkinInfo","treasureInfo","acceleratorInfoDict","accelartors","accLocalIdStrList","accInfo","trapInfo","bulletInfo","guardTowerInfoDict","ids","localIdInBattle","tower","onBattleStarted","expectedRoomId","qDict","getQueryParamDict","history","boundRoomId","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","playBGM","spawnSelfPlayer","stopAllMusic","showPlayerInfo","clearInfo","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","playersScriptIns","updateData","updateSpeed","toRemoveAcceleratorNodeDict","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemovePumpkinNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","acceleratorInfo","towerInfo","aBulletScriptIns","linearSpeed","aPumpkinScriptIns","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","playHighScoreTreasurePicked","playTreasurePicked","playCrashedByTrapBullet","s","byClick","localClearance","loadScene","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","error","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","initWSConnection","cb","toShowNode","playerInfo","countDownScriptIns"],"mappings":"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","file":"Map.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\n\r\nwindow.ALL_MAP_STATES = {\r\n  VISUAL: 0, // For free dragging & zooming.\r\n  EDITING_BELONGING: 1,\r\n  SHOWING_MODAL_POPUP: 2,\r\n};\r\n\r\nwindow.ALL_BATTLE_STATES = {\r\n  WAITING: 0,\r\n  IN_BATTLE: 1,\r\n  IN_SETTLEMENT: 2,\r\n  IN_DISMISSAL: 3,\r\n};\r\n\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    useDiffFrameAlgo: {\r\n      default: true\r\n    },\r\n    canvasNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    tiledAnimPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player1Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player2Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    pumpkinPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    treasurePrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    trapPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    acceleratorPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    barrierPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterZReducerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    keyboardInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    joystickInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    confirmLogoutPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    simplePressToGoDialogPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    boundRoomIdLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    countdownLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    trapBulletPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    resultPanelPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    gameRulePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    findingPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    countdownToBeginGamePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    playersInfoPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    guardTowerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n  },\r\n\r\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\r\n\r\n    let newFullFrame = {\r\n      id: diffFrame.id,\r\n      treasures: refFullFrame.treasures,\r\n      traps: refFullFrame.traps,\r\n      bullets: refFullFrame.bullets,\r\n      players: refFullFrame.players,\r\n      speedShoes: refFullFrame.speedShoes,\r\n      pumpkin: refFullFrame.pumpkin,\r\n      guardTowers: refFullFrame.guardTowers, //TODO: 根据diffFrame信息增删或者移动守护塔\r\n    };\r\n    const players = diffFrame.players;\r\n    const playersLocalIdStrList = Object.keys(players);\r\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\r\n      const k = playersLocalIdStrList[i];\r\n      const playerId = parseInt(k);\r\n      if (true == diffFrame.players[playerId].removed) {\r\n        // cc.log(`Player id == ${playerId} is removed.`);\r\n        delete newFullFrame.players[playerId];\r\n      } else {\r\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\r\n      }\r\n    }\r\n\r\n    const pumpkin = diffFrame.pumpkin;\r\n    const pumpkinsLocalIdStrList = Object.keys(pumpkin);\r\n    for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\r\n      const k = pumpkinsLocalIdStrList[i];\r\n      const pumpkinLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.pumpkin[pumpkinLocalIdInBattle].removed) {\r\n        delete newFullFrame.pumpkin[pumpkinLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.pumpkin[pumpkinLocalIdInBattle] = diffFrame.pumpkin[pumpkinLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const treasures = diffFrame.treasures;\r\n    const treasuresLocalIdStrList = Object.keys(treasures);\r\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n      const k = treasuresLocalIdStrList[i];\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\r\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const speedShoes = diffFrame.speedShoes;\r\n    const speedShoesLocalIdStrList = Object.keys(speedShoes);\r\n    for (let i = 0; i < speedShoesLocalIdStrList.length; ++i) {\r\n      const k = speedShoesLocalIdStrList[i];\r\n      const speedShoesLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.speedShoes[speedShoesLocalIdInBattle].removed) {\r\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.speedShoes[speedShoesLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.speedShoes[speedShoesLocalIdInBattle] = diffFrame.speedShoes[speedShoesLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const traps = diffFrame.traps;\r\n    const trapsLocalIdStrList = Object.keys(traps);\r\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n      const k = trapsLocalIdStrList[i];\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\r\n        // cc.log(`Trap with localIdInBattle == ${trapLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.traps[trapLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const bullets = diffFrame.bullets;\r\n    const bulletsLocalIdStrList = Object.keys(bullets);\r\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n      const k = bulletsLocalIdStrList[i];\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\r\n        cc.log(`Bullet with localIdInBattle == ${bulletLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const accs = diffFrame.speedShoes;\r\n    const accsLocalIdStrList = Object.keys(accs);\r\n    for (let i = 0; i < accsLocalIdStrList.length; ++i) {\r\n      const k = accsLocalIdStrList[i];\r\n      const accLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.speedShoes[accLocalIdInBattle].removed) {\r\n        delete newFullFrame.speedShoes[accLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.speedShoes[accLocalIdInBattle] = diffFrame.speedShoes[accLocalIdInBattle];\r\n      }\r\n    }\r\n    return newFullFrame;\r\n  },\r\n\r\n  _dumpToFullFrameCache: function(fullFrame) {\r\n    const self = this;\r\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\r\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\r\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\r\n      // cc.log(\"toDelFrameId is \" + toDelFrameId + \".\");\r\n      delete self.recentFrameCache[toDelFrameId];\r\n      --self.recentFrameCacheCurrentSize;\r\n    }\r\n    self.recentFrameCache[fullFrame.id] = fullFrame;\r\n    ++self.recentFrameCacheCurrentSize;\r\n  },\r\n\r\n  _onPerUpsyncFrame() {\r\n    const instance = this;\r\n    if (instance.resyncing) return;\r\n    if (\r\n      null == instance.selfPlayerInfo ||\r\n      null == instance.selfPlayerScriptIns ||\r\n      null == instance.selfPlayerScriptIns.scheduledDirection\r\n      ) return;\r\n    const upsyncFrameData = {\r\n      id: instance.selfPlayerInfo.id,\r\n      /**\r\n      * WARNING\r\n      *\r\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\r\n      */\r\n      dir: {\r\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\r\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\r\n      },\r\n      x: parseFloat(instance.selfPlayerNode.x),\r\n      y: parseFloat(instance.selfPlayerNode.y),\r\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\r\n    };\r\n    const wrapped = {\r\n      msgId: Date.now(),\r\n      act: \"PlayerUpsyncCmd\",\r\n      data: upsyncFrameData,\r\n    }\r\n    window.sendSafely(JSON.stringify(wrapped));\r\n  },\r\n\r\n  onDestroy() {\r\n    const self = this;\r\n    if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    }\r\n    if (null != window.handleRoomDownsyncFrame) {\r\n      window.handleRoomDownsyncFrame = null;\r\n    }\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n    if (self.inputControlTimer) {\r\n      clearInterval(self.inputControlTimer)\r\n    }\r\n  },\r\n\r\n  _lazilyTriggerResync() {\r\n    if (true == this.resyncing) return;\r\n    this.resyncing = true;\r\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\r\n      if (null == this.resyncingHintPopup) {\r\n        this.resyncingHintPopup = this.popupSimplePressToGo(i18n.t(\"gameTip.resyncing\"));\r\n      }\r\n    }\r\n  },\r\n\r\n  _onResyncCompleted() {\r\n    if (false == this.resyncing) return;\r\n    cc.log(`_onResyncCompleted`);\r\n    this.resyncing = false;\r\n    if (null != this.resyncingHintPopup && this.resyncingHintPopup.parent) {\r\n      this.resyncingHintPopup.parent.removeChild(this.resyncingHintPopup);\r\n    }\r\n  },\r\n\r\n  popupSimplePressToGo(labelString) {\r\n    const self = this;\r\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\r\n\r\n    const canvasNode = self.canvasNode;\r\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\r\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\r\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\r\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\r\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\r\n    const postDismissalByYes = () => {\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      canvasNode.removeChild(simplePressToGoDialogNode);\r\n    }\r\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\r\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\r\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\r\n    setLocalZOrder(simplePressToGoDialogNode, 20);\r\n    return simplePressToGoDialogNode;\r\n  },\r\n\r\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const millisToGo = 3000;\r\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\r\n    setTimeout(() => {\r\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\r\n    }, millisToGo);\r\n  },\r\n\r\n  _resetCurrentMatch() {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    self.countdownLabel.string = \"\";\r\n    if (self.playersNode) {\r\n      for (let i in self.playersNode) {\r\n        let node = self.playersNode[i];\r\n        node.getComponent(cc.Animation).play(\"Bottom\");\r\n        node.getComponent(\"SelfPlayer\").start();\r\n        node.active = true;\r\n      }\r\n    }\r\n    if (self.otherPlayerNodeDict) {\r\n      for (let i in self.otherPlayerNodeDict) {\r\n        let node = self.otherPlayerNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\r\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\r\n    }\r\n    if (self.treasureNodeDict) {\r\n      for (let i in self.treasureNodeDict) {\r\n        let node = self.treasureNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.trapBulletNodeDict) {\r\n      for (let i in self.trapBulletNodeDict) {\r\n        let node = self.trapBulletNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.trapNodeDict) {\r\n      for (let i in self.trapNodeDict) {\r\n        let node = self.trapNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.pumpkinNodeDict) {\r\n      for (let i in self.pumpkinNodeDict) {\r\n        let node = self.pumpkinNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.acceleratorNodeDict) {\r\n      for (let i in self.acceleratorNodeDict) {\r\n        let node = self.acceleratorNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n\r\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\r\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\r\n    for (let child of self.mainCameraNode.children) {\r\n      child.setScale(1 / self.mainCamera.zoomRatio);\r\n    }\r\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\r\n    self.mainCameraNode.setPosition(cc.v2());\r\n\r\n    self.resyncing = false;\r\n    self.lastRoomDownsyncFrameId = 0;\r\n\r\n    self.recentFrameCache = {};\r\n    self.recentFrameCacheCurrentSize = 0;\r\n    self.recentFrameCacheMaxCount = 2048;\r\n    self.selfPlayerNode = null;\r\n    self.selfPlayerScriptIns = null;\r\n    self.selfPlayerInfo = null;\r\n    self.upsyncLoopInterval = null;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n\r\n    self.battleState = ALL_BATTLE_STATES.WAITING;\r\n\r\n    self.pumpkinInfoDict = {};\r\n    self.pumpkinNodeDict = {};\r\n    self.otherPlayerCachedDataDict = {};\r\n    self.otherPlayerNodeDict = {};\r\n    self.treasureInfoDict = {};\r\n    self.treasureNodeDict = {};\r\n    self.trapInfoDict = {};\r\n    self.trapBulletInfoDict = {};\r\n    self.trapBulletNodeDict = {};\r\n    self.trapNodeDict = {};\r\n    self.towerNodeDict = {};\r\n    self.acceleratorNodeDict = {};\r\n    if (self.findingPlayerNode) {\r\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n      findingPlayerScriptIns.init();\r\n    }\r\n    self.showPopopInCanvas(self.gameRuleNode);\r\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\r\n  },\r\n\r\n  onLoad() {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    cc.director.getCollisionManager().enabled = true;\r\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\r\n    self.musicEffectManagerScriptIns = self.node.getComponent(\"MusicEffectManager\");\r\n\r\n    /** init requeired prefab started */\r\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\r\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\r\n\r\n    //Result panel init\r\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\r\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.mapScriptIns = self;\r\n    resultPanelScriptIns.onAgainClicked = () => {\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      self._resetCurrentMatch();\r\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState);\r\n      switch (shouldReconnectState) {\r\n        case 2:\r\n        case 1:\r\n          // Clicking too fast?\r\n          return;\r\n        default:\r\n          break;\r\n      }\r\n\r\n      if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) {\r\n        // Already disconnected. \r\n        cc.log(\"Ws session is already closed when `again/replay` button is clicked. Reconnecting now.\");\r\n        window.initPersistentSessionClient(self.initAfterWSConncted);\r\n      } else {\r\n        // Should disconnect first and reconnect within `window.handleClientSessionCloseOrError`. \r\n        cc.log(\"Ws session is not closed yet when `again/replay` button is clicked, closing the ws session now.\");\r\n        cc.sys.localStorage.shouldReconnectState = 2;\r\n        window.closeWSConnection();\r\n      }\r\n    };\r\n\r\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\r\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\r\n    self.gameRuleScriptIns.mapNode = self.node;\r\n\r\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\r\n    self.findingPlayerNode.width = self.canvasNode.width;\r\n    self.findingPlayerNode.height = self.canvasNode.height;\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.init();\r\n\r\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\r\n\r\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\r\n\r\n    self.playersNode = {};\r\n    const player1Node = cc.instantiate(self.player1Prefab);\r\n    const player2Node = cc.instantiate(self.player2Prefab);\r\n    Object.assign(self.playersNode, {\r\n      1: player1Node\r\n    });\r\n    Object.assign(self.playersNode, {\r\n      2: player2Node\r\n    });\r\n\r\n    /** init requeired prefab ended */\r\n\r\n    self.clientUpsyncFps = 20;\r\n    self._resetCurrentMatch();\r\n\r\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\r\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\r\n    for (let frameAnim of boundaryObjs.frameAnimations) {\r\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\r\n      const anim = animNode.getComponent(cc.Animation);\r\n      animNode.setPosition(frameAnim.posInMapNode);\r\n      animNode.width = frameAnim.sizeInMapNode.width;\r\n      animNode.height = frameAnim.sizeInMapNode.height;\r\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\r\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\r\n      safelyAddChild(self.node, animNode);\r\n      setLocalZOrder(animNode, 5);\r\n      anim.addClip(frameAnim.animationClip, \"default\");\r\n      anim.play(\"default\");\r\n    }\r\n\r\n    self.barrierColliders = [];\r\n    for (let boundaryObj of boundaryObjs.barriers) {\r\n      const newBarrier = cc.instantiate(self.barrierPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\r\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\r\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\r\n      newBarrierColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.barrierColliders.push(newBarrierColliderIns);\r\n      self.node.addChild(newBarrier);\r\n    }\r\n    const allLayers = tiledMapIns.getLayers();\r\n    for (let layer of allLayers) {\r\n      const layerType = layer.getProperty(\"type\");\r\n      switch (layerType) {\r\n        case \"normal\":\r\n          setLocalZOrder(layer.node, 0);\r\n          break;\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(layer.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    const allObjectGroups = tiledMapIns.getObjectGroups();\r\n    for (let objectGroup of allObjectGroups) {\r\n      const objectGroupType = objectGroup.getProperty(\"type\");\r\n      switch (objectGroupType) {\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(objectGroup.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\r\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\r\n      newShelter.setAnchorPoint(cc.v2(0, 0));\r\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\r\n      newShelterColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.node.addChild(newShelter);\r\n    }\r\n\r\n    window.handleClientSessionCloseOrError = function() {\r\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState);\r\n      switch (shouldReconnectState) {\r\n        case 2:\r\n          shouldReconnectState = 1;\r\n          cc.sys.localStorage.shouldReconnectState = shouldReconnectState;\r\n          cc.log(\"Reconnecting because 2 == shouldReconnectState and it's now set to 1.\");\r\n          window.initPersistentSessionClient(self.initAfterWSConncted);\r\n          return;\r\n        case 1:\r\n          cc.log(\"Neither reconnecting nor alerting because 1 == shouldReconnectState and it's now removed.\");\r\n          cc.sys.localStorage.removeItem(\"shouldReconnectState\");\r\n          return;\r\n        default:\r\n          break;\r\n      }\r\n      if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n        self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\r\n      }\r\n    };\r\n\r\n    self.initAfterWSConncted = () => {\r\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      Object.assign(self.selfPlayerInfo, {\r\n        id: self.selfPlayerInfo.playerId\r\n      });\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      self._inputControlEnabled = false;\r\n      self.setupInputControls();\r\n\r\n\r\n      window.handleRoomDownsyncFrame = function(diffFrame) {\r\n        if(diffFrame.id < 10){\r\n          console.log(diffFrame);\r\n        }\r\n\r\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\r\n        const refFrameId = diffFrame.refFrameId;\r\n        if (-99 == refFrameId) { //显示倒计时\r\n          self.matchPlayersFinsihed(diffFrame.players);\r\n        } else if (-98 == refFrameId) { //显示匹配玩家\r\n          if (window.initWxSdk) {\r\n            window.initWxSdk();\r\n          }\r\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n          if (!self.findingPlayerNode.parent) {\r\n            self.showPopopInCanvas(self.findingPlayerNode);\r\n          }\r\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.players);\r\n          return;\r\n        }\r\n\r\n        //根据downFrame显示游戏场景\r\n\r\n        const frameId = diffFrame.id;\r\n        if (frameId <= self.lastRoomDownsyncFrameId) {\r\n          // Log the obsolete frames?\r\n          return;\r\n        }\r\n        const isInitiatingFrame = (0 > self.recentFrameCacheCurrentSize || 0 == refFrameId);\r\n        /*\r\n        if (frameId % 300 == 0) {\r\n          // WARNING: For testing only!\r\n          if (0 < frameId) {\r\n            self._lazilyTriggerResync(); \r\n          }\r\n          cc.log(`${JSON.stringify(diffFrame)}`);\r\n        }\r\n        */\r\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\r\n        if (\r\n          !isInitiatingFrame\r\n          && self.useDiffFrameAlgo\r\n          && (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\". \r\n          && null == cachedFullFrame\r\n        ) { //重连后重新同步\r\n          self._lazilyTriggerResync();\r\n          // Later incoming diffFrames will all suffice that `0 < self.recentFrameCacheCurrentSize && null == cachedFullFrame`, until `this._onResyncCompleted` is successfully invoked.\r\n          return;\r\n        }\r\n\r\n        if (isInitiatingFrame && 0 == refFrameId) {\r\n          // Reaching here implies that you've received the resync frame.\r\n          self._onResyncCompleted();\r\n        }\r\n        let countdownNanos = diffFrame.countdownNanos;\r\n        if (countdownNanos < 0)\r\n          countdownNanos = 0;\r\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\r\n        if (isNaN(countdownSeconds)) {\r\n          cc.log(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\r\n        }\r\n        // if(self.musicEffectManagerScriptIns && 10 == countdownSeconds ) {\r\n        //   self.musicEffectManagerScriptIns.playCountDown10SecToEnd();\r\n        // }\r\n        self.countdownLabel.string = countdownSeconds;\r\n        const roomDownsyncFrame = ( //根据refFrameId和diffFrame计算出新的一帧\r\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\r\n          ?\r\n          diffFrame\r\n          :\r\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\r\n        );\r\n\r\n\r\n        if (countdownNanos <= 0) {\r\n          self.onBattleStopped(roomDownsyncFrame.players);\r\n          return;\r\n        }\r\n        self._dumpToFullFrameCache(roomDownsyncFrame);\r\n        const sentAt = roomDownsyncFrame.sentAt;\r\n\r\n\r\n        //update players Info\r\n        const players = roomDownsyncFrame.players;\r\n        const playerIdStrList = Object.keys(players);\r\n        self.otherPlayerCachedDataDict = {};\r\n        for (let i = 0; i < playerIdStrList.length; ++i) {\r\n          const k = playerIdStrList[i];\r\n          const playerId = parseInt(k);\r\n          if (playerId == self.selfPlayerInfo.id) {\r\n            const immediateSelfPlayerInfo = players[k];\r\n            Object.assign(self.selfPlayerInfo, {\r\n              x: immediateSelfPlayerInfo.x,\r\n              y: immediateSelfPlayerInfo.y,\r\n              speed: immediateSelfPlayerInfo.speed,\r\n              battleState: immediateSelfPlayerInfo.battleState,\r\n              score: immediateSelfPlayerInfo.score,\r\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\r\n            });\r\n            continue;\r\n          }\r\n          const anotherPlayer = players[k];\r\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\r\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\r\n        }\r\n\r\n        //update pumpkin Info \r\n        self.pumpkinInfoDict = {};\r\n        const pumpkin = roomDownsyncFrame.pumpkin;\r\n        const pumpkinsLocalIdStrList = Object.keys(pumpkin);\r\n        for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\r\n          const k = pumpkinsLocalIdStrList[i];\r\n          const pumpkinLocalIdInBattle = parseInt(k);\r\n          const pumpkinInfo = pumpkin[k];\r\n          self.pumpkinInfoDict[pumpkinLocalIdInBattle] = pumpkinInfo;\r\n        }\r\n        \r\n\r\n        //update treasureInfoDict\r\n        self.treasureInfoDict = {};\r\n        const treasures = roomDownsyncFrame.treasures;\r\n        const treasuresLocalIdStrList = Object.keys(treasures);\r\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) { //直接根据最新帧的数据覆盖掉treasureInfoDict\r\n          const k = treasuresLocalIdStrList[i];\r\n          const treasureLocalIdInBattle = parseInt(k);\r\n          const treasureInfo = treasures[k];\r\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\r\n        }\r\n\r\n        //update acceleratorInfoDict\r\n        self.acceleratorInfoDict = {};\r\n        const accelartors = roomDownsyncFrame.speedShoes;\r\n        const accLocalIdStrList = Object.keys(accelartors);\r\n        for (let i = 0; i < accLocalIdStrList.length; ++i) {\r\n          const k = accLocalIdStrList[i];\r\n          const accLocalIdInBattle = parseInt(k);\r\n          const accInfo = accelartors[k];\r\n          self.acceleratorInfoDict[accLocalIdInBattle] = accInfo;\r\n        }\r\n\r\n        //update trapInfoDict\r\n        self.trapInfoDict = {};\r\n        const traps = roomDownsyncFrame.traps;\r\n        const trapsLocalIdStrList = Object.keys(traps);\r\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n          const k = trapsLocalIdStrList[i];\r\n          const trapLocalIdInBattle = parseInt(k);\r\n          const trapInfo = traps[k];\r\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\r\n        }\r\n\r\n        self.trapBulletInfoDict = {};\r\n        const bullets = roomDownsyncFrame.bullets;\r\n        const bulletsLocalIdStrList = Object.keys(bullets);\r\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n          const k = bulletsLocalIdStrList[i];\r\n          const bulletLocalIdInBattle = parseInt(k);\r\n          const bulletInfo = bullets[k];\r\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\r\n        }\r\n\r\n        //update guardTowerInfoDict\r\n        self.guardTowerInfoDict = {};\r\n        const guardTowers = roomDownsyncFrame.guardTowers;\r\n        const ids = Object.keys(guardTowers);\r\n        for (let i = 0; i < ids.length; ++i) {\r\n          const id = ids[i];\r\n          const localIdInBattle = parseInt(id);\r\n          const tower = guardTowers[id];\r\n          self.guardTowerInfoDict[localIdInBattle] = tower;\r\n        }\r\n\r\n\r\n        if (0 == self.lastRoomDownsyncFrameId) {\r\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\r\n          if (1 == frameId) {\r\n            // No need to prompt upon rejoined.\r\n            self.popupSimplePressToGo(i18n.t(\"gameTip.start\"));\r\n          }\r\n          self.onBattleStarted();\r\n        }\r\n        self.lastRoomDownsyncFrameId = frameId;\r\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\r\n      };\r\n    }\r\n\r\n    /*\r\n    * The following code snippet is a dirty fix.\r\n    */\r\n    let expectedRoomId = null;\r\n    const qDict = window.getQueryParamDict();\r\n    if (qDict) {\r\n      expectedRoomId = qDict[\"expectedRoomId\"];\r\n    } else {\r\n      if (window.history && window.history.state) {\r\n        expectedRoomId = window.history.state.expectedRoomId;\r\n      }\r\n    }\r\n    if (expectedRoomId) {\r\n      self.gameRuleNode.active = false;\r\n      window.initPersistentSessionClient(self.initAfterWSConncted);\r\n      return;\r\n    } else {\r\n      if (cc.sys.localStorage.boundRoomId) {\r\n        self.gameRuleNode.active = false;\r\n        window.initPersistentSessionClient(self.initAfterWSConncted);\r\n        return;\r\n      }\r\n    }\r\n  },\r\n\r\n  setupInputControls() {\r\n    const instance = this;\r\n    const mapNode = instance.node;\r\n    const canvasNode = mapNode.parent;\r\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\r\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\r\n\r\n    const ctrl = joystickInputControllerScriptIns;\r\n    instance.ctrl = ctrl;\r\n\r\n    instance.inputControlTimer = setInterval(function() {\r\n      if (false == instance._inputControlEnabled) return;\r\n      instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\r\n    }, inputControlPollerMillis);\r\n  },\r\n\r\n  enableInputControls() {\r\n    this._inputControlEnabled = true;\r\n  },\r\n\r\n  disableInputControls() {\r\n    this._inputControlEnabled = false;\r\n  },\r\n\r\n  onBattleStarted() {\r\n    const self = this;\r\n    if (self.musicEffectManagerScriptIns)\r\n      self.musicEffectManagerScriptIns.playBGM();\r\n    const canvasNode = self.canvasNode;\r\n    self.spawnSelfPlayer();\r\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    self.enableInputControls();\r\n    if (self.countdownToBeginGameNode.parent) {\r\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    }\r\n  },\r\n\r\n  onBattleStopped(players) {\r\n    const self = this;\r\n    if (self.musicEffectManagerScriptIns) {\r\n      self.musicEffectManagerScriptIns.stopAllMusic();\r\n    }\r\n    const canvasNode = self.canvasNode;\r\n    const resultPanelNode = self.resultPanelNode;\r\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.showPlayerInfo(players);\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage(); //清除cached boundRoomId\r\n    // Such that it doesn't execute \"update(dt)\" anymore. \r\n    self.selfPlayerNode.active = false;\r\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\r\n    self.showPopopInCanvas(resultPanelNode);\r\n\r\n    //clear player info\r\n    self.playersInfoNode.getComponent(\"PlayersInfo\").clearInfo();\r\n  },\r\n\r\n  spawnSelfPlayer() {\r\n    const instance = this;\r\n    const joinIndex = this.selfPlayerInfo.joinIndex;\r\n    const newPlayerNode = this.playersNode[joinIndex];\r\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\r\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\r\n    newPlayerNode.setPosition(toStartWithPos);\r\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\r\n\r\n    instance.node.addChild(newPlayerNode);\r\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\r\n    instance.selfPlayerScriptIns.showArrowTipNode();\r\n\r\n    setLocalZOrder(newPlayerNode, 5);\r\n    instance.selfPlayerNode = newPlayerNode;\r\n  },\r\n\r\n  update(dt) {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    const canvasParentNode = canvasNode.parent;\r\n    if (null != window.boundRoomId) {\r\n      self.boundRoomIdLabel.string = window.boundRoomId;\r\n    }\r\n    if (null != self.selfPlayerInfo) {\r\n      const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n      playersScriptIns.updateData(self.selfPlayerInfo);\r\n      if (null != self.selfPlayerScriptIns) {\r\n        self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\r\n      }\r\n    }\r\n\r\n    let toRemoveAcceleratorNodeDict = {};\r\n    Object.assign(toRemoveAcceleratorNodeDict, self.acceleratorNodeDict);\r\n\r\n    let toRemovePlayerNodeDict = {};\r\n    Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\r\n\r\n    let toRemoveTreasureNodeDict = {};\r\n    Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\r\n\r\n    let toRemoveTrapNodeDict = {};\r\n    Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\r\n\r\n    let toRemovePumpkinNodeDict = {};\r\n    Object.assign(toRemovePumpkinNodeDict, self.pumpkinNodeDict);\r\n\r\n    /*\r\n    * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\r\n    */\r\n    let toRemoveBulletNodeDict = {};\r\n    Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\r\n\r\n    for (let k in self.otherPlayerCachedDataDict) {\r\n      const playerId = parseInt(k);\r\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\r\n      const newPos = cc.v2(\r\n        cachedPlayerData.x,\r\n        cachedPlayerData.y\r\n      );\r\n\r\n      //更新玩家信息展示\r\n      if (null != cachedPlayerData) {\r\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n        playersScriptIns.updateData(cachedPlayerData);\r\n      }\r\n      let targetNode = self.otherPlayerNodeDict[playerId];\r\n      if (!targetNode) {\r\n        targetNode = self.playersNode[cachedPlayerData.joinIndex];\r\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\r\n        self.otherPlayerNodeDict[playerId] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\r\n      aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\r\n\r\n\r\n\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\r\n      const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\r\n      //const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\r\n      const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 1.0);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) { \r\n        aControlledOtherPlayerScriptIns.activeDirection = { //任意一个值为0都不会改变方向\r\n          dx: 0,\r\n          dy: 0\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag > toTeleportDisThreshold) { //如果移动过大 打印log但还是会移动\r\n          cc.log(`Player ${cachedPlayerData.id} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          aControlledOtherPlayerScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          aControlledOtherPlayerScriptIns.toMoveByVec = toMoveByVec;\r\n          aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\r\n\r\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n            aControlledOtherPlayerScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0,\r\n            };\r\n          } else {\r\n            aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\r\n          }\r\n        }\r\n      }\r\n\r\n\r\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\r\n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\r\n        //console.log(newScheduledDirection);\r\n        aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\r\n      }\r\n\r\n      if (null != toRemovePlayerNodeDict[playerId]) {\r\n        delete toRemovePlayerNodeDict[playerId];\r\n      }\r\n\r\n\r\n    }\r\n\r\n    // 更新加速鞋显示 \r\n    for (let k in self.acceleratorInfoDict) {\r\n      const accLocalIdInBattle = parseInt(k);\r\n      const acceleratorInfo = self.acceleratorInfoDict[accLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        acceleratorInfo.x,\r\n        acceleratorInfo.y\r\n      );\r\n      let targetNode = self.acceleratorNodeDict[accLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.acceleratorPrefab);\r\n        self.acceleratorNodeDict[accLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      if (null != toRemoveAcceleratorNodeDict[accLocalIdInBattle]) {\r\n        delete toRemoveAcceleratorNodeDict[accLocalIdInBattle];\r\n      }\r\n    }\r\n    // 更新陷阱显示 \r\n    for (let k in self.trapInfoDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        trapInfo.x,\r\n        trapInfo.y\r\n      );\r\n      let targetNode = self.trapNodeDict[trapLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapPrefab);\r\n        self.trapNodeDict[trapLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\r\n        delete toRemoveTrapNodeDict[trapLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    // 更新陷阱塔显示 \r\n    for (let k in self.guardTowerInfoDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      const towerInfo = self.guardTowerInfoDict[trapLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        towerInfo.x,\r\n        towerInfo.y\r\n      );\r\n      let targetNode = self.towerNodeDict[trapLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.guardTowerPrefab);\r\n        self.towerNodeDict[trapLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n    }\r\n\r\n    // 更新bullet显示 \r\n    for (let k in self.trapBulletInfoDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        bulletInfo.x,\r\n        bulletInfo.y\r\n      );\r\n      let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapBulletPrefab);\r\n        self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      const aBulletScriptIns = targetNode.getComponent(\"Bullet\");\r\n      aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\r\n      aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \r\n\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y,\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\r\n      const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) {\r\n        aBulletScriptIns.activeDirection = {\r\n          dx: 0,\r\n          dy: 0,\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag > toTeleportDisThreshold) {\r\n          cc.log(`Bullet ${bulletLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          aBulletScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n            aBulletScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0,\r\n            };\r\n          } else {\r\n            aBulletScriptIns.activeDirection = normalizedDir;\r\n          }\r\n        }\r\n      }\r\n      if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\r\n        delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    //更新南瓜少年的显示\r\n    for (let k in self.pumpkinInfoDict) {\r\n      const pumpkinLocalIdInBattle = parseInt(k);\r\n      const pumpkinInfo = self.pumpkinInfoDict[pumpkinLocalIdInBattle];\r\n      const newPos = cc.v2(pumpkinInfo.x, pumpkinInfo.y);\r\n      let targetNode = self.pumpkinNodeDict[pumpkinLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.pumpkinPrefab);\r\n        self.pumpkinNodeDict[pumpkinLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      const aPumpkinScriptIns = targetNode.getComponent(\"Pumpkin\");\r\n      aPumpkinScriptIns.localIdInBattle = pumpkinLocalIdInBattle;\r\n      aPumpkinScriptIns.linearSpeed = pumpkinInfo.linearSpeed * 1000000000; // The `pumpkin.LinearSpeed` on server-side is denoted in pts/nanoseconds. \r\n\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y,\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      const toTeleportDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 100);\r\n      const notToMoveDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 0.5);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) {\r\n        aPumpkinScriptIns.activeDirection = {\r\n          dx: 0,\r\n          dy: 0,\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag > toTeleportDisThreshold) {\r\n          cc.log(`Pumpkin ${pumpkinLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          aPumpkinScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n            aPumpkinScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0,\r\n            };\r\n          } else {\r\n            aPumpkinScriptIns.activeDirection = normalizedDir;\r\n          }\r\n        }\r\n      }\r\n      if (null != toRemovePumpkinNodeDict[pumpkinLocalIdInBattle]) {\r\n        delete toRemovePumpkinNodeDict[pumpkinLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    // 更新宝物显示 \r\n    for (let k in self.treasureInfoDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        treasureInfo.x,\r\n        treasureInfo.y\r\n      );\r\n      let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.treasurePrefab);\r\n        const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\r\n        treasureNodeScriptIns.setData(treasureInfo);\r\n        self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n\r\n      if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\r\n        delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\r\n      }\r\n      if (0 < targetNode.getNumberOfRunningActions()) {\r\n        // A significant trick to smooth the position sync performance!\r\n        continue;\r\n      }\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const durationSeconds = dt; // Using `dt` temporarily!\r\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\r\n    }\r\n\r\n    // Coping with removed players.\r\n    for (let k in toRemovePlayerNodeDict) {\r\n      const playerId = parseInt(k);\r\n      toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n      delete self.otherPlayerNodeDict[playerId];\r\n    }\r\n\r\n    // Coping with removed pumpkins.\r\n    for (let k in toRemovePumpkinNodeDict) {\r\n      const pumpkinLocalIdInBattle = parseInt(k);\r\n      toRemovePumpkinNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n      delete self.pumpkinNodeDict[pumpkinLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed treasures.\r\n    for (let k in toRemoveTreasureNodeDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\r\n      treasureScriptIns.playPickedUpAnimAndDestroy();\r\n      if (self.musicEffectManagerScriptIns) {\r\n        if (2 == treasureScriptIns.type) {\r\n          self.musicEffectManagerScriptIns.playHighScoreTreasurePicked();\r\n        } else {\r\n          self.musicEffectManagerScriptIns.playTreasurePicked();\r\n        }\r\n      }\r\n      delete self.treasureNodeDict[treasureLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed traps.\r\n    for (let k in toRemoveTrapNodeDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\r\n      delete self.trapNodeDict[trapLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed accelerators.\r\n    for (let k in toRemoveAcceleratorNodeDict) {\r\n      const accLocalIdInBattle = parseInt(k);\r\n      toRemoveAcceleratorNodeDict[k].parent.removeChild(toRemoveAcceleratorNodeDict[k]);\r\n      delete self.acceleratorNodeDict[accLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed bullets.\r\n    for (let k in toRemoveBulletNodeDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\r\n      delete self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n      if (self.musicEffectManagerScriptIns) {\r\n        self.musicEffectManagerScriptIns.playCrashedByTrapBullet();\r\n      }\r\n    }\r\n  },\r\n\r\n  transitToState(s) {\r\n    const self = this;\r\n    self.state = s;\r\n  },\r\n\r\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const localClearance = function() {\r\n      window.closeWSConnection();\r\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      }\r\n      cc.sys.localStorage.removeItem('selfPlayer');\r\n      cc.director.loadScene('login');\r\n    };\r\n\r\n    const self = this;\r\n    if (null != cc.sys.localStorage.selfPlayer) {\r\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      const requestContent = {\r\n        intAuthToken: selfPlayer.intAuthToken\r\n      }\r\n      try {\r\n        NetworkUtils.ajax({\r\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\r\n          type: \"POST\",\r\n          data: requestContent,\r\n          success: function(res) {\r\n            if (res.ret != constants.RET_CODE.OK) {\r\n              cc.log(`Logout failed: ${res}.`);\r\n            }\r\n            localClearance();\r\n          },\r\n          error: function(xhr, status, errMsg) {\r\n            localClearance();\r\n          },\r\n          timeout: function() {\r\n            localClearance();\r\n          }\r\n        });\r\n      } catch (e) {} finally {\r\n        // For Safari (both desktop and mobile).\r\n        localClearance();\r\n      }\r\n    } else {\r\n      localClearance();\r\n    }\r\n  },\r\n\r\n  onLogoutClicked(evt) {\r\n    const self = this;\r\n    self.showPopopInCanvas(self.confirmLogoutNode);\r\n  },\r\n\r\n  onLogoutConfirmationDismissed() {\r\n    const self = this;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    const canvasNode = self.canvasNode;\r\n    canvasNode.removeChild(self.confirmLogoutNode);\r\n    self.enableInputControls();\r\n  },\r\n\r\n  initWSConnection(evt, cb) {\r\n    const self = this;\r\n    window.initPersistentSessionClient(self.initAfterWSConncted);\r\n    if (cb) {\r\n      cb()\r\n    }\r\n  },\r\n\r\n  showPopopInCanvas(toShowNode) {\r\n    const self = this;\r\n    self.disableInputControls();\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\r\n    setLocalZOrder(toShowNode, 10);\r\n  },\r\n\r\n  matchPlayersFinsihed(players) {\r\n    console.log(players);\r\n\r\n    const self = this;\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.updatePlayersInfo(players);\r\n    window.setTimeout(() => {\r\n      if (self.findingPlayerNode.parent) {\r\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\r\n        self.transitToState(ALL_MAP_STATES.VISUAL);\r\n        for (let i in players) {\r\n          //更新在线玩家信息面板的信息\r\n          const playerInfo = players[i];\r\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n          playersScriptIns.updateData(playerInfo);\r\n        }\r\n      }\r\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\");\r\n      countDownScriptIns.setData();\r\n      self.showPopopInCanvas(self.countdownToBeginGameNode);\r\n      return;\r\n    }, 2000);\r\n  },\r\n});\r\n"]}