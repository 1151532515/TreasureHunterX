{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","treasurePrefab","trapPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","treasuresLocalIdStrList","treasureLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","resyncing","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onDestroy","battleState","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleRoomDownsyncFrame","upsyncLoopInterval","clearInterval","inputControlTimer","_lazilyTriggerResync","state","resyncingHintPopup","popupSimplePressToGo","t","_onResyncCompleted","log","parent","removeChild","labelString","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","string","once","dismissDialog","bind","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","playersNode","Animation","play","start","active","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","findingPlayerNode","findingPlayerScriptIns","showPopopInCanvas","gameRuleNode","playersInfoNode","onLoad","initWxSdk","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","musicEffectManagerScriptIns","confirmLogoutNode","resultPanelNode","resultPanelScriptIns","mapScriptIns","onAgainClicked","shouldReconnectState","sys","localStorage","clientSession","readyState","WebSocket","OPEN","initPersistentSessionClient","initAfterWSConncted","closeWSConnection","gameRuleScriptIns","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","width","sizeInMapNode","height","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","handleClientSessionCloseOrError","removeItem","parse","selfPlayer","_inputControlEnabled","setupInputControls","refFrameId","matchPlayersFinsihed","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","speed","score","joinIndex","anotherPlayer","treasureInfo","trapInfo","bulletInfo","onBattleStarted","expectedRoomId","qDict","getQueryParamDict","history","boundRoomId","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","playBGM","spawnSelfPlayer","stopAllMusic","showPlayerInfo","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","playersScriptIns","updateData","updateSpeed","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","aBulletScriptIns","localIdInBattle","linearSpeed","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","playHighScoreTreasurePicked","playTreasurePicked","playCrashedByTrapBullet","s","byClick","localClearance","loadScene","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","error","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","initWSConnection","cb","toShowNode","playerInfo","countDownScriptIns","origUrl","location","protocol","host","pathname","shareLink","updateAppMsgShareDataObj","dataUrl","title","document","desc","link","imgUrl","menuShareTimelineObj","wxConfigUrl","isUsingWebkitWechatKernel","atFirstLocationHref","href","WECHAT","JSCONFIG","console","jsConfig","configData","debug","appId","app_id","timestamp","toString","nonceStr","nonce_str","jsApiList","signature","wx","config","ready","onMenuShareAppMessage","onMenuShareTimeline"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\nwindow.ALL_BATTLE_STATES = {\n  WAITING: 0,\n  IN_BATTLE: 1,\n  IN_SETTLEMENT: 2,\n  IN_DISMISSAL: 3,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    useDiffFrameAlgo: {\n      default: true\n    },\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player1Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player2Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    treasurePrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    trapPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    simplePressToGoDialogPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    boundRoomIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    countdownLabel: {\n      type: cc.Label,\n      default: null\n    },\n    trapBulletPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    resultPanelPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    gameRulePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    findingPlayerPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    countdownToBeginGamePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    playersInfoPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n\n  },\n\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\n    let newFullFrame = {\n      id: diffFrame.id,\n      treasures: refFullFrame.treasures,\n      traps: refFullFrame.traps,\n      bullets: refFullFrame.bullets,\n      players: refFullFrame.players,\n    };\n\n    const players = diffFrame.players;\n    const playersLocalIdStrList = Object.keys(players);\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\n      const k = playersLocalIdStrList[i];\n      const playerId = parseInt(k);\n      if (true == diffFrame.players[playerId].removed) {\n        // cc.log(`Player id == ${playerId} is removed.`);\n        delete newFullFrame.players[playerId];\n      } else {\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\n      }\n    }\n\n    const treasures = diffFrame.treasures;\n    const treasuresLocalIdStrList = Object.keys(treasures);\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\n      const k = treasuresLocalIdStrList[i];\n      const treasureLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\n      } else {\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\n      }\n    }\n\n    const traps = diffFrame.traps;\n    const trapsLocalIdStrList = Object.keys(traps);\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n      const k = trapsLocalIdStrList[i];\n      const trapLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\n        // cc.log(`Trap with localIdInBattle == ${trapLocalIdInBattle} is removed.`);\n        delete newFullFrame.traps[trapLocalIdInBattle];\n      } else {\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\n      }\n    }\n\n    const bullets = diffFrame.bullets;\n    const bulletsLocalIdStrList = Object.keys(bullets);\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n      const k = bulletsLocalIdStrList[i];\n      const bulletLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\n        // cc.log(`Bullet with localIdInBattle == ${bulletLocalIdInBattle} is removed.`);\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\n      } else {\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\n      }\n    }\n\n    return newFullFrame;\n  },\n\n  _dumpToFullFrameCache: function(fullFrame) {\n    const self = this;\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\n      // cc.log(\"toDelFrameId is \" + toDelFrameId + \".\");\n      delete self.recentFrameCache[toDelFrameId];\n      --self.recentFrameCacheCurrentSize;\n    }\n    self.recentFrameCache[fullFrame.id] = fullFrame;\n    ++self.recentFrameCacheCurrentSize;\n  },\n\n  _onPerUpsyncFrame() {\n    const instance = this;\n    if (instance.resyncing) return;\n    if (\n      null == instance.selfPlayerInfo ||\n      null == instance.selfPlayerScriptIns ||\n      null == instance.selfPlayerScriptIns.scheduledDirection\n      ) return;\n    const upsyncFrameData = {\n      id: instance.selfPlayerInfo.id,\n      /**\n      * WARNING\n      *\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\n      */\n      dir: {\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\n      },\n      x: parseFloat(instance.selfPlayerNode.x),\n      y: parseFloat(instance.selfPlayerNode.y),\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\n    };\n    const wrapped = {\n      msgId: Date.now(),\n      act: \"PlayerUpsyncCmd\",\n      data: upsyncFrameData,\n    }\n    window.sendSafely(JSON.stringify(wrapped));\n  },\n\n  onDestroy() {\n    const self = this;\n    if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n    }\n    if (null != window.handleRoomDownsyncFrame) {\n      window.handleRoomDownsyncFrame = null;\n    }\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n    if (self.inputControlTimer) {\n      clearInterval(self.inputControlTimer)\n    }\n  },\n\n  _lazilyTriggerResync() {\n    if (true == this.resyncing) return;\n    this.resyncing = true;\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\n      if (null == this.resyncingHintPopup) {\n        this.resyncingHintPopup = this.popupSimplePressToGo(i18n.t(\"gameTip.resyncing\"));\n      }\n    }\n  },\n\n  _onResyncCompleted() {\n    if (false == this.resyncing) return;\n    cc.log(`_onResyncCompleted`);\n    this.resyncing = false;\n    if (null != this.resyncingHintPopup && this.resyncingHintPopup.parent) {\n      this.resyncingHintPopup.parent.removeChild(this.resyncingHintPopup);\n    }\n  },\n\n  popupSimplePressToGo(labelString) {\n    const self = this;\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\n\n    const canvasNode = self.canvasNode;\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\n    const postDismissalByYes = () => {\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      canvasNode.removeChild(simplePressToGoDialogNode);\n    }\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\n    setLocalZOrder(simplePressToGoDialogNode, 20);\n    return simplePressToGoDialogNode;\n  },\n\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const millisToGo = 3000;\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\n    setTimeout(() => {\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\n    }, millisToGo);\n  },\n\n  _resetCurrentMatch() {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    self.countdownLabel.string = \"\";\n    if (self.playersNode) {\n      for (let i in self.playersNode) {\n        let node = self.playersNode[i];\n        node.getComponent(cc.Animation).play(\"Bottom\");\n        node.getComponent(\"SelfPlayer\").start();\n        node.active = true;\n      }\n    }\n    if (self.otherPlayerNodeDict) {\n      for (let i in self.otherPlayerNodeDict) {\n        let node = self.otherPlayerNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\n    }\n    if (self.treasureNodeDict) {\n      for (let i in self.treasureNodeDict) {\n        let node = self.treasureNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapBulletNodeDict) {\n      for (let i in self.trapBulletNodeDict) {\n        let node = self.trapBulletNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapNodeDict) {\n      for (let i in self.trapNodeDict) {\n        let node = self.trapNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\n    for (let child of self.mainCameraNode.children) {\n      child.setScale(1 / self.mainCamera.zoomRatio);\n    }\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\n    self.mainCameraNode.setPosition(cc.v2());\n\n    self.resyncing = false;\n    self.lastRoomDownsyncFrameId = 0;\n\n    self.recentFrameCache = {};\n    self.recentFrameCacheCurrentSize = 0;\n    self.recentFrameCacheMaxCount = 2048;\n    self.selfPlayerNode = null;\n    self.selfPlayerScriptIns = null;\n    self.selfPlayerInfo = null;\n    self.upsyncLoopInterval = null;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n\n    self.battleState = ALL_BATTLE_STATES.WAITING;\n    self.otherPlayerCachedDataDict = {};\n    self.otherPlayerNodeDict = {};\n    self.treasureInfoDict = {};\n    self.treasureNodeDict = {};\n    self.trapInfoDict = {};\n    self.trapBulletInfoDict = {};\n    self.trapBulletNodeDict = {};\n    self.trapNodeDict = {};\n    if (self.findingPlayerNode) {\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n      findingPlayerScriptIns.init();\n    }\n    self.showPopopInCanvas(self.gameRuleNode);\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\n  },\n\n  onLoad() {\n    const self = this;\n    window.initWxSdk = self.initWxSdk.bind(self);\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n    self.musicEffectManagerScriptIns = self.node.getComponent(\"MusicEffectManager\");\n    /** init requeired prefab started */\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.mapScriptIns = self;\n    resultPanelScriptIns.onAgainClicked = () => {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      self._resetCurrentMatch();\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState);\n      switch (shouldReconnectState) {\n        case 2:\n        case 1:\n          // Clicking too fast?\n          return;\n        default:\n          break;\n      }\n      if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) {\n        // Already disconnected. \n        cc.log(\"Ws session is already closed when `again/replay` button is clicked. Reconnecting now.\");\n        window.initPersistentSessionClient(self.initAfterWSConncted);\n      } else {\n        // Should disconnect first and reconnect within `window.handleClientSessionCloseOrError`. \n        cc.log(\"Ws session is not closed yet when `again/replay` button is clicked, closing the ws session now.\");\n        cc.sys.localStorage.shouldReconnectState = 2;\n        window.closeWSConnection();\n      }\n    };\n\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\n    self.gameRuleScriptIns.mapNode = self.node;\n\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.init();\n\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\n\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\n\n    self.playersNode = {};\n    const player1Node = cc.instantiate(self.player1Prefab);\n    const player2Node = cc.instantiate(self.player2Prefab);\n    Object.assign(self.playersNode, {\n      1: player1Node\n    });\n    Object.assign(self.playersNode, {\n      2: player2Node\n    });\n    /** init requeired prefab ended */\n\n    self.clientUpsyncFps = 20;\n    self._resetCurrentMatch();\n\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\n    for (let frameAnim of boundaryObjs.frameAnimations) {\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\n      const anim = animNode.getComponent(cc.Animation);\n      animNode.setPosition(frameAnim.posInMapNode);\n      animNode.width = frameAnim.sizeInMapNode.width;\n      animNode.height = frameAnim.sizeInMapNode.height;\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n      safelyAddChild(self.node, animNode);\n      setLocalZOrder(animNode, 5);\n      anim.addClip(frameAnim.animationClip, \"default\");\n      anim.play(\"default\");\n    }\n\n    self.barrierColliders = [];\n    for (let boundaryObj of boundaryObjs.barriers) {\n      const newBarrier = cc.instantiate(self.barrierPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\n      newBarrierColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.barrierColliders.push(newBarrierColliderIns);\n      self.node.addChild(newBarrier);\n    }\n    const allLayers = tiledMapIns.getLayers();\n    for (let layer of allLayers) {\n      const layerType = layer.getProperty(\"type\");\n      switch (layerType) {\n        case \"normal\":\n          setLocalZOrder(layer.node, 0);\n          break;\n        case \"barrier_and_shelter\":\n          setLocalZOrder(layer.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    const allObjectGroups = tiledMapIns.getObjectGroups();\n    for (let objectGroup of allObjectGroups) {\n      const objectGroupType = objectGroup.getProperty(\"type\");\n      switch (objectGroupType) {\n        case \"barrier_and_shelter\":\n          setLocalZOrder(objectGroup.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\n      newShelter.setAnchorPoint(cc.v2(0, 0));\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\n      newShelterColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.node.addChild(newShelter);\n    }\n\n    window.handleClientSessionCloseOrError = function() {\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState);\n      switch (shouldReconnectState) {\n        case 2:\n          shouldReconnectState = 1;\n          cc.sys.localStorage.shouldReconnectState = shouldReconnectState;\n          cc.log(\"Reconnecting because 2 == shouldReconnectState and it's now set to 1.\");\n          window.initPersistentSessionClient(self.initAfterWSConncted);\n          return;\n        case 1:\n          cc.log(\"Neither reconnecting nor alerting because 1 == shouldReconnectState and it's now removed.\");\n          cc.sys.localStorage.removeItem(\"shouldReconnectState\");\n          return;\n        default:\n          break;\n      }\n      if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\n      }\n    };\n\n    self.initAfterWSConncted = () => {\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n      Object.assign(self.selfPlayerInfo, {\n        id: self.selfPlayerInfo.playerId\n      });\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      self._inputControlEnabled = false;\n      self.setupInputControls();\n      window.handleRoomDownsyncFrame = function(diffFrame) {\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\n        const refFrameId = diffFrame.refFrameId;\n        if (-99 == refFrameId) { //显示倒计时\n          self.matchPlayersFinsihed(diffFrame.players);\n        } else if (-98 == refFrameId) { //显示匹配玩家\n          window.initWxSdk();\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n          if (!self.findingPlayerNode.parent) {\n            self.showPopopInCanvas(self.findingPlayerNode);\n          }\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.players);\n          return;\n        }\n        const frameId = diffFrame.id;\n        if (frameId <= self.lastRoomDownsyncFrameId) {\n          // Log the obsolete frames?\n          return;\n        }\n        const isInitiatingFrame = (0 > self.recentFrameCacheCurrentSize || 0 == refFrameId);\n        /*\n        if (frameId % 300 == 0) {\n          // WARNING: For testing only!\n          if (0 < frameId) {\n            self._lazilyTriggerResync(); \n          }\n          cc.log(`${JSON.stringify(diffFrame)}`);\n        }\n        */\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\n        if (\n          !isInitiatingFrame\n          && self.useDiffFrameAlgo\n          && (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\". \n          && null == cachedFullFrame\n        ) {\n          self._lazilyTriggerResync();\n          // Later incoming diffFrames will all suffice that `0 < self.recentFrameCacheCurrentSize && null == cachedFullFrame`, until `this._onResyncCompleted` is successfully invoked.\n          return;\n        }\n\n        if (isInitiatingFrame && 0 == refFrameId) {\n          // Reaching here implies that you've received the resync frame.\n          self._onResyncCompleted();\n        }\n        let countdownNanos = diffFrame.countdownNanos;\n        if (countdownNanos < 0)\n          countdownNanos = 0;\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\n        if (isNaN(countdownSeconds)) {\n          cc.log(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\n        }\n        // if(self.musicEffectManagerScriptIns && 10 == countdownSeconds ) {\n        //   self.musicEffectManagerScriptIns.playCountDown10SecToEnd();\n        // }\n        self.countdownLabel.string = countdownSeconds;\n        const roomDownsyncFrame = (\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\n          ?\n          diffFrame\n          :\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\n        );\n        if (countdownNanos <= 0) {\n          self.onBattleStopped(roomDownsyncFrame.players);\n          return;\n        }\n        self._dumpToFullFrameCache(roomDownsyncFrame);\n        const sentAt = roomDownsyncFrame.sentAt;\n        const players = roomDownsyncFrame.players;\n        const playerIdStrList = Object.keys(players);\n        self.otherPlayerCachedDataDict = {};\n        for (let i = 0; i < playerIdStrList.length; ++i) {\n          const k = playerIdStrList[i];\n          const playerId = parseInt(k);\n          if (playerId == self.selfPlayerInfo.id) {\n            const immediateSelfPlayerInfo = players[k];\n            Object.assign(self.selfPlayerInfo, {\n              x: immediateSelfPlayerInfo.x,\n              y: immediateSelfPlayerInfo.y,\n              speed: immediateSelfPlayerInfo.speed,\n              battleState: immediateSelfPlayerInfo.battleState,\n              score: immediateSelfPlayerInfo.score,\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\n            });\n            continue;\n          }\n          const anotherPlayer = players[k];\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\n        }\n        self.treasureInfoDict = {};\n        const treasures = roomDownsyncFrame.treasures;\n        const treasuresLocalIdStrList = Object.keys(treasures);\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\n          const k = treasuresLocalIdStrList[i];\n          const treasureLocalIdInBattle = parseInt(k);\n          const treasureInfo = treasures[k];\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\n        }\n\n        self.trapInfoDict = {};\n        const traps = roomDownsyncFrame.traps;\n        const trapsLocalIdStrList = Object.keys(traps);\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n          const k = trapsLocalIdStrList[i];\n          const trapLocalIdInBattle = parseInt(k);\n          const trapInfo = traps[k];\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\n        }\n\n        self.trapBulletInfoDict = {};\n        const bullets = roomDownsyncFrame.bullets;\n        const bulletsLocalIdStrList = Object.keys(bullets);\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n          const k = bulletsLocalIdStrList[i];\n          const bulletLocalIdInBattle = parseInt(k);\n          const bulletInfo = bullets[k];\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\n        }\n\n        if (0 == self.lastRoomDownsyncFrameId) {\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\n          if (1 == frameId) {\n            // No need to prompt upon rejoined.\n            self.popupSimplePressToGo(i18n.t(\"gameTip.start\"));\n          }\n          self.onBattleStarted();\n        }\n        self.lastRoomDownsyncFrameId = frameId;\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\n      };\n    }\n\n    /*\n    * The following code snippet is a dirty fix.\n    */\n    let expectedRoomId = null;\n    const qDict = window.getQueryParamDict();\n    if (qDict) {\n      expectedRoomId = qDict[\"expectedRoomId\"];\n    } else {\n      if (window.history && window.history.state) {\n        expectedRoomId = window.history.state.expectedRoomId;\n      }\n    }\n    if (expectedRoomId) {\n      self.gameRuleNode.active = false;\n      window.initPersistentSessionClient(self.initAfterWSConncted);\n      return;\n    } else {\n      if (cc.sys.localStorage.boundRoomId) {\n        self.gameRuleNode.active = false;\n        window.initPersistentSessionClient(self.initAfterWSConncted);\n        return;\n      }\n    }\n  },\n\n  setupInputControls() {\n    const instance = this;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const ctrl = joystickInputControllerScriptIns;\n    instance.ctrl = ctrl;\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n      instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true;\n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  onBattleStarted() {\n    const self = this;\n    if (self.musicEffectManagerScriptIns)\n      self.musicEffectManagerScriptIns.playBGM();\n    const canvasNode = self.canvasNode;\n    self.spawnSelfPlayer();\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    self.enableInputControls();\n    if (self.countdownToBeginGameNode.parent) {\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n    }\n  },\n\n  onBattleStopped(players) {\n    const self = this;\n    if (self.musicEffectManagerScriptIns) {\n      self.musicEffectManagerScriptIns.stopAllMusic();\n    }\n    const canvasNode = self.canvasNode;\n    const resultPanelNode = self.resultPanelNode;\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.showPlayerInfo(players);\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage(); //清除cached boundRoomId\n    // Such that it doesn't execute \"update(dt)\" anymore. \n    self.selfPlayerNode.active = false;\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\n    self.showPopopInCanvas(resultPanelNode);\n  },\n\n  spawnSelfPlayer() {\n    const instance = this;\n    const joinIndex = this.selfPlayerInfo.joinIndex;\n    const newPlayerNode = this.playersNode[joinIndex];\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\n    newPlayerNode.setPosition(toStartWithPos);\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\n\n    instance.node.addChild(newPlayerNode);\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\n    instance.selfPlayerScriptIns.showArrowTipNode();\n\n    setLocalZOrder(newPlayerNode, 5);\n    instance.selfPlayerNode = newPlayerNode;\n  },\n\n  update(dt) {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    const canvasParentNode = canvasNode.parent;\n    if (null != window.boundRoomId) {\n      self.boundRoomIdLabel.string = window.boundRoomId;\n    }\n    if (null != self.selfPlayerInfo) {\n      const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n      playersScriptIns.updateData(self.selfPlayerInfo);\n      if (null != self.selfPlayerScriptIns) {\n        self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\n      }\n    }\n\n    let toRemovePlayerNodeDict = {};\n    Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\n\n    let toRemoveTreasureNodeDict = {};\n    Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\n\n    let toRemoveTrapNodeDict = {};\n    Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\n\n    /*\n    * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\n    */\n    let toRemoveBulletNodeDict = {};\n    Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\n\n    for (let k in self.otherPlayerCachedDataDict) {\n      const playerId = parseInt(k);\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\n      const newPos = cc.v2(\n        cachedPlayerData.x,\n        cachedPlayerData.y\n      );\n      //更新玩家信息展示\n      if (null != cachedPlayerData) {\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n        playersScriptIns.updateData(cachedPlayerData);\n      }\n      let targetNode = self.otherPlayerNodeDict[playerId];\n      if (!targetNode) {\n        targetNode = self.playersNode[cachedPlayerData.joinIndex];\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\n        self.otherPlayerNodeDict[playerId] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\n      aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\n\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const toMoveByVecMag = toMoveByVec.mag();\n      const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\n      const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\n      if (toMoveByVecMag < notToMoveDisThreshold) {\n        aControlledOtherPlayerScriptIns.activeDirection = {\n          dx: 0,\n          dy: 0\n        };\n      } else {\n        if (toMoveByVecMag > toTeleportDisThreshold) {\n          cc.log(`Player ${cachedPlayerData.id} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\n          aControlledOtherPlayerScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0\n          };\n          // TODO: Use `cc.Action`?\n          targetNode.setPosition(newPos);\n        } else {\n          // The common case which is suitable for interpolation.\n          const normalizedDir = {\n            dx: toMoveByVec.x / toMoveByVecMag,\n            dy: toMoveByVec.y / toMoveByVecMag,\n          };\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n            aControlledOtherPlayerScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0,\n            };\n          } else {\n            aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\n          }\n        }\n      }\n\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\n        aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\n      }\n\n      if (null != toRemovePlayerNodeDict[playerId]) {\n        delete toRemovePlayerNodeDict[playerId];\n      }\n    }\n\n    // 更新陷阱显示 \n    for (let k in self.trapInfoDict) {\n      const trapLocalIdInBattle = parseInt(k);\n      const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\n      const newPos = cc.v2(\n        trapInfo.x,\n        trapInfo.y\n      );\n      let targetNode = self.trapNodeDict[trapLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.trapPrefab);\n        self.trapNodeDict[trapLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\n        delete toRemoveTrapNodeDict[trapLocalIdInBattle];\n      }\n    }\n\n    // 更新bullet显示 \n    for (let k in self.trapBulletInfoDict) {\n      const bulletLocalIdInBattle = parseInt(k);\n      const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\n      const newPos = cc.v2(\n        bulletInfo.x,\n        bulletInfo.y\n      );\n      let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.trapBulletPrefab);\n        self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      const aBulletScriptIns = targetNode.getComponent(\"Bullet\");\n      aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\n      aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \n\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y,\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const toMoveByVecMag = toMoveByVec.mag();\n      const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\n      const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\n      if (toMoveByVecMag < notToMoveDisThreshold) {\n        aBulletScriptIns.activeDirection = {\n          dx: 0,\n          dy: 0,\n        };\n      } else {\n        if (toMoveByVecMag > toTeleportDisThreshold) {\n          cc.log(`Bullet ${bulletLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\n          aBulletScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0\n          };\n          // TODO: Use `cc.Action`?\n          targetNode.setPosition(newPos);\n        } else {\n          // The common case which is suitable for interpolation.\n          const normalizedDir = {\n            dx: toMoveByVec.x / toMoveByVecMag,\n            dy: toMoveByVec.y / toMoveByVecMag,\n          };\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n            aBulletScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0,\n            };\n          } else {\n            aBulletScriptIns.activeDirection = normalizedDir;\n          }\n        }\n      }\n      if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\n        delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\n      }\n    }\n\n    // 更新宝物显示 \n    for (let k in self.treasureInfoDict) {\n      const treasureLocalIdInBattle = parseInt(k);\n      const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\n      const newPos = cc.v2(\n        treasureInfo.x,\n        treasureInfo.y\n      );\n      let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.treasurePrefab);\n        const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\n        treasureNodeScriptIns.setData(treasureInfo);\n        self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n\n      if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\n        delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\n      }\n      if (0 < targetNode.getNumberOfRunningActions()) {\n        // A significant trick to smooth the position sync performance!\n        continue;\n      }\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const durationSeconds = dt; // Using `dt` temporarily!\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\n    }\n\n    // Coping with removed players.\n    for (let k in toRemovePlayerNodeDict) {\n      const playerId = parseInt(k);\n      toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\n      delete self.otherPlayerNodeDict[playerId];\n    }\n\n    // Coping with removed treasures.\n    for (let k in toRemoveTreasureNodeDict) {\n      const treasureLocalIdInBattle = parseInt(k);\n      const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\n      treasureScriptIns.playPickedUpAnimAndDestroy();\n      if (self.musicEffectManagerScriptIns) {\n        if (2 == treasureScriptIns.type) {\n          self.musicEffectManagerScriptIns.playHighScoreTreasurePicked();\n        } else {\n          self.musicEffectManagerScriptIns.playTreasurePicked();\n        }\n      }\n      delete self.treasureNodeDict[treasureLocalIdInBattle];\n    }\n\n    // Coping with removed traps.\n    for (let k in toRemoveTrapNodeDict) {\n      const trapLocalIdInBattle = parseInt(k);\n      toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\n      delete self.trapNodeDict[trapLocalIdInBattle];\n    }\n\n    // Coping with removed bullets.\n    for (let k in toRemoveBulletNodeDict) {\n      const bulletLocalIdInBattle = parseInt(k);\n      toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\n      delete self.trapBulletNodeDict[bulletLocalIdInBattle];\n      if (self.musicEffectManagerScriptIns) {\n        self.musicEffectManagerScriptIns.playCrashedByTrapBullet();\n      }\n    }\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const localClearance = function() {\n      window.closeWSConnection();\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      }\n      cc.sys.localStorage.removeItem('selfPlayer');\n      cc.director.loadScene('login');\n    };\n\n    const self = this;\n    if (null != cc.sys.localStorage.selfPlayer) {\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n      const requestContent = {\n        intAuthToken: selfPlayer.intAuthToken\n      }\n      try {\n        NetworkUtils.ajax({\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n          type: \"POST\",\n          data: requestContent,\n          success: function(res) {\n            if (res.ret != constants.RET_CODE.OK) {\n              cc.log(`Logout failed: ${res}.`);\n            }\n            localClearance();\n          },\n          error: function(xhr, status, errMsg) {\n            localClearance();\n          },\n          timeout: function() {\n            localClearance();\n          }\n        });\n      } catch (e) {} finally {\n        // For Safari (both desktop and mobile).\n        localClearance();\n      }\n    } else {\n      localClearance();\n    }\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.showPopopInCanvas(self.confirmLogoutNode);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n\n  initWSConnection(evt, cb) {\n    const self = this;\n    window.initPersistentSessionClient(self.initAfterWSConncted);\n    if (cb) {\n      cb()\n    }\n  },\n\n  showPopopInCanvas(toShowNode) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\n    setLocalZOrder(toShowNode, 10);\n  },\n\n  matchPlayersFinsihed(players) {\n    const self = this;\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.updatePlayersInfo(players);\n    window.setTimeout(() => {\n      if (self.findingPlayerNode.parent) {\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\n        self.transitToState(ALL_MAP_STATES.VISUAL);\n        for (let i in players) {\n          //更新在线玩家信息面板的信息\n          const playerInfo = players[i];\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n          playersScriptIns.updateData(playerInfo);\n        }\n      }\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\");\n      countDownScriptIns.setData();\n      self.showPopopInCanvas(self.countdownToBeginGameNode);\n      return;\n    }, 2000);\n  },\n\n  initWxSdk() {\n    const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const origUrl = window.location.protocol + \"//\" + window.location.host + window.location.pathname;\n    /*\n    * The `shareLink` must \n    * - have its 2nd-order-domain registered as trusted 2nd-order under the targetd `res.jsConfig.app_id`, and\n    * - extracted from current window.location.href.   \n    */\n    const shareLink = origUrl;\n    const updateAppMsgShareDataObj = {\n      type: 'link', // 分享类型,music、video或link，不填默认为link\n      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空\n      title: document.title, // 分享标题\n      desc: 'Let\\'s play together!', // 分享描述\n      link: shareLink + (null == cc.sys.localStorage.boundRoomId ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.boundRoomId)),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {\n        // 设置成功\n      }\n    };\n    const menuShareTimelineObj = {\n      title: document.title, // 分享标题\n      link: shareLink + (null == cc.sys.localStorage.boundRoomId ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.boundRoomId)),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {}\n    };\n\n    const wxConfigUrl = (window.isUsingWebkitWechatKernel() ? window.atFirstLocationHref : window.location.href); \n    //接入微信登录接口\n    NetworkUtils.ajax({\n      \"url\": backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.JSCONFIG,\n      type: \"POST\",\n      data: {\n        \"url\": wxConfigUrl,\n        \"intAuthToken\": selfPlayer.intAuthToken,\n      },\n      success: function(res) {\n        if (constants.RET_CODE.OK != res.ret) {\n          console.log(\"cannot get the wsConfig. retCode == \" + res.ret);\n          return;\n        }\n        const jsConfig = res.jsConfig;\n        console.log(updateAppMsgShareDataObj);\n        const configData = {\n          debug: CC_DEBUG, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\n          appId: jsConfig.app_id, // 必填，公众号的唯一标识\n          timestamp: jsConfig.timestamp.toString(), // 必填，生成签名的时间戳\n          nonceStr: jsConfig.nonce_str, // 必填，生成签名的随机串\n          jsApiList: ['onMenuShareAppMessage', 'onMenuShareTimeline'],\n          signature: jsConfig.signature, // 必填，签名\n        };\n        console.log(\"config url: \" + wxConfigUrl);\n        console.log(\"wx.config: \");\n        console.log(configData);\n        wx.config(configData);\n        console.log(\"Current window.location.href: \" + window.location.href);\n        wx.ready(function() {\n          console.log(\"Here is wx.ready.\")\n          wx.onMenuShareAppMessage(updateAppMsgShareDataObj);\n          wx.onMenuShareTimeline(menuShareTimelineObj);\n        });\n        wx.error(function(res) {\n          console.error(\"wx config fails and error is \" + JSON.stringify(res));\n        });\n      },\n      error: function(xhr, status, errMsg) {\n        console.log(\"cannot get the wsConfig. errMsg == \" + errMsg);\n      },\n    });\n  },\n});\n"]}