{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","pumpkinPrefab","treasurePrefab","trapPrefab","acceleratorPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","guardTowerPrefab","forceBigEndianFloatingNumDecoding","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","speedShoes","pumpkin","guardTowers","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","pumpkinsLocalIdStrList","pumpkinLocalIdInBattle","treasuresLocalIdStrList","treasureLocalIdInBattle","speedShoesLocalIdStrList","speedShoesLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","log","accs","accsLocalIdStrList","accLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","resyncing","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onDestroy","console","warn","battleState","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleRoomDownsyncFrame","upsyncLoopInterval","clearInterval","inputControlTimer","_lazilyTriggerResync","lastResyncingStartedAt","state","resyncingHintPopup","popupSimplePressToGo","t","_onResyncCompleted","resyncingDurationMillis","parent","removeChild","labelString","hideYesButton","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","string","once","dismissDialog","bind","active","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","playersNode","Animation","play","start","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","pumpkinNodeDict","acceleratorNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","pumpkinInfoDict","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","towerNodeDict","findingPlayerNode","findingPlayerScriptIns","showPopopInCanvas","gameRuleNode","playersInfoNode","onLoad","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","musicEffectManagerScriptIns","confirmLogoutNode","resultPanelNode","width","height","resultPanelScriptIns","mapScriptIns","onAgainClicked","shouldReconnectState","sys","localStorage","getItem","clientSession","readyState","WebSocket","OPEN","initPersistentSessionClient","initAfterWSConncted","setItem","closeWSConnection","gameRuleScriptIns","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","sizeInMapNode","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","handleClientSessionCloseOrError","removeItem","platform","WECHAT_GAME","loadScene","parse","_inputControlEnabled","setupInputControls","refFrameId","matchPlayersFinsihed","initWxSdk","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","displayName","name","speed","score","joinIndex","anotherPlayer","pumpkinInfo","treasureInfo","acceleratorInfoDict","accelartors","accLocalIdStrList","accInfo","trapInfo","bulletInfo","guardTowerInfoDict","ids","localIdInBattle","tower","onBattleStarted","wxLifeCycleListenerSetted","query","wx","getLaunchOptionsSync","expectedRoomId","tryToJoinExpectedRoom","reconnectGameByExpectedRoomId","onShow","res","onHide","mode","expectedRoomIdFromQuery","qDict","getQueryParamDict","history","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","playBGM","spawnSelfPlayer","stopAllMusic","showPlayerInfo","clearInfo","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","boundRoomId","playersScriptIns","updateData","updateSpeed","toRemoveAcceleratorNodeDict","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemovePumpkinNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","acceleratorInfo","towerInfo","rotation","startAtPoint","endAtPoint","error","radian","Math","PI","abs","atan","angleTemp","angle","aBulletScriptIns","linearSpeed","aPumpkinScriptIns","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","playHighScoreTreasurePicked","playTreasurePicked","playCrashedByTrapBullet","s","byClick","localClearance","selfPlayer","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","ret","RET_CODE","OK","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","initWSConnection","cb","toShowNode","playerInfo","countDownScriptIns"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\nwindow.ALL_BATTLE_STATES = {\n  WAITING: 0,\n  IN_BATTLE: 1,\n  IN_SETTLEMENT: 2,\n  IN_DISMISSAL: 3,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    useDiffFrameAlgo: {\n      default: true\n    },\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player1Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    player2Prefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    pumpkinPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    treasurePrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    trapPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    acceleratorPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null,\n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    simplePressToGoDialogPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    boundRoomIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    countdownLabel: {\n      type: cc.Label,\n      default: null\n    },\n    trapBulletPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    resultPanelPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    gameRulePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    findingPlayerPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    countdownToBeginGamePrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    playersInfoPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    guardTowerPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    forceBigEndianFloatingNumDecoding: {\n      default: false,\n    },\n  },\n\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\n    let newFullFrame = {\n      id: diffFrame.id,\n      treasures: refFullFrame.treasures,\n      traps: refFullFrame.traps,\n      bullets: refFullFrame.bullets,\n      players: refFullFrame.players,\n      speedShoes: refFullFrame.speedShoes,\n      pumpkin: refFullFrame.pumpkin,\n      guardTowers: refFullFrame.guardTowers, //TODO: 根据diffFrame信息增删或者移动守护塔\n    };\n    const players = diffFrame.players;\n    const playersLocalIdStrList = Object.keys(players);\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\n      const k = playersLocalIdStrList[i];\n      const playerId = parseInt(k);\n      if (true == diffFrame.players[playerId].removed) {\n        // cc.log(`Player id == ${playerId} is removed.`);\n        delete newFullFrame.players[playerId];\n      } else {\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\n      }\n    }\n\n    const pumpkin = diffFrame.pumpkin;\n    const pumpkinsLocalIdStrList = Object.keys(pumpkin);\n    for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\n      const k = pumpkinsLocalIdStrList[i];\n      const pumpkinLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.pumpkin[pumpkinLocalIdInBattle].removed) {\n        delete newFullFrame.pumpkin[pumpkinLocalIdInBattle];\n      } else {\n        newFullFrame.pumpkin[pumpkinLocalIdInBattle] = diffFrame.pumpkin[pumpkinLocalIdInBattle];\n      }\n    }\n\n    const treasures = diffFrame.treasures;\n    const treasuresLocalIdStrList = Object.keys(treasures);\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\n      const k = treasuresLocalIdStrList[i];\n      const treasureLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\n      } else {\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\n      }\n    }\n\n    const speedShoes = diffFrame.speedShoes;\n    const speedShoesLocalIdStrList = Object.keys(speedShoes);\n    for (let i = 0; i < speedShoesLocalIdStrList.length; ++i) {\n      const k = speedShoesLocalIdStrList[i];\n      const speedShoesLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.speedShoes[speedShoesLocalIdInBattle].removed) {\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\n        delete newFullFrame.speedShoes[speedShoesLocalIdInBattle];\n      } else {\n        newFullFrame.speedShoes[speedShoesLocalIdInBattle] = diffFrame.speedShoes[speedShoesLocalIdInBattle];\n      }\n    }\n\n    const traps = diffFrame.traps;\n    const trapsLocalIdStrList = Object.keys(traps);\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n      const k = trapsLocalIdStrList[i];\n      const trapLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\n        // cc.log(`Trap with localIdInBattle == ${trapLocalIdInBattle} is removed.`);\n        delete newFullFrame.traps[trapLocalIdInBattle];\n      } else {\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\n      }\n    }\n\n    const bullets = diffFrame.bullets;\n    const bulletsLocalIdStrList = Object.keys(bullets);\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n      const k = bulletsLocalIdStrList[i];\n      const bulletLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\n        cc.log(`Bullet with localIdInBattle == ${bulletLocalIdInBattle} is removed.`);\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\n      } else {\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\n      }\n    }\n\n    const accs = diffFrame.speedShoes;\n    const accsLocalIdStrList = Object.keys(accs);\n    for (let i = 0; i < accsLocalIdStrList.length; ++i) {\n      const k = accsLocalIdStrList[i];\n      const accLocalIdInBattle = parseInt(k);\n      if (true == diffFrame.speedShoes[accLocalIdInBattle].removed) {\n        delete newFullFrame.speedShoes[accLocalIdInBattle];\n      } else {\n        newFullFrame.speedShoes[accLocalIdInBattle] = diffFrame.speedShoes[accLocalIdInBattle];\n      }\n    }\n    return newFullFrame;\n  },\n\n  _dumpToFullFrameCache: function(fullFrame) {\n    const self = this;\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\n      // cc.log(\"toDelFrameId is \" + toDelFrameId + \".\");\n      delete self.recentFrameCache[toDelFrameId];\n      --self.recentFrameCacheCurrentSize;\n    }\n    self.recentFrameCache[fullFrame.id] = fullFrame;\n    ++self.recentFrameCacheCurrentSize;\n  },\n\n  _onPerUpsyncFrame() {\n    const instance = this;\n    if (instance.resyncing) return;\n    if (\n      null == instance.selfPlayerInfo ||\n      null == instance.selfPlayerScriptIns ||\n      null == instance.selfPlayerScriptIns.scheduledDirection\n      ) return;\n    const upsyncFrameData = {\n      id: instance.selfPlayerInfo.id,\n      /**\n      * WARNING\n      *\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\n      */\n      dir: {\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\n      },\n      x: parseFloat(instance.selfPlayerNode.x),\n      y: parseFloat(instance.selfPlayerNode.y),\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\n    };\n    const wrapped = {\n      msgId: Date.now(),\n      act: \"PlayerUpsyncCmd\",\n      data: upsyncFrameData,\n    }\n    window.sendSafely(JSON.stringify(wrapped));\n  },\n\n  onDestroy() {\n    console.warn('+++++++ map onDestroy()');\n    const self = this;\n    if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n    }\n    if (null != window.handleRoomDownsyncFrame) {\n      window.handleRoomDownsyncFrame = null;\n    }\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n    if (self.inputControlTimer) {\n      clearInterval(self.inputControlTimer)\n    }\n  },\n\n  _lazilyTriggerResync() {\n    if (true == this.resyncing) return;\n    this.lastResyncingStartedAt = Date.now();\n    this.resyncing = true;\n\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\n      if (null == this.resyncingHintPopup) {\n        this.resyncingHintPopup = this.popupSimplePressToGo(i18n.t(\"gameTip.resyncing\"), true);\n      }\n    }\n  },\n\n  _onResyncCompleted() {\n    if (false == this.resyncing) return;\n    this.resyncing = false;\n    const resyncingDurationMillis = (Date.now() - this.lastResyncingStartedAt);\n    cc.log(`_onResyncCompleted, resyncing took ${resyncingDurationMillis} milliseconds.`);\n    if (null != this.resyncingHintPopup && this.resyncingHintPopup.parent) {\n      this.resyncingHintPopup.parent.removeChild(this.resyncingHintPopup);\n    }\n  },\n\n  popupSimplePressToGo(labelString, hideYesButton) {\n    const self = this;\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\n\n    const canvasNode = self.canvasNode;\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\n    const postDismissalByYes = () => {\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      canvasNode.removeChild(simplePressToGoDialogNode);\n    }\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\n\n    if (true == hideYesButton) {\n      yesButton.active = false;\n    }\n\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\n    setLocalZOrder(simplePressToGoDialogNode, 20);\n    return simplePressToGoDialogNode;\n  },\n\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const millisToGo = 3000;\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\n    setTimeout(() => {\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\n    }, millisToGo);\n  },\n\n  _resetCurrentMatch() {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    self.countdownLabel.string = \"\";\n    if (self.playersNode) {\n      for (let i in self.playersNode) {\n        let node = self.playersNode[i];\n        node.getComponent(cc.Animation).play(\"Bottom\");\n        node.getComponent(\"SelfPlayer\").start();\n        node.active = true;\n      }\n    }\n    if (self.otherPlayerNodeDict) {\n      for (let i in self.otherPlayerNodeDict) {\n        let node = self.otherPlayerNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\n    }\n    if (self.treasureNodeDict) {\n      for (let i in self.treasureNodeDict) {\n        let node = self.treasureNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapBulletNodeDict) {\n      for (let i in self.trapBulletNodeDict) {\n        let node = self.trapBulletNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n    if (self.trapNodeDict) {\n      for (let i in self.trapNodeDict) {\n        let node = self.trapNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.pumpkinNodeDict) {\n      for (let i in self.pumpkinNodeDict) {\n        let node = self.pumpkinNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.acceleratorNodeDict) {\n      for (let i in self.acceleratorNodeDict) {\n        let node = self.acceleratorNodeDict[i];\n        if (node.parent) {\n          node.parent.removeChild(node);\n        }\n      }\n    }\n\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\n    for (let child of self.mainCameraNode.children) {\n      child.setScale(1 / self.mainCamera.zoomRatio);\n    }\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\n    self.mainCameraNode.setPosition(cc.v2());\n\n    self.resyncing = false;\n    self.lastRoomDownsyncFrameId = 0;\n\n    self.recentFrameCache = {};\n    self.recentFrameCacheCurrentSize = 0;\n    self.recentFrameCacheMaxCount = 2048;\n    self.selfPlayerNode = null;\n    self.selfPlayerScriptIns = null;\n    self.selfPlayerInfo = null;\n    self.upsyncLoopInterval = null;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n\n    self.battleState = ALL_BATTLE_STATES.WAITING;\n\n    self.pumpkinInfoDict = {};\n    self.pumpkinNodeDict = {};\n    self.otherPlayerCachedDataDict = {};\n    self.otherPlayerNodeDict = {};\n    self.treasureInfoDict = {};\n    self.treasureNodeDict = {};\n    self.trapInfoDict = {};\n    self.trapBulletInfoDict = {};\n    self.trapBulletNodeDict = {};\n    self.trapNodeDict = {};\n    self.towerNodeDict = {};\n    self.acceleratorNodeDict = {};\n    if (self.findingPlayerNode) {\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n      findingPlayerScriptIns.init();\n    }\n    self.showPopopInCanvas(self.gameRuleNode);\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\n  },\n\n  onLoad() {\n    const self = this;\n    window.forceBigEndianFloatingNumDecoding = self.forceBigEndianFloatingNumDecoding;\n\n    /*\n     * kobako: 因为小游戏的onShow生命周期函数全局只赋值一次, 所以需要通过window.mapIns变量来操作而不能通过this, 因为map场景重新加载后, this指向过去的map场景\n     */\n    window.mapIns = self;\n    console.warn('+++++++ map onLoad()');\n\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n    self.musicEffectManagerScriptIns = self.node.getComponent(\"MusicEffectManager\");\n\n    /** init requeired prefab started */\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n\n    //Result panel init\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\n    self.resultPanelNode.width = self.canvasNode.width;\n    self.resultPanelNode.height = self.canvasNode.height;\n\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.mapScriptIns = self;\n    resultPanelScriptIns.onAgainClicked = () => {\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      self._resetCurrentMatch();\n      let shouldReconnectState = parseInt(cc.sys.localStorage.getItem('shouldReconnectState'));\n      switch (shouldReconnectState) {\n        case 2:\n        case 1:\n          // Clicking too fast?\n          return;\n        default:\n          break;\n      }\n\n      if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) {\n        // Already disconnected. \n        cc.log(\"Ws session is already closed when `again/replay` button is clicked. Reconnecting now.\");\n        window.initPersistentSessionClient(self.initAfterWSConncted);\n      } else {\n        // Should disconnect first and reconnect within `window.handleClientSessionCloseOrError`. \n        cc.log(\"Ws session is not closed yet when `again/replay` button is clicked, closing the ws session now.\");\n        cc.sys.localStorage.setItem('shouldReconnectState', 2);\n        window.closeWSConnection();\n      }\n    };\n\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\n    self.gameRuleNode.width = self.canvasNode.width;\n    self.gameRuleNode.height = self.canvasNode.height;\n\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\n    self.gameRuleScriptIns.mapNode = self.node;\n\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\n    self.findingPlayerNode.width = self.canvasNode.width;\n    self.findingPlayerNode.height = self.canvasNode.height;\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.init();\n\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\n\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\n    self.countdownToBeginGameNode.width = self.canvasNode.width;\n    self.countdownToBeginGameNode.height = self.canvasNode.height;\n\n    self.playersNode = {};\n    const player1Node = cc.instantiate(self.player1Prefab);\n    const player2Node = cc.instantiate(self.player2Prefab);\n    Object.assign(self.playersNode, {\n      1: player1Node\n    });\n    Object.assign(self.playersNode, {\n      2: player2Node\n    });\n\n    /** init requeired prefab ended */\n\n    self.clientUpsyncFps = 20;\n    self._resetCurrentMatch();\n\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\n    for (let frameAnim of boundaryObjs.frameAnimations) {\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\n      const anim = animNode.getComponent(cc.Animation);\n      animNode.setPosition(frameAnim.posInMapNode);\n      animNode.width = frameAnim.sizeInMapNode.width;\n      animNode.height = frameAnim.sizeInMapNode.height;\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n      safelyAddChild(self.node, animNode);\n      setLocalZOrder(animNode, 5);\n      anim.addClip(frameAnim.animationClip, \"default\");\n      anim.play(\"default\");\n    }\n\n    self.barrierColliders = [];\n    for (let boundaryObj of boundaryObjs.barriers) {\n      const newBarrier = cc.instantiate(self.barrierPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\n      newBarrierColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.barrierColliders.push(newBarrierColliderIns);\n      self.node.addChild(newBarrier);\n    }\n    const allLayers = tiledMapIns.getLayers();\n    for (let layer of allLayers) {\n      const layerType = layer.getProperty(\"type\");\n      switch (layerType) {\n        case \"normal\":\n          setLocalZOrder(layer.node, 0);\n          break;\n        case \"barrier_and_shelter\":\n          setLocalZOrder(layer.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    const allObjectGroups = tiledMapIns.getObjectGroups();\n    for (let objectGroup of allObjectGroups) {\n      const objectGroupType = objectGroup.getProperty(\"type\");\n      switch (objectGroupType) {\n        case \"barrier_and_shelter\":\n          setLocalZOrder(objectGroup.node, 3);\n          break;\n        default:\n          break;\n      }\n    }\n\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\n      newShelter.setAnchorPoint(cc.v2(0, 0));\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\n      newShelterColliderIns.points = [];\n      for (let p of boundaryObj) {\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\n      }\n      self.node.addChild(newShelter);\n    }\n\n    window.handleClientSessionCloseOrError = function() {\n      let shouldReconnectState = parseInt(cc.sys.localStorage.getItem('shouldReconnectState'));\n      switch (shouldReconnectState) {\n        case 2:\n          shouldReconnectState = 1;\n          cc.sys.localStorage.setItem('shouldReconnectState', shouldReconnectState);\n          cc.log(\"Reconnecting because 2 == shouldReconnectState and it's now set to 1.\");\n          window.initPersistentSessionClient(self.initAfterWSConncted);\n          return;\n        case 1:\n          cc.log(\"Neither reconnecting nor alerting because 1 == shouldReconnectState and it's now removed.\");\n          cc.sys.localStorage.removeItem(\"shouldReconnectState\");\n          return;\n        default:\n          break;\n      }\n\n      //手动退出不应该弹窗报错\n      if(cc.sys.localStorage.getItem('manuallyExit')){\n        console.warn('手动退出, 清除房间信息并回到登录页');\n        cc.sys.localStorage.removeItem('manuallyExit');\n        cc.sys.localStorage.removeItem(\"boundRoomId\");\n        if(cc.sys.platform == cc.sys.WECHAT_GAME){\n          cc.director.loadScene('wechatGameLogin');\n        }else{\n          cc.director.loadScene('login');\n        }\n      }else{ //意外断线\n        console.warn('意外断线');\n        if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\n          window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n          self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\n        }\n      }\n\n    };\n\n    self.initAfterWSConncted = () => {\n      const self = window.mapIns;\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n      Object.assign(self.selfPlayerInfo, {\n        id: self.selfPlayerInfo.playerId\n      });\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      self._inputControlEnabled = false;\n      self.setupInputControls();\n\n\n      window.handleRoomDownsyncFrame = function(diffFrame) {\n\n        if(0 < diffFrame.id && diffFrame.id < 10){\n          cc.log(diffFrame)\n        }\n\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\n        const refFrameId = diffFrame.refFrameId;\n        if (-99 == refFrameId) {\n          //显示倒计时\n          self.matchPlayersFinsihed(diffFrame.players);\n        } else if (-98 == refFrameId) {\n          //显示匹配玩家\n          if (window.initWxSdk) {\n            window.initWxSdk();\n          }\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n          if (!self.findingPlayerNode.parent) {\n            self.showPopopInCanvas(self.findingPlayerNode);\n          }\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.players);\n          return;\n        }\n\n        //根据downFrame显示游戏场景\n        const frameId = diffFrame.id;\n        if (frameId <= self.lastRoomDownsyncFrameId) {\n          // Log the obsolete frames?\n          return;\n        }\n        const isInitiatingFrame = (0 >= self.recentFrameCacheCurrentSize || 0 == refFrameId);\n        /*\n        if (frameId % 300 == 0) {\n          // WARNING: For testing only!\n          if (0 < frameId) {\n            self._lazilyTriggerResync(); \n          }\n          cc.log(`${JSON.stringify(diffFrame)}`);\n        }\n        */\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\n        if (\n          !isInitiatingFrame\n          && self.useDiffFrameAlgo\n          && (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\". \n          && null == cachedFullFrame\n        ) {\n          self._lazilyTriggerResync();\n          // Later incoming diffFrames will all suffice that `0 < self.recentFrameCacheCurrentSize && null == cachedFullFrame`, until `this._onResyncCompleted` is successfully invoked.\n          return;\n        }\n\n        if (isInitiatingFrame && 0 == refFrameId) {\n          // Reaching here implies that you've received the resync frame.\n          self._onResyncCompleted();\n        }\n        let countdownNanos = diffFrame.countdownNanos;\n        if (countdownNanos < 0) {\n          countdownNanos = 0;\n        }\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\n        if (isNaN(countdownSeconds)) {\n          cc.log(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\n        }\n        self.countdownLabel.string = countdownSeconds;\n        const roomDownsyncFrame = ( //根据refFrameId和diffFrame计算出新的一帧\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\n          ?\n          diffFrame\n          :\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\n        );\n\n\n        if (countdownNanos <= 0) {\n          self.onBattleStopped(roomDownsyncFrame.players);\n          return;\n        }\n        self._dumpToFullFrameCache(roomDownsyncFrame);\n        const sentAt = roomDownsyncFrame.sentAt;\n\n        const players = roomDownsyncFrame.players;\n        const playerIdStrList = Object.keys(players);\n        self.otherPlayerCachedDataDict = {};\n        for (let i = 0; i < playerIdStrList.length; ++i) {\n          const k = playerIdStrList[i];\n          const playerId = parseInt(k);\n          if (playerId == self.selfPlayerInfo.id) {\n            const immediateSelfPlayerInfo = players[k];\n            Object.assign(self.selfPlayerInfo, {\n              displayName: (null == immediateSelfPlayerInfo.displayName ? (null == immediateSelfPlayerInfo.name ? \"\" : immediateSelfPlayerInfo.name) : immediateSelfPlayerInfo.displayName),\n              x: immediateSelfPlayerInfo.x,\n              y: immediateSelfPlayerInfo.y,\n              speed: immediateSelfPlayerInfo.speed,\n              battleState: immediateSelfPlayerInfo.battleState,\n              score: immediateSelfPlayerInfo.score,\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\n            });\n            continue;\n          }\n          const anotherPlayer = players[k];\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\n        }\n\n        //update pumpkin Info \n        self.pumpkinInfoDict = {};\n        const pumpkin = roomDownsyncFrame.pumpkin;\n        const pumpkinsLocalIdStrList = Object.keys(pumpkin);\n        for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\n          const k = pumpkinsLocalIdStrList[i];\n          const pumpkinLocalIdInBattle = parseInt(k);\n          const pumpkinInfo = pumpkin[k];\n          self.pumpkinInfoDict[pumpkinLocalIdInBattle] = pumpkinInfo;\n        }\n\n\n        //update treasureInfoDict\n        self.treasureInfoDict = {};\n        const treasures = roomDownsyncFrame.treasures;\n        const treasuresLocalIdStrList = Object.keys(treasures);\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) { //直接根据最新帧的数据覆盖掉treasureInfoDict\n          const k = treasuresLocalIdStrList[i];\n          const treasureLocalIdInBattle = parseInt(k);\n          const treasureInfo = treasures[k];\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\n        }\n\n        //update acceleratorInfoDict\n        self.acceleratorInfoDict = {};\n        const accelartors = roomDownsyncFrame.speedShoes;\n        const accLocalIdStrList = Object.keys(accelartors);\n        for (let i = 0; i < accLocalIdStrList.length; ++i) {\n          const k = accLocalIdStrList[i];\n          const accLocalIdInBattle = parseInt(k);\n          const accInfo = accelartors[k];\n          self.acceleratorInfoDict[accLocalIdInBattle] = accInfo;\n        }\n\n        //update trapInfoDict\n        self.trapInfoDict = {};\n        const traps = roomDownsyncFrame.traps;\n        const trapsLocalIdStrList = Object.keys(traps);\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\n          const k = trapsLocalIdStrList[i];\n          const trapLocalIdInBattle = parseInt(k);\n          const trapInfo = traps[k];\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\n        }\n\n        self.trapBulletInfoDict = {};\n        const bullets = roomDownsyncFrame.bullets;\n        const bulletsLocalIdStrList = Object.keys(bullets);\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\n          const k = bulletsLocalIdStrList[i];\n          const bulletLocalIdInBattle = parseInt(k);\n          const bulletInfo = bullets[k];\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\n        }\n\n        //update guardTowerInfoDict\n        self.guardTowerInfoDict = {};\n        const guardTowers = roomDownsyncFrame.guardTowers;\n        const ids = Object.keys(guardTowers);\n        for (let i = 0; i < ids.length; ++i) {\n          const id = ids[i];\n          const localIdInBattle = parseInt(id);\n          const tower = guardTowers[id];\n          self.guardTowerInfoDict[localIdInBattle] = tower;\n        }\n\n\n        if (0 == self.lastRoomDownsyncFrameId) {\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\n          if (1 == frameId) {\n            // No need to prompt upon rejoined.\n            self.popupSimplePressToGo(i18n.t(\"gameTip.start\"));\n          }\n          self.onBattleStarted();\n        }\n        self.lastRoomDownsyncFrameId = frameId;\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\n      };\n    }\n\n\n\n    if(cc.sys.platform == cc.sys.WECHAT_GAME){\n      if(!window.wxLifeCycleListenerSetted){ //全局只在一开始调用一次\n        const query = wx.getLaunchOptionsSync().query;\n        const expectedRoomId = query['expectedRoomId'];\n        console.warn('By the share link to join room: ', expectedRoomId);\n        self.tryToJoinExpectedRoom(expectedRoomId);\n      }else{\n        //console.log('已监听生命周期函数, 不手动调用tryToJoinExpectedRoom');\n        if(cc.sys.localStorage.getItem('expectedRoomId')){\n          console.warn('++++++: 小游戏通过expectedRoomId尝试重连游戏');\n          self.tryToJoinExpectedRoom(cc.sys.localStorage.getItem('expectedRoomId'));\n        }\n      }\n    }else{ \n      //其他登录方式: 基本上是通过localStorage.boundRoomId来重连\n      self.tryToJoinExpectedRoom();\n    }\n\n    /*\n     * 监听小游戏生命周期\n     */\n    if(cc.sys.platform == cc.sys.WECHAT_GAME && !window.wxLifeCycleListenerSetted){\n      window.wxLifeCycleListenerSetted = true;\n\n      //测试用, 手动输入expRoomId进入房间\n      window.reconnectGameByExpectedRoomId = (expectedRoomId) => {\n        window.mapIns.tryToJoinExpectedRoom(expectedRoomId);\n      }\n\n      //onShow, 每次重新打开都判断是否需要加入指定房间, 通过分享链接进入时会带上expectedRoomId参数\n      wx.onShow((res) => {\n        console.warn('+++++++ 微信 onShow');\n        console.log(res);\n        if(res.query['expectedRoomId']){\n          console.warn('kobako: join room:  ', res.query['expectedRoomId']);\n          //window.reconnectGameByExpectedRoomId(res.query['expectedRoomId']);\n          //kobako: expectedRoomId唯一在对局结束后才清除, 用于小游戏断线重连\n          cc.sys.localStorage.setItem('expectedRoomId', res.query['expectedRoomId']);\n          //self.tryToJoinExpectedRoom(res.query['expectedRoomId']);\n        }\n      });\n\n      //onHide断开连接\n      wx.onHide((res) => {\n        console.warn('+++++++ 微信 onHide');\n        //console.log(res);\n\n        if(res.mode == 'hide'){ //按home键或者分享小程序\n          console.warn('onHide: hide');\n          //Do nothing\n        }else{ //其他情况下断连返回登录页\n          console.warn('onHide: back');\n          cc.sys.localStorage.setItem('manuallyExit', true);\n          window.closeWSConnection();\n          cc.sys.localStorage.removeItem('expectedRoomId');\n          //断开连接后, 立刻退回到LoginSdene\n          cc.director.loadScene('wechatGameLogin');\n        }\n      });\n    }\n\n  },\n\n\n\n\n  /*\n   * kobako: 隐藏规则弹窗后加入到指定房间\n   * 调用场景: 1. map.js onLoad()方法 2. 小游戏生命周期onShow函数\n   * @Param expectedRoomIdFromQuery: 通过小游戏链接进入时调用onShow方法, 参数会包含expectedRoomId\n   */\n  tryToJoinExpectedRoom(expectedRoomIdFromQuery){\n    const self = window.mapIns;\n\n    //检查是否处于空闲状态\n    /* 需注释, 因为会妨碍断线重连\n    if(self.battleState != ALL_BATTLE_STATES.WAITING){\n      console.warn('tryToJoinExpectedRoom: Not in waiting state');\n      return;\n    }\n    */\n\n\n    console.warn('Try To Join ExpectedRoom');\n\n    /*\n    * The following code snippet is a dirty fix.\n    */\n    let expectedRoomId = null;\n\n    if(expectedRoomIdFromQuery){\n      expectedRoomId = expectedRoomIdFromQuery;\n    }else{\n      const qDict = window.getQueryParamDict();\n      if (qDict) {\n        expectedRoomId = qDict[\"expectedRoomId\"];\n      } else {\n        if (window.history && window.history.state) {\n          expectedRoomId = window.history.state.expectedRoomId;\n        }\n      } \n    }\n\n    if (expectedRoomId) {\n      console.warn('expectedRoomId: ', expectedRoomId);\n      if(self.gameRuleNode != null && self.gameRuleNode.active != null){\n        self.gameRuleNode.active = false;\n      }\n      //kobako: 直接传expectedRoomId到初始化session函数\n      window.initPersistentSessionClient(self.initAfterWSConncted, expectedRoomId);\n      return;\n    } else if (cc.sys.localStorage.getItem('boundRoomId')){\n      console.warn('boundRoomId: ', cc.sys.localStorage.getItem('boundRoomId'));\n      if(self.gameRuleNode != null && self.gameRuleNode.active != null){\n        self.gameRuleNode.active = false;\n      }\n      window.initPersistentSessionClient(self.initAfterWSConncted);\n      return;\n    }else {\n      console.warn('Do not have expectedRoomId or boundRoomId, do nothing');\n    }\n  },\n\n  setupInputControls() {\n    const instance = window.mapIns;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const ctrl = joystickInputControllerScriptIns;\n    instance.ctrl = ctrl;\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n      instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true;\n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  onBattleStarted() {\n    console.log('On battle started!');\n    const self = window.mapIns;\n    if (self.musicEffectManagerScriptIns)\n      self.musicEffectManagerScriptIns.playBGM();\n    const canvasNode = self.canvasNode;\n    self.spawnSelfPlayer();\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    self.enableInputControls();\n    if (self.countdownToBeginGameNode.parent) {\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n    }\n  },\n\n  onBattleStopped(players) {\n    const self = this;\n    if (self.musicEffectManagerScriptIns) {\n      self.musicEffectManagerScriptIns.stopAllMusic();\n    }\n    const canvasNode = self.canvasNode;\n    const resultPanelNode = self.resultPanelNode;\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\n    resultPanelScriptIns.showPlayerInfo(players);\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage(); //清除cached boundRoomId\n    // Such that it doesn't execute \"update(dt)\" anymore. \n    self.selfPlayerNode.active = false;\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\n    self.showPopopInCanvas(resultPanelNode);\n\n    //clear player info\n    self.playersInfoNode.getComponent(\"PlayersInfo\").clearInfo();\n\n    //kobako: 清除expectedRoomId\n    cc.sys.localStorage.removeItem('expectedRoomId');\n  },\n\n  spawnSelfPlayer() {\n    const instance = this;\n    const joinIndex = this.selfPlayerInfo.joinIndex;\n    const newPlayerNode = this.playersNode[joinIndex];\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\n    newPlayerNode.setPosition(toStartWithPos);\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\n\n    instance.node.addChild(newPlayerNode);\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\n    instance.selfPlayerScriptIns.showArrowTipNode();\n\n    setLocalZOrder(newPlayerNode, 5);\n    instance.selfPlayerNode = newPlayerNode;\n  },\n\n  update(dt) {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    const canvasParentNode = canvasNode.parent;\n    if (null != window.boundRoomId) {\n      self.boundRoomIdLabel.string = window.boundRoomId;\n    }\n    if (null != self.selfPlayerInfo) {\n      const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n      playersScriptIns.updateData(self.selfPlayerInfo);\n      if (null != self.selfPlayerScriptIns) {\n        self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\n      }\n    }\n\n    let toRemoveAcceleratorNodeDict = {};\n    Object.assign(toRemoveAcceleratorNodeDict, self.acceleratorNodeDict);\n\n    let toRemovePlayerNodeDict = {};\n    Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\n\n    let toRemoveTreasureNodeDict = {};\n    Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\n\n    let toRemoveTrapNodeDict = {};\n    Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\n\n    let toRemovePumpkinNodeDict = {};\n    Object.assign(toRemovePumpkinNodeDict, self.pumpkinNodeDict);\n\n    /*\n    * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\n    */\n    let toRemoveBulletNodeDict = {};\n    Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\n\n    for (let k in self.otherPlayerCachedDataDict) {\n      const playerId = parseInt(k);\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\n      const newPos = cc.v2(\n        cachedPlayerData.x,\n        cachedPlayerData.y\n      );\n\n      //更新玩家信息展示\n      if (null != cachedPlayerData) {\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n        playersScriptIns.updateData(cachedPlayerData);\n      }\n      let targetNode = self.otherPlayerNodeDict[playerId];\n      if (!targetNode) {\n        targetNode = self.playersNode[cachedPlayerData.joinIndex];\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\n        self.otherPlayerNodeDict[playerId] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\n      aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\n\n\n\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y\n      );\n\n      const toMoveByVec = newPos.sub(oldPos);\n      const toMoveByVecMag = toMoveByVec.mag();\n      aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\n      const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\n      //const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\n      const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 1.0);\n      if (toMoveByVecMag < notToMoveDisThreshold) {\n        aControlledOtherPlayerScriptIns.activeDirection = { //任意一个值为0都不会改变方向\n          dx: 0,\n          dy: 0\n        };\n      } else {\n        if (toMoveByVecMag > toTeleportDisThreshold) { //如果移动过大 打印log但还是会移动\n          cc.log(`Player ${cachedPlayerData.id} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\n          aControlledOtherPlayerScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0\n          };\n          // TODO: Use `cc.Action`?\n          targetNode.setPosition(newPos);\n        } else {\n          // The common case which is suitable for interpolation.\n          const normalizedDir = {\n            dx: toMoveByVec.x / toMoveByVecMag,\n            dy: toMoveByVec.y / toMoveByVecMag,\n          };\n          aControlledOtherPlayerScriptIns.toMoveByVec = toMoveByVec;\n          aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\n\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n            aControlledOtherPlayerScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0,\n            };\n          } else {\n            aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\n          }\n        }\n      }\n\n\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\n        //console.log(newScheduledDirection);\n        aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\n      }\n\n      if (null != toRemovePlayerNodeDict[playerId]) {\n        delete toRemovePlayerNodeDict[playerId];\n      }\n\n\n    }\n\n    // 更新加速鞋显示 \n    for (let k in self.acceleratorInfoDict) {\n      const accLocalIdInBattle = parseInt(k);\n      const acceleratorInfo = self.acceleratorInfoDict[accLocalIdInBattle];\n      const newPos = cc.v2(\n        acceleratorInfo.x,\n        acceleratorInfo.y\n      );\n      let targetNode = self.acceleratorNodeDict[accLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.acceleratorPrefab);\n        self.acceleratorNodeDict[accLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      if (null != toRemoveAcceleratorNodeDict[accLocalIdInBattle]) {\n        delete toRemoveAcceleratorNodeDict[accLocalIdInBattle];\n      }\n    }\n    // 更新陷阱显示 \n    for (let k in self.trapInfoDict) {\n      const trapLocalIdInBattle = parseInt(k);\n      const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\n      const newPos = cc.v2(\n        trapInfo.x,\n        trapInfo.y\n      );\n      let targetNode = self.trapNodeDict[trapLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.trapPrefab);\n        self.trapNodeDict[trapLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\n        delete toRemoveTrapNodeDict[trapLocalIdInBattle];\n      }\n    }\n\n    // 更新陷阱塔显示 \n    for (let k in self.guardTowerInfoDict) {\n      const trapLocalIdInBattle = parseInt(k);\n      const towerInfo = self.guardTowerInfoDict[trapLocalIdInBattle];\n      const newPos = cc.v2(\n        towerInfo.x,\n        towerInfo.y\n      );\n      let targetNode = self.towerNodeDict[trapLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.guardTowerPrefab);\n        self.towerNodeDict[trapLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n    }\n\n    // 更新bullet显示 \n    for (let k in self.trapBulletInfoDict) {\n      const bulletLocalIdInBattle = parseInt(k);\n      const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\n      const newPos = cc.v2(\n        bulletInfo.x,\n        bulletInfo.y\n      );\n      let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.trapBulletPrefab);\n\n        //kobako: 创建子弹node的时候设置旋转角度\n        targetNode.rotation = (() => {\n          if (null == bulletInfo.startAtPoint || null == bulletInfo.endAtPoint) {\n            console.error(`Init bullet direction error, startAtPoint:${startAtPoint}, endAtPoint:${endAtPoint}`);\n            return 0;\n          } else {\n\n            //console.log(bulletInfo.startAtPoint, bulletInfo.endAtPoint);\n\n            const dx = bulletInfo.endAtPoint.x - bulletInfo.startAtPoint.x;\n            const dy = bulletInfo.endAtPoint.y - bulletInfo.startAtPoint.y;\n            const radian = (() => {\n              if (dx == 0) {\n                return Math.PI / 2;\n              } else {\n                return Math.abs(Math.atan(dy / dx));\n              }\n            })();\n            const angleTemp = radian * 180 / Math.PI;\n            const angle = (() => {\n              if (dx >= 0) {\n                if (dy >= 0) {\n                  //第一象限\n                  return 360 - angleTemp;\n                  //return angleTemp;\n                } else {\n                  //第四象限\n                  return angleTemp;\n                  //return -angleTemp;\n                }\n              } else {\n                if (dy >= 0) {\n                  //第二象限\n                  return 360 - (180 - angleTemp);\n                  //return 180 - angleTemp;\n                } else {\n                  //第三象限\n                  return 360 - (180 + angleTemp);\n                  //return 180 + angleTemp;\n                }\n              }\n            })();\n            return angle;\n          }\n        })();\n        //\n\n        self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      const aBulletScriptIns = targetNode.getComponent(\"Bullet\");\n      aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\n      aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \n\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y,\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const toMoveByVecMag = toMoveByVec.mag();\n      const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\n      const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\n      if (toMoveByVecMag < notToMoveDisThreshold) {\n        aBulletScriptIns.activeDirection = {\n          dx: 0,\n          dy: 0,\n        };\n      } else {\n        if (toMoveByVecMag > toTeleportDisThreshold) {\n          cc.log(`Bullet ${bulletLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\n          aBulletScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0\n          };\n          // TODO: Use `cc.Action`?\n          targetNode.setPosition(newPos);\n        } else {\n          // The common case which is suitable for interpolation.\n          const normalizedDir = {\n            dx: toMoveByVec.x / toMoveByVecMag,\n            dy: toMoveByVec.y / toMoveByVecMag,\n          };\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n            aBulletScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0,\n            };\n          } else {\n            aBulletScriptIns.activeDirection = normalizedDir;\n          }\n        }\n      }\n      if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\n        delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\n      }\n    }\n\n    //更新南瓜少年的显示\n    for (let k in self.pumpkinInfoDict) {\n      const pumpkinLocalIdInBattle = parseInt(k);\n      const pumpkinInfo = self.pumpkinInfoDict[pumpkinLocalIdInBattle];\n      const newPos = cc.v2(pumpkinInfo.x, pumpkinInfo.y);\n      let targetNode = self.pumpkinNodeDict[pumpkinLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.pumpkinPrefab);\n        self.pumpkinNodeDict[pumpkinLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n      const aPumpkinScriptIns = targetNode.getComponent(\"Pumpkin\");\n      aPumpkinScriptIns.localIdInBattle = pumpkinLocalIdInBattle;\n      aPumpkinScriptIns.linearSpeed = pumpkinInfo.linearSpeed * 1000000000; // The `pumpkin.LinearSpeed` on server-side is denoted in pts/nanoseconds. \n\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y,\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const toMoveByVecMag = toMoveByVec.mag();\n      const toTeleportDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 100);\n      const notToMoveDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 0.5);\n      if (toMoveByVecMag < notToMoveDisThreshold) {\n        aPumpkinScriptIns.activeDirection = {\n          dx: 0,\n          dy: 0,\n        };\n      } else {\n        if (toMoveByVecMag > toTeleportDisThreshold) {\n          cc.log(`Pumpkin ${pumpkinLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\n          aPumpkinScriptIns.activeDirection = {\n            dx: 0,\n            dy: 0\n          };\n          // TODO: Use `cc.Action`?\n          targetNode.setPosition(newPos);\n        } else {\n          // The common case which is suitable for interpolation.\n          const normalizedDir = {\n            dx: toMoveByVec.x / toMoveByVecMag,\n            dy: toMoveByVec.y / toMoveByVecMag,\n          };\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\n            aPumpkinScriptIns.activeDirection = {\n              dx: 0,\n              dy: 0,\n            };\n          } else {\n            aPumpkinScriptIns.activeDirection = normalizedDir;\n          }\n        }\n      }\n      if (null != toRemovePumpkinNodeDict[pumpkinLocalIdInBattle]) {\n        delete toRemovePumpkinNodeDict[pumpkinLocalIdInBattle];\n      }\n    }\n\n    // 更新宝物显示 \n    for (let k in self.treasureInfoDict) {\n      const treasureLocalIdInBattle = parseInt(k);\n      const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\n      const newPos = cc.v2(\n        treasureInfo.x,\n        treasureInfo.y\n      );\n      let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.treasurePrefab);\n        const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\n        treasureNodeScriptIns.setData(treasureInfo);\n        self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n\n      if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\n        delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\n      }\n      if (0 < targetNode.getNumberOfRunningActions()) {\n        // A significant trick to smooth the position sync performance!\n        continue;\n      }\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const durationSeconds = dt; // Using `dt` temporarily!\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\n    }\n\n    // Coping with removed players.\n    for (let k in toRemovePlayerNodeDict) {\n      const playerId = parseInt(k);\n      toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\n      delete self.otherPlayerNodeDict[playerId];\n    }\n\n    // Coping with removed pumpkins.\n    for (let k in toRemovePumpkinNodeDict) {\n      const pumpkinLocalIdInBattle = parseInt(k);\n      toRemovePumpkinNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\n      delete self.pumpkinNodeDict[pumpkinLocalIdInBattle];\n    }\n\n    // Coping with removed treasures.\n    for (let k in toRemoveTreasureNodeDict) {\n      const treasureLocalIdInBattle = parseInt(k);\n      const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\n      treasureScriptIns.playPickedUpAnimAndDestroy();\n      if (self.musicEffectManagerScriptIns) {\n        if (2 == treasureScriptIns.type) {\n          self.musicEffectManagerScriptIns.playHighScoreTreasurePicked();\n        } else {\n          self.musicEffectManagerScriptIns.playTreasurePicked();\n        }\n      }\n      delete self.treasureNodeDict[treasureLocalIdInBattle];\n    }\n\n    // Coping with removed traps.\n    for (let k in toRemoveTrapNodeDict) {\n      const trapLocalIdInBattle = parseInt(k);\n      toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\n      delete self.trapNodeDict[trapLocalIdInBattle];\n    }\n\n    // Coping with removed accelerators.\n    for (let k in toRemoveAcceleratorNodeDict) {\n      const accLocalIdInBattle = parseInt(k);\n      toRemoveAcceleratorNodeDict[k].parent.removeChild(toRemoveAcceleratorNodeDict[k]);\n      delete self.acceleratorNodeDict[accLocalIdInBattle];\n    }\n\n    // Coping with removed bullets.\n    for (let k in toRemoveBulletNodeDict) {\n      const bulletLocalIdInBattle = parseInt(k);\n      toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\n      delete self.trapBulletNodeDict[bulletLocalIdInBattle];\n      if (self.musicEffectManagerScriptIns) {\n        self.musicEffectManagerScriptIns.playCrashedByTrapBullet();\n      }\n    }\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const localClearance = function() {\n      window.closeWSConnection();\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      }\n      cc.sys.localStorage.removeItem('selfPlayer');\n\n      if(cc.sys.platform == cc.sys.WECHAT_GAME){\n        cc.director.loadScene('wechatGameLogin');\n      }else{\n        cc.director.loadScene('login');\n      }\n    };\n\n    const self = this;\n    if (cc.sys.localStorage.getItem('selfPlayer')) {\n      const selfPlayer = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\n      const requestContent = {\n        intAuthToken: selfPlayer.intAuthToken\n      }\n      try {\n        NetworkUtils.ajax({\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n          type: \"POST\",\n          data: requestContent,\n          success: function(res) {\n            if (res.ret != constants.RET_CODE.OK) {\n              cc.log(`Logout failed: ${res}.`);\n            }\n            localClearance();\n          },\n          error: function(xhr, status, errMsg) {\n            localClearance();\n          },\n          timeout: function() {\n            localClearance();\n          }\n        });\n      } catch (e) {} finally {\n        // For Safari (both desktop and mobile).\n        localClearance();\n      }\n    } else {\n      localClearance();\n    }\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.showPopopInCanvas(self.confirmLogoutNode);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n\n  initWSConnection(evt, cb) {\n    const self = this;\n    window.initPersistentSessionClient(self.initAfterWSConncted);\n    if (cb) {\n      cb()\n    }\n  },\n\n  showPopopInCanvas(toShowNode) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\n    setLocalZOrder(toShowNode, 10);\n  },\n\n  matchPlayersFinsihed(players) {\n    console.log(players);\n\n    const self = this;\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\n    findingPlayerScriptIns.updatePlayersInfo(players);\n    window.setTimeout(() => {\n      if (self.findingPlayerNode.parent) {\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\n        self.transitToState(ALL_MAP_STATES.VISUAL);\n        for (let i in players) {\n          //更新在线玩家信息面板的信息\n          const playerInfo = players[i];\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\n          playersScriptIns.updateData(playerInfo);\n        }\n      }\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\");\n      countDownScriptIns.setData();\n      self.showPopopInCanvas(self.countdownToBeginGameNode);\n      return;\n    }, 2000);\n  },\n\n});\n"]}