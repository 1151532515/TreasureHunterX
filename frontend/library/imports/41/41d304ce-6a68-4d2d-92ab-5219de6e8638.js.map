{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","cc","Class","extends","Component","properties","selfPlayer","canvasNode","type","Node","default","tiledAnimPrefab","Prefab","selfPlayerPrefab","npcPlayerPrefab","type2NpcPlayerPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","onDestroy","clearInterval","inputControlTimer","onLoad","self","mapNode","node","parent","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","confirmLogoutNode","instantiate","getComponent","width","height","initPersistentSessionClient","state","tiledMapIns","TiledMap","spawnSelfPlayer","_inputControlEnabled","setupInputControls","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","Animation","setPosition","posInMapNode","sizeInMapNode","setScale","origSize","setAnchorPoint","v2","safelyAddChild","setLocalZOrder","addClip","animationClip","play","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","x","y","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","getChildByName","sheltersZReducer","newShelter","newShelterColliderIns","instance","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","selfPlayerScriptIns","keyboardInputControllerScriptIns","setInterval","ctrl","activeDirection","dPjX","dPjY","newScheduledDirectionInWorldCoordinate","dx","dy","newScheduledDirectionInLocalCoordinate","scheduleNewDirection","enableInputControls","disableInputControls","newPlayer","uid","update","dt","transitToState","s","logout","JSON","parse","sys","localStorage","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","data","success","res","ret","RET_CODE","OK","log","closeFlag","closeWSConnection","removeItem","loadScene","onLogoutClicked","evt","getScale","onLogoutConfirmationDismissed","removeChild"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    selfPlayer: null,\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    selfPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    npcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    type2NpcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n  onDestroy () {\n    clearInterval(this.inputControlTimer)\n  },\n\n  onLoad() {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n    self.confirmLogoutNode.width = canvasNode.width;\n    self.confirmLogoutNode.height = canvasNode.height;\n\n    initPersistentSessionClient(() => {\n      self.state = ALL_MAP_STATES.VISUAL;\n      const tiledMapIns = self.node.getComponent(cc.TiledMap); \n      self.spawnSelfPlayer();\n      this._inputControlEnabled = true;\n      self.setupInputControls();\n\n      const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node); \n      for (let frameAnim of boundaryObjs.frameAnimations) {\n        const animNode = cc.instantiate(self.tiledAnimPrefab);  \n        const anim = animNode.getComponent(cc.Animation); \n        animNode.setPosition(frameAnim.posInMapNode);\n        animNode.width = frameAnim.sizeInMapNode.width;\n        animNode.height = frameAnim.sizeInMapNode.height;\n        animNode.setScale(frameAnim.sizeInMapNode.width/frameAnim.origSize.width, frameAnim.sizeInMapNode.height/frameAnim.origSize.height);\n        animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n        safelyAddChild(self.node, animNode);  \n        setLocalZOrder(animNode, 5);  \n        anim.addClip(frameAnim.animationClip, \"default\");\n        anim.play(\"default\");\n      } \n\n      self.barrierColliders = [];\n      for (let boundaryObj of boundaryObjs.barriers) {\n        const newBarrier = cc.instantiate(self.barrierPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newBarrier.setPosition(newBoundaryOffsetInMapNode);\n        newBarrier.setAnchorPoint(cc.v2(0, 0));\n        const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider); \n        newBarrierColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.barrierColliders.push(newBarrierColliderIns);\n        self.node.addChild(newBarrier);\n      }\n\n      const allLayers = tiledMapIns.getLayers();\n      for (let layer of allLayers) {\n        const layerType = layer.getProperty(\"type\"); \n        switch (layerType) {\n          case \"normal\":\n            setLocalZOrder(layer.node, 0);\n            break;\n          case \"barrier_and_shelter\":\n            setLocalZOrder(layer.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      const allObjectGroups = tiledMapIns.getObjectGroups(); \n      for (let objectGroup of allObjectGroups) {\n        const objectGroupType = objectGroup.getProperty(\"type\"); \n        switch (objectGroupType) {\n          case \"barrier_and_shelter\":\n            setLocalZOrder(objectGroup.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      if (this.joystickInputControllerNode.parent !== this.node.parent.parent.getChildByName('JoystickContainer')) {\n        this.joystickInputControllerNode.parent = this.node.parent.parent.getChildByName('JoystickContainer');\n      }\n      this.joystickInputControllerNode.parent.width = this.node.parent.width * 0.5;\n      this.joystickInputControllerNode.parent.height = this.node.parent.height;\n\n      for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n        const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newShelter.setPosition(newBoundaryOffsetInMapNode);\n        newShelter.setAnchorPoint(cc.v2(0, 0));\n        const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider); \n        newShelterColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.node.addChild(newShelter);\n      }\n    });\n  },\n\n  setupInputControls() {\n    const instance = this;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const selfPlayerScriptIns = instance.selfPlayer.getComponent(\"SelfPlayer\");\n    const keyboardInputControllerScriptIns = instance.keyboardInputControllerNode.getComponent(\"KeyboardControls\");\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n\n      const ctrl = keyboardInputControllerScriptIns.activeDirection.dPjX || keyboardInputControllerScriptIns.activeDirection.dPjY ? keyboardInputControllerScriptIns : joystickInputControllerScriptIns;\n\n      const newScheduledDirectionInWorldCoordinate = {\n        dx: ctrl.activeDirection.dPjX,\n        dy: ctrl.activeDirection.dPjY\n      };\n\n      const newScheduledDirectionInLocalCoordinate = newScheduledDirectionInWorldCoordinate;\n      selfPlayerScriptIns.scheduleNewDirection(newScheduledDirectionInLocalCoordinate);\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true; \n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  spawnSelfPlayer() {\n    const self = this;\n    const newPlayer = cc.instantiate(self.selfPlayerPrefab);\n    newPlayer.uid = 0;\n    newPlayer.setPosition(cc.v2(0, 0));\n    newPlayer.getComponent(\"SelfPlayer\").mapNode = self.node;\n\n    self.node.addChild(newPlayer);\n\n    setLocalZOrder(newPlayer, 5);\n    this.selfPlayer = newPlayer;\n  },\n\n  update(dt) {\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout() {\n    // Will be called within \"ConfirmLogou.js\".\n    const self = this;\n    const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const requestContent = {\n      intAuthToken: selfPlayer.intAuthToken\n    }\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n      type: \"POST\",\n      data: requestContent,\n      success: function(res) {\n        if (res.ret != constants.RET_CODE.OK) {\n          cc.log(`Logout failed: ${res}.`);\n        }\n        self.closeFlag = true;\n        window.closeWSConnection();\n        cc.sys.localStorage.removeItem('selfPlayer');\n        cc.director.loadScene('login');\n      }\n    });\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    const canvasNode = self.canvasNode;\n    self.confirmLogoutNode.setScale(1 / canvasNode.getScale());\n    safelyAddChild(canvasNode, self.confirmLogoutNode);\n    setLocalZOrder(self.confirmLogoutNode, 10);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n});\n\n"]}