{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","canvasNode","type","Node","default","tiledAnimPrefab","Prefab","selfPlayerPrefab","npcPlayerPrefab","type2NpcPlayerPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","selfPlayerIdLabel","Label","boundRoomIdLabel","countdownLabel","_onPerUpsyncFrame","instance","selfPlayerId","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","id","dir","dx","parseFloat","dy","x","selfPlayerNode","y","wrapped","msgId","Date","now","act","data","clientSession","send","JSON","stringify","onDestroy","self","upsyncLoopInterval","clearInterval","inputControlTimer","popupSimplePressToGo","labelString","state","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","getScale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","removeChild","string","once","dismissDialog","bind","safelyAddChild","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","onLoad","lastRoomDownsyncFrameId","mapNode","node","parent","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","battleState","otherPlayerNodeDict","otherPlayerCachedDataDict","confirmLogoutNode","width","height","clientUpsyncFps","handleRoomJoinResp","resp","ret","constants","RET_CODE","LOCALLY_NO_SPECIFIED_ROOM","PLAYER_NOT_ADDABLE_TO_ROOM","PLAYER_NOT_READDABLE_TO_ROOM","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleClientSessionCloseOrError","initPersistentSessionClient","tiledMapIns","TiledMap","selfPlayerInfo","parse","sys","localStorage","selfPlayer","spawnSelfPlayer","_inputControlEnabled","setupInputControls","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","Animation","posInMapNode","sizeInMapNode","origSize","setAnchorPoint","setLocalZOrder","addClip","animationClip","play","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","setInterval","handleDownsyncRoomFrame","roomDownsyncFrame","parseInt","countdownNanos","toString","frameId","sentAt","refFrameId","players","playerIdStrList","Object","keys","i","length","k","playerId","anotherPlayer","renderAnotherControlledPlayer","anotherPlayerCachedData","targetNode","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","newScheduledDirectionInWorldCoordinate","activeDirection","dPjX","dPjY","newScheduledDirectionInLocalCoordinate","scheduleNewDirection","enableInputControls","disableInputControls","newPlayerNode","update","dt","boundRoomId","cachedPlayerData","newPos","speed","getNumberOfRunningActions","newScheduledDirection","discretizeDirection","joyStickEps","oldPos","toMoveByVec","durationSeconds","mag","runAction","moveTo","s","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","OK","log","closeWSConnection","removeItem","loadScene","onLogoutClicked","evt","onLogoutConfirmationDismissed"],"mappings":"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","file":"Map.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\n\nwindow.ALL_MAP_STATES = {\n  VISUAL: 0, // For free dragging & zooming.\n  EDITING_BELONGING: 1,\n  SHOWING_MODAL_POPUP: 2,\n};\n\nwindow.ALL_BATTLE_STATES = {\n  WAITING: 0,\n  IN_BATTLE: 1,\n  IN_SETTLEMENT: 2,\n  IN_DISMISSAL: 3,\n};\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    canvasNode: {\n      type: cc.Node,\n      default: null,\n    },\n    tiledAnimPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    selfPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    npcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    type2NpcPlayerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    barrierPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    shelterZReducerPrefab: {\n      type: cc.Prefab,\n      default: null, \n    },\n    keyboardInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    joystickInputControllerNode: {\n      type: cc.Node,\n      default: null\n    },\n    confirmLogoutPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    simplePressToGoDialogPrefab: {\n      type: cc.Prefab,\n      default: null\n    },\n    selfPlayerIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    boundRoomIdLabel: {\n      type: cc.Label,\n      default: null\n    },\n    countdownLabel: {\n      type: cc.Label,\n      default: null\n    },\n  },\n\n  _onPerUpsyncFrame() {\n    const instance = this; \n    if (\n      null == instance.selfPlayerId ||\n      null == instance.selfPlayerScriptIns ||\n      null == instance.selfPlayerScriptIns.scheduledDirection\n    ) return;\n    const upsyncFrameData = {\n      id: instance.selfPlayerId,\n      dir: {\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\n      },\n      x: parseFloat(instance.selfPlayerNode.x),\n      y: parseFloat(instance.selfPlayerNode.y), \n    };\n    const wrapped = {\n      msgId: Date.now(),\n      act: \"PlayerUpsyncCmd\",\n      data: upsyncFrameData, \n    }\n    window.clientSession.send(JSON.stringify(wrapped)); \n  },\n\n  // LIFE-CYCLE CALLBACKS:\n  onDestroy() {\n    const self = this;\n    if (self.upsyncLoopInterval) {\n      clearInterval(self.upsyncLoopInterval);\n    }\n    if (self.inputControlTimer) {\n      clearInterval(self.inputControlTimer)\n    }\n  },\n\n  popupSimplePressToGo(labelString) {\n    const self = this;\n    if (ALL_MAP_STATES.VISUAL != self.state) {\n      return;\n    }\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\n\n    const canvasNode = self.canvasNode;\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\n    simplePressToGoDialogNode.setScale(1 / canvasNode.getScale());\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\n    const postDismissalByYes = () => {\n      self.transitToState(ALL_MAP_STATES.VISUAL);\n      canvasNode.removeChild(simplePressToGoDialogNode);\n    }\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    simplePressToGoDialogNode.setScale(1 / canvasNode.getScale());\n    safelyAddChild(canvasNode, simplePressToGoDialogNode);\n  },\n\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    const millisToGo = 3000;\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s Will logout in %s seconds.\", labelString, millisToGo/1000));\n    setTimeout(() => {\n      mapIns.logout(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\n    }, millisToGo);\n  },\n\n  onLoad() {\n    const self = this;\n    self.lastRoomDownsyncFrameId = 0;\n\n    self.selfPlayerNode = null;\n    self.selfPlayerScriptIns = null;\n    self.selfPlayerId = null;\n\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    cc.director.getCollisionManager().enabled = true;\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\n\n    self.battleState = ALL_BATTLE_STATES.WAITING;\n    self.otherPlayerNodeDict = {};\n    self.otherPlayerCachedDataDict = {};\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\n    self.confirmLogoutNode.width = canvasNode.width;\n    self.confirmLogoutNode.height = canvasNode.height;\n\n    self.clientUpsyncFps = 24;\n    self.upsyncLoopInterval = null;\n\n    window.handleRoomJoinResp = function(resp) {\n      switch (resp.ret) {\n        case constants.RET_CODE.LOCALLY_NO_SPECIFIED_ROOM:\n        case constants.RET_CODE.PLAYER_NOT_ADDABLE_TO_ROOM:\n        case constants.RET_CODE.PLAYER_NOT_READDABLE_TO_ROOM:\n          window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n          break;\n        default:\n          break;\n      }\n    };\n\n    window.handleClientSessionCloseOrError = function() {\n      self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\n    }; \n\n    initPersistentSessionClient(() => {\n      self.state = ALL_MAP_STATES.VISUAL;\n      const tiledMapIns = self.node.getComponent(cc.TiledMap); \n      const selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\n      self.spawnSelfPlayer(selfPlayerInfo);\n      this._inputControlEnabled = true;\n      self.setupInputControls();\n\n      const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node); \n      for (let frameAnim of boundaryObjs.frameAnimations) {\n        const animNode = cc.instantiate(self.tiledAnimPrefab);  \n        const anim = animNode.getComponent(cc.Animation); \n        animNode.setPosition(frameAnim.posInMapNode);\n        animNode.width = frameAnim.sizeInMapNode.width;\n        animNode.height = frameAnim.sizeInMapNode.height;\n        animNode.setScale(frameAnim.sizeInMapNode.width/frameAnim.origSize.width, frameAnim.sizeInMapNode.height/frameAnim.origSize.height);\n        animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\n        safelyAddChild(self.node, animNode);  \n        setLocalZOrder(animNode, 5);  \n        anim.addClip(frameAnim.animationClip, \"default\");\n        anim.play(\"default\");\n      } \n\n      self.barrierColliders = [];\n      for (let boundaryObj of boundaryObjs.barriers) {\n        const newBarrier = cc.instantiate(self.barrierPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newBarrier.setPosition(newBoundaryOffsetInMapNode);\n        newBarrier.setAnchorPoint(cc.v2(0, 0));\n        const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider); \n        newBarrierColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.barrierColliders.push(newBarrierColliderIns);\n        self.node.addChild(newBarrier);\n      }\n\n      const allLayers = tiledMapIns.getLayers();\n      for (let layer of allLayers) {\n        const layerType = layer.getProperty(\"type\"); \n        switch (layerType) {\n          case \"normal\":\n            setLocalZOrder(layer.node, 0);\n            break;\n          case \"barrier_and_shelter\":\n            setLocalZOrder(layer.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      const allObjectGroups = tiledMapIns.getObjectGroups(); \n      for (let objectGroup of allObjectGroups) {\n        const objectGroupType = objectGroup.getProperty(\"type\"); \n        switch (objectGroupType) {\n          case \"barrier_and_shelter\":\n            setLocalZOrder(objectGroup.node, 3);\n            break;\n          default:\n            break;\n        }\n      }\n\n      if (this.joystickInputControllerNode.parent !== this.node.parent.parent.getChildByName('JoystickContainer')) {\n        this.joystickInputControllerNode.parent = this.node.parent.parent.getChildByName('JoystickContainer');\n      }\n      this.joystickInputControllerNode.parent.width = this.node.parent.width * 0.5;\n      this.joystickInputControllerNode.parent.height = this.node.parent.height;\n\n      for (let boundaryObj of boundaryObjs.sheltersZReducer) {\n        const newShelter = cc.instantiate(self.shelterZReducerPrefab);\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y); \n        newShelter.setPosition(newBoundaryOffsetInMapNode);\n        newShelter.setAnchorPoint(cc.v2(0, 0));\n        const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider); \n        newShelterColliderIns.points = [];\n        for (let p of boundaryObj) {\n          newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode)); \n        }  \n        self.node.addChild(newShelter);\n      }\n      self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\n      window.handleDownsyncRoomFrame = function(roomDownsyncFrame) {\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\n\n        self.countdownLabel.string = parseInt(roomDownsyncFrame.countdownNanos/1000000000).toString();\n        const frameId = roomDownsyncFrame.id;\n        if (frameId <= self.lastRoomDownsyncFrameId) return;\n        if (roomDownsyncFrame.countdownNanos == -1) {\n          self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\n          self.alertForGoingBackToLoginScene(\"Battle stopped!\", self, false)\n        }\n        if (0 == self.lastRoomDownsyncFrameId) {\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\n          self.popupSimplePressToGo(\"Battle started!\");\n        }\n        self.lastRoomDownsyncFrameId = frameId;\n        const sentAt = roomDownsyncFrame.sentAt;\n        const refFrameId = roomDownsyncFrame.refFrameId;\n        const players = roomDownsyncFrame.players;\n        const playerIdStrList = Object.keys(players);\n        for (let i = 0; i < playerIdStrList.length; ++i) {\n          const k = playerIdStrList[i];\n          const playerId = parseInt(k);\n          if (playerId == self.selfPlayerId) continue;\n          const anotherPlayer = players[k]; \n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer; \n        } \n        // TODO: Cope with removed players.\n        // TODO: Cope with FullFrame reconstruction by `refFrameId` and a cache of recent FullFrames.\n        // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\n      };\n    });\n  },\n\n  renderAnotherControlledPlayer: (mapIns, anotherPlayerCachedData, targetNode) => {\n    const mapNode = mapIns.node;\n  }, \n\n  setupInputControls() {\n    const instance = this;\n    const mapNode = instance.node;\n    const canvasNode = mapNode.parent;\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\n\n    const ctrl = joystickInputControllerScriptIns;\n    instance.ctrl = ctrl;\n\n    instance.inputControlTimer = setInterval(function() {\n      if (false == instance._inputControlEnabled) return;\n\n      const newScheduledDirectionInWorldCoordinate = {\n        dx: ctrl.activeDirection.dPjX,\n        dy: ctrl.activeDirection.dPjY\n      };\n\n      const newScheduledDirectionInLocalCoordinate = newScheduledDirectionInWorldCoordinate;\n      instance.selfPlayerScriptIns.scheduleNewDirection(newScheduledDirectionInLocalCoordinate);\n    }, inputControlPollerMillis);\n  },\n\n  enableInputControls() {\n    this._inputControlEnabled = true; \n  },\n\n  disableInputControls() {\n    this._inputControlEnabled = false;\n  },\n\n  spawnSelfPlayer(selfPlayerInfo) {\n    const instance = this;\n    const newPlayerNode = cc.instantiate(instance.selfPlayerPrefab);\n    newPlayerNode.setPosition(cc.v2(0, 0));\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\n\n    instance.node.addChild(newPlayerNode);\n\n    setLocalZOrder(newPlayerNode, 5);\n    instance.selfPlayerNode = newPlayerNode;\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\n    instance.selfPlayerId = selfPlayerInfo.playerId;\n  },\n\n  update(dt) {\n    const self = this;\n    const mapNode = self.node;\n    const canvasNode = mapNode.parent;\n    if (null != window.boundRoomId) {\n      self.boundRoomIdLabel.string = window.boundRoomId;  \n    }\n    if (null != self.selfPlayerId) {\n      self.selfPlayerIdLabel.string = self.selfPlayerId; \n    }\n    for (let k in self.otherPlayerCachedDataDict) {\n      const playerId = parseInt(k);\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId]; \n      const newPos = cc.v2(\n        cachedPlayerData.x, \n        cachedPlayerData.y\n      );\n      let targetNode = self.otherPlayerNodeDict[playerId];\n      if (!targetNode) {\n        targetNode = cc.instantiate(self.selfPlayerPrefab);\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\n        targetNode.getComponent(\"SelfPlayer\").speed = 0; // A dirty fix to prevent jittering.\n        self.otherPlayerNodeDict[playerId] = targetNode;\n        safelyAddChild(mapNode, targetNode);\n        targetNode.setPosition(newPos);\n        setLocalZOrder(targetNode, 5);\n      }\n\n      if (0 < targetNode.getNumberOfRunningActions()) {\n        // A significant trick to smooth the position sync performance!\n        continue; \n      }\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) { \n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);  \n        targetNode.getComponent(\"SelfPlayer\").scheduleNewDirection(newScheduledDirection, true);\n      }\n      const oldPos = cc.v2(\n        targetNode.x,\n        targetNode.y\n      );\n      const toMoveByVec = newPos.sub(oldPos);\n      const durationSeconds = toMoveByVec.mag()/self.selfPlayerScriptIns.speed;\n      // cc.log(`Moving targetNode from <${oldPos.x}, ${oldPos.y}> to <${newPos.x}, ${newPos.y}> in ${durationSeconds} seconds.`);\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\n    }\n    // TODO: Cope with removed players.\n  },\n\n  transitToState(s) {\n    const self = this;\n    self.state = s;\n  },\n\n  logout(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n    // Will be called within \"ConfirmLogout.js\".\n    const self = this;\n    if (null != cc.sys.localStorage.selfPlayer) {\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n      const requestContent = {\n        intAuthToken: selfPlayer.intAuthToken\n      }\n      NetworkUtils.ajax({\n        url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\n        type: \"POST\",\n        data: requestContent,\n        success: function(res) {\n          if (res.ret != constants.RET_CODE.OK) {\n            cc.log(`Logout failed: ${res}.`);\n          }\n          window.closeWSConnection();\n          if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n            window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n          }\n          cc.sys.localStorage.removeItem('selfPlayer');\n          cc.director.loadScene('login');\n        }\n      });\n    } else {\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n      }\n      cc.sys.localStorage.removeItem('selfPlayer');\n      cc.director.loadScene('login');\n    }\n  },\n\n  onLogoutClicked(evt) {\n    const self = this;\n    self.disableInputControls();\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\n    const canvasNode = self.canvasNode;\n    self.confirmLogoutNode.setScale(1 / canvasNode.getScale());\n    safelyAddChild(canvasNode, self.confirmLogoutNode);\n    setLocalZOrder(self.confirmLogoutNode, 10);\n  },\n\n  onLogoutConfirmationDismissed() {\n    const self = this;\n    self.transitToState(ALL_MAP_STATES.VISUAL);\n    const canvasNode = self.canvasNode;\n    canvasNode.removeChild(self.confirmLogoutNode);\n    self.enableInputControls();\n  },\n});\n\n"]}