{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Login.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","cavasNode","default","type","Node","backgroundNode","interactiveControls","phoneCountryCodeInput","phoneNumberInput","phoneNumberTips","smsLoginCaptchaInput","smsLoginCaptchaButton","captchaTips","loginButton","smsWaitCountdownPrefab","Prefab","loadingPrefab","wechatLoginButton","Button","wechatLoginTips","Label","onLoad","self","getRetCodeList","getRegexList","checkPhoneNumber","bind","checkIntAuthTokenExpire","checkCaptcha","onSMSCaptchaGetButtonClicked","on","loadingNode","instantiate","smsGetCaptchaNode","getChildByName","smsWaitCountdownNode","loader","loadRes","err","textAsset","error","message","protoRoot","protobuf","Root","parse","text","RoomDownsyncFrame","lookupType","then","intAuthToken","JSON","sys","localStorage","selfPlayer","useTokenLogin","code","getQueryVariable","log","useWXCodeLogin","retCodeDict","constants","RET_CODE","regexList","EMAIL","PHONE","STREET_META","LNG_LAT_TEXT","SEO_KEYWORD","PASSWORD","SMS_CAPTCHA_CODE","ADMIN_HANDLE","evt","timerEnable","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","SMS_CAPTCHA","GET","data","phoneCountryCode","getComponent","EditBox","string","phoneNum","success","res","ret","OK","DUPLICATED","ALERT","TIP_LABEL","LOG_OUT","INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER","t","IS_TEST_ACC","smsLoginCaptcha","SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY","countdownTime","off","removeChild","parent","total","countdownTimer","setInterval","clearInterval","Promise","resolve","reject","Date","getTime","expiresAt","phoneNumberRegexp","phoneNumberString","test","captchaRegexp","captchaString","length","_intAuthToken","INT_AUTH_TOKEN","LOGIN","resp","onLoggedIn","xhr","status","errMsg","clearBoundRoomIdInBothVolatileAndPersistentStorage","timeout","enableInteractiveControls","enabled","interactable","setVisible","setInvisible","onLoginButtonClicked","loginParams","onWechatLoggedIn","stringify","date","Number","playerId","displayName","qDict","boundRoomId","Object","assign","expectedRoomId","history","replaceState","location","pathname","removeItem","WECHAT_LOGIN_FAILS","initWxSdk","inputControls","safelyAddChild","runAction","repeatForever","rotateBy","director","loadScene","TOKEN_EXPIRED","SMS_CAPTCHA_NOT_MATCH","INCORRECT_CAPTCHA","SMS_CAPTCHA_CODE_NOT_EXISTING","INCORRECT_PHONE_NUMBER","INVALID_REQUEST_PARAM","INCORRECT_PHONE_COUNTRY_CODE","variable","query","search","substring","vars","split","i","pair","_code","WECHAT","getWechatCode","wechatServerEndpoint","wechatAddress","trim","AUTHORIZE_PATH","APPID_LITERAL","REDIRECT_RUI_KEY","encode","href","RESPONSE_TYPE","SCOPE","FIN","undefined","wx","warn","origUrl","protocol","host","shareLink","updateAppMsgShareDataObj","dataUrl","title","document","desc","link","imgUrl","menuShareTimelineObj","JSCONFIG","console","jsConfig","configData","debug","CC_DEBUG","appId","app_id","timestamp","toString","nonceStr","nonce_str","jsApiList","signature","config","ready","onMenuShareAppMessage","onMenuShareTimeline"],"mappings":"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","file":"Login.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    cavasNode: {\n      default: null,\n      type: cc.Node\n    },\n    backgroundNode: {\n      default: null,\n      type: cc.Node\n    },\n    interactiveControls: {\n      default: null,\n      type: cc.Node\n    },\n    phoneCountryCodeInput: {\n      default: null,\n      type: cc.Node\n    },\n    phoneNumberInput: {\n      type: cc.Node,\n      default: null\n    },\n    phoneNumberTips: {\n      type: cc.Node,\n      default: null\n    },\n    smsLoginCaptchaInput: {\n      type: cc.Node,\n      default: null\n    },\n    smsLoginCaptchaButton: {\n      type: cc.Node,\n      default: null\n    },\n    captchaTips: {\n      type: cc.Node,\n      default: null\n    },\n    loginButton: {\n      type: cc.Node,\n      default: null\n    },\n    smsWaitCountdownPrefab: {\n      default: null,\n      type: cc.Prefab\n    },\n    loadingPrefab: {\n      default: null,\n      type: cc.Prefab\n    },\n    wechatLoginButton: {\n      default: null,\n      type: cc.Button,\n    },\n    wechatLoginTips: {\n      default: null,\n      type: cc.Label,\n    },\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    const self = this;\n    self.getRetCodeList();\n    self.getRegexList();\n    self.checkPhoneNumber = self.checkPhoneNumber.bind(self);\n    self.checkIntAuthTokenExpire = self.checkIntAuthTokenExpire.bind(self);\n    self.checkCaptcha = self.checkCaptcha.bind(self);\n    self.onSMSCaptchaGetButtonClicked = self.onSMSCaptchaGetButtonClicked.bind(self);\n    self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\n\n    self.loadingNode = cc.instantiate(this.loadingPrefab);\n    self.smsGetCaptchaNode = self.smsLoginCaptchaButton.getChildByName('smsGetCaptcha');\n    self.smsWaitCountdownNode = cc.instantiate(self.smsWaitCountdownPrefab);\n\n    cc.loader.loadRes(\"pbfiles/room_downsync_frame\", function(err, textAsset /* cc.TextAsset */ ) {\n      if (err) {\n        cc.error(err.message || err);\n        return;\n      }\n      let protoRoot = new protobuf.Root;\n      protobuf.parse(textAsset.text, protoRoot);\n      window.RoomDownsyncFrame = protoRoot.lookupType(\"models.RoomDownsyncFrame\");\n      self.checkIntAuthTokenExpire().then(\n        () => {\n          const intAuthToken = JSON.parse(cc.sys.localStorage.selfPlayer).intAuthToken;\n          self.useTokenLogin(intAuthToken);\n        },\n        () => {\n          // TODO: Handle expired intAuthToken appropriately.\n          const code = self.getQueryVariable(\"code\");\n          if (code) {\n            //TODO: 请求credentialsAuthToken api with code\n            cc.log(\"Got the code: \" + code);\n            self.useWXCodeLogin(code);\n          }\n        }\n      );\n    });\n  },\n\n  getRetCodeList() {\n    const self = this;\n    self.retCodeDict = constants.RET_CODE;\n  },\n\n  getRegexList() {\n    const self = this;\n    self.regexList = {\n      EMAIL: /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/,\n      PHONE: /^\\+?[0-9]{8,14}$/,\n      STREET_META: /^.{5,100}$/,\n      LNG_LAT_TEXT: /^[0-9]+(\\.[0-9]{4,6})$/,\n      SEO_KEYWORD: /^.{2,50}$/,\n      PASSWORD: /^.{6,50}$/,\n      SMS_CAPTCHA_CODE: /^[0-9]{4}$/,\n      ADMIN_HANDLE: /^.{4,50}$/,\n    };\n  },\n\n  onSMSCaptchaGetButtonClicked(evt) {\n    var timerEnable = true;\n    const self = this;\n    if (!self.checkPhoneNumber('getCaptcha')) {\n      return;\n    }\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.GET,\n      type: 'GET',\n      data: {\n        phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n        phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string\n      },\n      success: function(res) {\n        switch (res.ret) {\n          case self.retCodeDict.OK:\n            self.phoneNumberTips.getComponent(cc.Label).string = '';\n            self.captchaTips.getComponent(cc.Label).string = '';\n            break;\n          case self.retCodeDict.DUPLICATED:\n            self.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n            break;\n          case self.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n            break;\n          case self.retCodeDict.IS_TEST_ACC:\n            self.smsLoginCaptchaInput.getComponent(cc.EditBox).string = res.smsLoginCaptcha;\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.TEST_USER\");\n            timerEnable = false;\n            // clearInterval(self.countdownTimer);\n            break;\n          case self.retCodeDict.SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_FREEQUENT_REQUIRE\");\n          default:\n            break;\n        }\n        if (timerEnable)\n          self.countdownTime(self);\n      }\n    });\n  },\n\n  countdownTime(self) {\n    self.smsLoginCaptchaButton.off('click', self.onSMSCaptchaGetButtonClicked);\n    self.smsLoginCaptchaButton.removeChild(self.smsGetCaptchaNode);\n    self.smsWaitCountdownNode.parent = self.smsLoginCaptchaButton;\n    var total = 20; // Magic number\n    self.countdownTimer = setInterval(function() {\n      if (total === 0) {\n        self.smsWaitCountdownNode.parent.removeChild(self.smsWaitCountdownNode);\n        self.smsGetCaptchaNode.parent = self.smsLoginCaptchaButton;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = 20;\n        self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\n        clearInterval(self.countdownTimer);\n      } else {\n        total--;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = total;\n      }\n    }, 1000)\n\n  },\n\n  checkIntAuthTokenExpire() {\n    return new Promise((resolve, reject) => {\n      if (!cc.sys.localStorage.selfPlayer) {\n        reject();\n        return;\n      }\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n      (selfPlayer.intAuthToken && new Date().getTime() < selfPlayer.expiresAt) ? resolve() : reject();\n    })\n  },\n\n  checkPhoneNumber(type) {\n    const self = this;\n    const phoneNumberRegexp = self.regexList.PHONE;\n    var phoneNumberString = self.phoneNumberInput.getComponent(cc.EditBox).string;\n    if (phoneNumberString) {\n      return true;\n      if (!phoneNumberRegexp.test(phoneNumberString)) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'getCaptcha' || type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n      }\n      return false;\n    }\n  },\n\n  checkCaptcha(type) {\n    const self = this;\n    const captchaRegexp = self.regexList.SMS_CAPTCHA_CODE;\n    var captchaString = self.smsLoginCaptchaInput.getComponent(cc.EditBox).string;\n\n    if (captchaString) {\n      if (self.smsLoginCaptchaInput.getComponent(cc.EditBox).string.length !== 4 || (!captchaRegexp.test(captchaString))) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n      }\n      return false;\n    }\n  },\n\n  useTokenLogin(_intAuthToken) {\n    var self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        intAuthToken: _intAuthToken\n      },\n      success: function(resp) {\n        self.onLoggedIn(resp);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"useTokenLogin\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\n      },\n      timeout: function() {\n        self.enableInteractiveControls(true);\n      },\n    });\n  },\n\n  enableInteractiveControls(enabled) {\n    this.smsLoginCaptchaButton.getComponent(cc.Button).interactable = enabled;\n    this.loginButton.getComponent(cc.Button).interactable = enabled;\n    this.phoneCountryCodeInput.getComponent(cc.EditBox).enabled = enabled;\n    this.phoneNumberInput.getComponent(cc.EditBox).enabled = enabled;\n    this.smsLoginCaptchaInput.getComponent(cc.EditBox).enabled = enabled;\n    if (enabled) {\n      setVisible(this.interactiveControls);\n    } else {\n      setInvisible(this.interactiveControls);\n    }\n  },\n\n  onLoginButtonClicked(evt) {\n    const self = this;\n    if (!self.checkPhoneNumber('login') || !self.checkCaptcha('login')) {\n      return;\n    }\n    self.loginParams = {\n      phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n      phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string,\n      smsLoginCaptcha: self.smsLoginCaptchaInput.getComponent(cc.EditBox).string\n    };\n    self.enableInteractiveControls(false);\n\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: self.loginParams,\n      success: function(resp) {\n        self.onLoggedIn(resp);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\n      },\n      timeout: function() {\n        self.enableInteractiveControls(true);\n      }\n    });\n  },\n  onWechatLoggedIn(res) {\n    const self = this;\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\n    if (res.ret === self.retCodeDict.OK) {\n      self.enableInteractiveControls(false);\n      const date = Number(res.expiresAt);\n      const selfPlayer = {\n        expiresAt: date,\n        playerId: res.playerId,\n        intAuthToken: res.intAuthToken,\n        displayName: res.displayName\n      }\n      cc.sys.localStorage.selfPlayer = JSON.stringify(selfPlayer);\n      cc.log(`cc.sys.localStorage.selfPlayer = ${cc.sys.localStorage.selfPlayer}`);  \n      const qDict = {};\n      if (null != cc.sys.localStorage.boundRoomId) {\n        Object.assign(qDict, {\n          expectedRoomId: cc.sys.localStorage.boundRoomId,\n        });\n      }\n      window.history.replaceState(qDict, null, window.location.pathname); \n      self.useTokenLogin(res.intAuthToken);\n    }  else {\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\n      self.wechatLoginTips.string = constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorCode = \" + res.ret;\n      window.history.replaceState({}, null, window.location.pathname);\n    }\n  },\n\n  onLoggedIn(res) {\n    const self = this;\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\n    if (res.ret === self.retCodeDict.OK) {\n      self.enableInteractiveControls(false);\n      const date = Number(res.expiresAt);\n      const selfPlayer = {\n        expiresAt: date,\n        playerId: res.playerId,\n        intAuthToken: res.intAuthToken,\n        displayName: res.displayName\n      }\n      cc.sys.localStorage.selfPlayer = JSON.stringify(selfPlayer);\n      cc.log(`cc.sys.localStorage.selfPlayer = ${cc.sys.localStorage.selfPlayer}`);\n      window.initWxSdk = self.initWxSdk.bind(self);\n      window.initWxSdk();\n      if (self.countdownTimer) {\n        clearInterval(self.countdownTimer);\n      }\n      const inputControls = self.backgroundNode.getChildByName(\"InteractiveControls\");\n      self.backgroundNode.removeChild(inputControls);\n      safelyAddChild(self.backgroundNode, self.loadingNode);\n      self.loadingNode.getChildByName('loadingSprite').runAction(\n        cc.repeatForever(cc.rotateBy(1.0, 360))\n      );\n      cc.director.loadScene('default_map');\n    } else {\n      cc.sys.localStorage.removeItem(\"selfPlayer\");\n      self.enableInteractiveControls(true);\n      switch (res.ret) {\n        case self.retCodeDict.DUPLICATED:\n          this.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n          break;\n        case this.retCodeDict.TOKEN_EXPIRED:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.TOKEN_EXPIRED;\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_NOT_MATCH:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_CAPTCHA:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_CODE_NOT_EXISTING:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_NUMBER:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INVALID_REQUEST_PARAM:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.INCORRECT_PHONE_COUNTRY_CODE;\n          break;\n        default:\n          break;\n      }\n    }\n  },\n  getQueryVariable(variable) {\n    let query = window.location.search.substring(1);\n    let vars = query.split(\"&\");\n    for (let i = 0; i < vars.length; i++) {\n      let pair = vars[i].split(\"=\");\n      if (pair[0] == variable) {\n        return pair[1];\n      }\n    }\n    return (false);\n  },\n  useWXCodeLogin(_code) {\n    const self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        code: _code\n      },\n      success: function(res) {\n        self.onWechatLoggedIn(res);\n      },\n      error: function(xhr, status, errMsg) {\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\n        cc.sys.localStorage.removeItem(\"selfPlayer\");\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        self.wechatLoginTips.string = constants.ALERT.TIP_LABEL.WECHAT_LOGIN_FAILS + \", errorMsg =\" + errMsg;\n        window.history.replaceState({}, null, window.location.pathname); \n      },\n    });\n  },\n  getWechatCode(evt) {\n    let self = this;\n    self.wechatLoginTips.string = \"\";\n    const wechatServerEndpoint = wechatAddress.PROTOCOL + \"://\" + wechatAddress.HOST + ((null != wechatAddress.PORT && \"\" != wechatAddress.PORT.trim()) ? (\":\" + wechatAddress.PORT) : \"\");\n    const url = wechatServerEndpoint + constants.WECHAT.AUTHORIZE_PATH + \"?\" + wechatAddress.APPID_LITERAL + \"&\" + constants.WECHAT.REDIRECT_RUI_KEY + NetworkUtils.encode(window.location.href) + \"&\" + constants.WECHAT.RESPONSE_TYPE + \"&\" + constants.WECHAT.SCOPE + constants.WECHAT.FIN;\n    window.location.href = url;\n  },\n  initWxSdk() {\n    if (undefined == wx) {\n      cc.warn(\"please build the project in web-mobile to use the wx jssdk\");\n      return;\n    }\n    const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n    const origUrl = window.location.protocol + \"//\" + window.location.host + window.location.pathname;\n    /*\n    * The `shareLink` must \n    * - have its 2nd-order-domain registered as trusted 2nd-order under the targetd `res.jsConfig.app_id`, and\n    * - extracted from current window.location.href.   \n    */\n    const shareLink = origUrl;\n    const updateAppMsgShareDataObj = {\n      type: 'link', // 分享类型,music、video或link，不填默认为link\n      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空\n      title: document.title, // 分享标题\n      desc: 'Let\\'s play together!', // 分享描述\n      link: shareLink + (null == cc.sys.localStorage.boundRoomId ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.boundRoomId)),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {\n        // 设置成功\n      }\n    };\n    const menuShareTimelineObj = {\n      title: document.title, // 分享标题\n      link: shareLink + (null == cc.sys.localStorage.boundRoomId ? \"\" : (\"?expectedRoomId=\" + cc.sys.localStorage.boundRoomId)),\n      imgUrl: origUrl + \"/favicon.ico\", // 分享图标\n      success: function() {}\n    };\n    //接入微信登录接口\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.WECHAT + constants.ROUTE_PATH.JSCONFIG,\n      type: \"POST\",\n      data: {\n        \"url\": shareLink,\n        \"intAuthToken\": selfPlayer.intAuthToken,\n      },\n      success: function(res) {\n        if (constants.RET_CODE.OK != res.ret) {\n          console.log(\"cannot get the wsConfig. retCode == \" + res.ret);\n          return;\n        }\n        console.log(res.jsConfig);\n        const jsConfig = res.jsConfig;\n        console.log(updateAppMsgShareDataObj);\n        const configData = {\n          debug: CC_DEBUG, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\n          appId: jsConfig.app_id, // 必填，公众号的唯一标识\n          timestamp: jsConfig.timestamp.toString(), // 必填，生成签名的时间戳\n          nonceStr: jsConfig.nonce_str, // 必填，生成签名的随机串\n          jsApiList: ['onMenuShareAppMessage'],\n          signature: jsConfig.signature, // 必填，签名\n        };\n        wx.config(configData);\n        wx.ready(function() {\n          console.log(\"wx config has succeeded, and there is wx.ready\")\n          wx.onMenuShareAppMessage(updateAppMsgShareDataObj);\n          wx.onMenuShareTimeline(menuShareTimelineObj);\n        });\n        wx.error(function(res) {\n          console.error(\"wx config fails and error is \" + JSON.stringify(res));\n        });\n      },\n      error: function(xhr, status, errMsg) {\n        console.log(\"cannot get the wsConfig. errMsg == \" + errMsg);\n      },\n    });\n  },\n});\n"]}