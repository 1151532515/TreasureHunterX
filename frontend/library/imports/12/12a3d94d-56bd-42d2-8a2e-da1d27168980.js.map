{"version":3,"sources":["../../../../assets/scripts/assets/scripts/Login.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","cavasNode","default","type","Node","backgroundNode","interactiveControls","phoneCountryCodeInput","phoneNumberInput","phoneNumberTips","smsLoginCaptchaInput","smsLoginCaptchaButton","captchaTips","loginButton","smsWaitCountdownPrefab","Prefab","loadingPrefab","onLoad","self","getRetCodeList","getRegexList","checkPhoneNumber","bind","checkIntAuthTokenExpire","checkCaptcha","onSMSCaptchaGetButtonClicked","on","loadingNode","instantiate","then","intAuthToken","JSON","parse","sys","localStorage","selfPlayer","useTokenLogin","smsGetCaptchaNode","getChildByName","smsWaitCountdownNode","retCodeDict","constants","RET_CODE","regexList","EMAIL","PHONE","STREET_META","LNG_LAT_TEXT","SEO_KEYWORD","PASSWORD","SMS_CAPTCHA_CODE","ADMIN_HANDLE","evt","timerEnable","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","SMS_CAPTCHA","GET","data","phoneCountryCode","getComponent","EditBox","string","phoneNum","success","res","ret","OK","Label","DUPLICATED","ALERT","TIP_LABEL","LOG_OUT","INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER","t","IS_TEST_ACC","smsLoginCaptcha","SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY","countdownTime","off","removeChild","parent","total","countdownTimer","setInterval","clearInterval","Promise","resolve","reject","Date","getTime","expiresAt","phoneNumberRegexp","phoneNumberString","test","captchaRegexp","captchaString","length","_intAuthToken","INT_AUTH_TOKEN","LOGIN","resp","onLoggedIn","enableInteractiveControls","enabled","Button","interactable","setVisible","setInvisible","onLoginButtonClicked","loginParams","timeout","log","stringify","date","Number","playerId","console","inputControls","safelyAddChild","runAction","repeatForever","rotateBy","director","loadScene","TOKEN_EXPIRED","SMS_CAPTCHA_NOT_MATCH","INCORRECT_CAPTCHA","SMS_CAPTCHA_CODE_NOT_EXISTING","INCORRECT_PHONE_NUMBER","INVALID_REQUEST_PARAM","INCORRECT_PHONE_COUNTRY_CODE"],"mappings":"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","file":"Login.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["const i18n = require('LanguageData');\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    cavasNode: {\n      default: null,\n      type: cc.Node\n    },\n    backgroundNode: {\n      default: null,\n      type: cc.Node\n    },\n    interactiveControls: {\n      default: null,\n      type: cc.Node\n    },\n    phoneCountryCodeInput: {\n      default: null,\n      type: cc.Node\n    },\n    phoneNumberInput: {\n      type: cc.Node,\n      default: null\n    },\n    phoneNumberTips: {\n      type: cc.Node,\n      default: null\n    },\n    smsLoginCaptchaInput: {\n      type: cc.Node,\n      default: null\n    },\n    smsLoginCaptchaButton: {\n      type: cc.Node,\n      default: null\n    },\n    captchaTips: {\n      type: cc.Node,\n      default: null\n    },\n    loginButton: {\n      type: cc.Node,\n      default: null\n    },\n    smsWaitCountdownPrefab: {\n      default: null,\n      type: cc.Prefab\n    },\n    loadingPrefab: {\n      default: null,\n      type: cc.Prefab\n    }\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    const self = this;\n    self.getRetCodeList();\n    self.getRegexList();\n    self.checkPhoneNumber = self.checkPhoneNumber.bind(self);\n    self.checkIntAuthTokenExpire = self.checkIntAuthTokenExpire.bind(self);\n    self.checkCaptcha = self.checkCaptcha.bind(self);\n    self.onSMSCaptchaGetButtonClicked = self.onSMSCaptchaGetButtonClicked.bind(self);\n    self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\n\n    self.loadingNode = cc.instantiate(this.loadingPrefab);\n    self.checkIntAuthTokenExpire().then(\n      () => {\n        const intAuthToken = JSON.parse(cc.sys.localStorage.selfPlayer).intAuthToken;\n        self.useTokenLogin(intAuthToken);\n      },\n      () => {\n        // TODO: Handle expired intAuthToken appropriately.\n      }\n    );\n    this.smsGetCaptchaNode = this.smsLoginCaptchaButton.getChildByName('smsGetCaptcha');\n    this.smsWaitCountdownNode = cc.instantiate(this.smsWaitCountdownPrefab);\n  },\n\n  getRetCodeList() {\n    const self = this;\n    self.retCodeDict = constants.RET_CODE;\n  },\n\n  getRegexList() {\n    const self = this;\n    self.regexList = {\n      EMAIL: /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/,\n      PHONE: /^\\+?[0-9]{8,14}$/,\n      STREET_META: /^.{5,100}$/,\n      LNG_LAT_TEXT: /^[0-9]+(\\.[0-9]{4,6})$/,\n      SEO_KEYWORD: /^.{2,50}$/,\n      PASSWORD: /^.{6,50}$/,\n      SMS_CAPTCHA_CODE: /^[0-9]{4}$/,\n      ADMIN_HANDLE: /^.{4,50}$/,\n    };\n  },\n\n  onSMSCaptchaGetButtonClicked(evt) {\n    var timerEnable = true;\n    const self = this;\n    if (!self.checkPhoneNumber('getCaptcha')) {\n      return;\n    }\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.GET,\n      type: 'GET',\n      data: {\n        phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n        phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string\n      },\n      success: function(res) {\n        switch (res.ret) {\n          case self.retCodeDict.OK:\n            self.phoneNumberTips.getComponent(cc.Label).string = '';\n            break;\n          case self.retCodeDict.DUPLICATED:\n            self.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n            break;\n          case self.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n            break;\n          case self.retCodeDict.IS_TEST_ACC:\n            self.smsLoginCaptchaInput.getComponent(cc.EditBox).string = res.smsLoginCaptcha;\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.TEST_USER\");\n            timerEnable = false;\n            // clearInterval(self.countdownTimer);\n            break;\n          case self.retCodeDict.SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY:\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_FREEQUENT_REQUIRE\");\n          default:\n            break;\n        }\n        if (timerEnable)\n          self.countdownTime(self);\n      }\n    });\n  },\n\n  countdownTime(self) {\n    self.smsLoginCaptchaButton.off('click', self.onSMSCaptchaGetButtonClicked);\n    self.smsLoginCaptchaButton.removeChild(self.smsGetCaptchaNode);\n    self.smsWaitCountdownNode.parent = self.smsLoginCaptchaButton;\n    var total = 20; // Magic number\n    self.countdownTimer = setInterval(function() {\n      if (total === 0) {\n        self.smsWaitCountdownNode.parent.removeChild(self.smsWaitCountdownNode);\n        self.smsGetCaptchaNode.parent = self.smsLoginCaptchaButton;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = 20;\n        self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\n        clearInterval(self.countdownTimer);\n      } else {\n        total--;\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = total;\n      }\n    }, 1000)\n\n  },\n\n  checkIntAuthTokenExpire() {\n    return new Promise((resolve, reject) => {\n      if (!cc.sys.localStorage.selfPlayer) {\n        reject();\n        return;\n      }\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\n      (selfPlayer.intAuthToken && new Date().getTime() < selfPlayer.expiresAt) ? resolve() : reject();\n    })\n  },\n\n  checkPhoneNumber(type) {\n    const self = this;\n    const phoneNumberRegexp = self.regexList.PHONE;\n    var phoneNumberString = self.phoneNumberInput.getComponent(cc.EditBox).string;\n    if (phoneNumberString) {\n      //TODO DEMO阶段，由后端校验手机号格式，过滤测试账号\n      return true;\n      if (!phoneNumberRegexp.test(phoneNumberString)) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'getCaptcha' || type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\n      }\n      return false;\n    }\n  },\n\n  checkCaptcha(type) {\n    const self = this;\n    const captchaRegexp = self.regexList.SMS_CAPTCHA_CODE;\n    var captchaString = self.smsLoginCaptchaInput.getComponent(cc.EditBox).string;\n\n    if (captchaString) {\n      if (self.smsLoginCaptchaInput.getComponent(cc.EditBox).string.length !== 4 || (!captchaRegexp.test(captchaString))) {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      if (type === 'login') {\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\n      }\n      return false;\n    }\n  },\n\n  useTokenLogin(_intAuthToken) {\n    var self = this;\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: {\n        intAuthToken: _intAuthToken\n      },\n      success: function(resp) {\n        self.onLoggedIn(resp)\n      }\n    });\n  },\n\n  enableInteractiveControls(enabled) {\n    this.smsLoginCaptchaButton.getComponent(cc.Button).interactable = enabled;\n    this.loginButton.getComponent(cc.Button).interactable = enabled;\n    this.phoneCountryCodeInput.getComponent(cc.EditBox).enabled = enabled;\n    this.phoneNumberInput.getComponent(cc.EditBox).enabled = enabled;\n    this.smsLoginCaptchaInput.getComponent(cc.EditBox).enabled = enabled;\n    if (enabled) {\n      setVisible(this.interactiveControls);\n    } else {\n      setInvisible(this.interactiveControls);\n    }\n  },\n\n  onLoginButtonClicked(evt) {\n    const self = this;\n    if (!self.checkPhoneNumber('login') || !self.checkCaptcha('login')) {\n      return;\n    }\n    self.loginParams = {\n      phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\n      phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string,\n      smsLoginCaptcha: self.smsLoginCaptchaInput.getComponent(cc.EditBox).string\n    };\n    self.enableInteractiveControls(false);\n\n    NetworkUtils.ajax({\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.LOGIN,\n      type: \"POST\",\n      data: self.loginParams,\n      success: function(resp) {\n        self.onLoggedIn(resp);\n      },\n      timeout: function() {\n        self.enableInteractiveControls(true);\n      }\n    });\n  },\n\n  onLoggedIn(res) {\n    const self = this;\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\n    if (res.ret === self.retCodeDict.OK) {\n      self.enableInteractiveControls(false);\n      const date = Number(res.expiresAt);\n      const selfPlayer = {\n        expiresAt: date,\n        playerId: res.playerId,\n        intAuthToken: res.intAuthToken\n      }\n      cc.sys.localStorage.selfPlayer = JSON.stringify(selfPlayer);\n      console.log('cc.sys.localStorage.selfPlayer = ' + cc.sys.localStorage.selfPlayer)\n      if (self.countdownTimer) {\n        clearInterval(self.countdownTimer);\n      }\n      const inputControls = self.backgroundNode.getChildByName(\"InteractiveControls\");\n      self.backgroundNode.removeChild(inputControls);\n      safelyAddChild(self.backgroundNode, self.loadingNode);\n      self.loadingNode.getChildByName('loadingSprite').runAction(\n        cc.repeatForever(cc.rotateBy(1.0, 360))\n      );\n      cc.director.loadScene('default_map');\n    } else {\n      self.enableInteractiveControls(true);\n      switch (res.ret) {\n        case self.retCodeDict.DUPLICATED:\n          this.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\n          break;\n        case this.retCodeDict.TOKEN_EXPIRED:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.TOKEN_EXPIRED;\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_NOT_MATCH:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_CAPTCHA:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.SMS_CAPTCHA_CODE_NOT_EXISTING:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_NUMBER:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INVALID_REQUEST_PARAM:\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\n          break;\n        case this.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE:\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.INCORRECT_PHONE_COUNTRY_CODE;\n          break;\n        default:\n          break;\n      }\n    }\n  },\n\n});\n"]}