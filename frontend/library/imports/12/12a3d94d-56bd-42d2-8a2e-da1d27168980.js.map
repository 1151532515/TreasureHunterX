{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Login.js"],"names":["i18n","require","init","window","language","cc","Class","extends","Component","properties","cavasNode","default","type","Node","backgroundNode","interactiveControls","phoneCountryCodeInput","phoneNumberInput","phoneNumberTips","smsLoginCaptchaInput","smsLoginCaptchaButton","captchaTips","loginButton","smsWaitCountdownPrefab","Prefab","loadingPrefab","onLoad","self","getRetCodeList","getRegexList","checkPhoneNumber","bind","checkIntAuthTokenExpire","checkCaptcha","onSMSCaptchaGetButtonClicked","on","loadingNode","instantiate","smsGetCaptchaNode","getChildByName","smsWaitCountdownNode","loader","loadRes","err","textAsset","error","message","protoRoot","protobuf","Root","parse","text","RoomDownsyncFrame","lookupType","then","intAuthToken","JSON","sys","localStorage","selfPlayer","useTokenLogin","retCodeDict","constants","RET_CODE","regexList","EMAIL","PHONE","STREET_META","LNG_LAT_TEXT","SEO_KEYWORD","PASSWORD","SMS_CAPTCHA_CODE","ADMIN_HANDLE","evt","timerEnable","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","ROUTE_PATH","API","PLAYER","VERSION","SMS_CAPTCHA","GET","data","phoneCountryCode","getComponent","EditBox","string","phoneNum","success","res","ret","OK","Label","DUPLICATED","ALERT","TIP_LABEL","LOG_OUT","INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER","t","IS_TEST_ACC","smsLoginCaptcha","SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY","countdownTime","off","removeChild","parent","total","countdownTimer","setInterval","clearInterval","Promise","resolve","reject","Date","getTime","expiresAt","phoneNumberRegexp","phoneNumberString","test","captchaRegexp","captchaString","length","_intAuthToken","INT_AUTH_TOKEN","LOGIN","resp","onLoggedIn","xhr","status","errMsg","log","clearBoundRoomIdInBothVolatileAndPersistentStorage","timeout","enableInteractiveControls","enabled","Button","interactable","setVisible","setInvisible","onLoginButtonClicked","loginParams","stringify","date","Number","playerId","displayName","inputControls","safelyAddChild","runAction","repeatForever","rotateBy","director","loadScene","TOKEN_EXPIRED","SMS_CAPTCHA_NOT_MATCH","INCORRECT_CAPTCHA","SMS_CAPTCHA_CODE_NOT_EXISTING","INCORRECT_PHONE_NUMBER","INVALID_REQUEST_PARAM","INCORRECT_PHONE_COUNTRY_CODE"],"mappings":"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","file":"Login.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    cavasNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    backgroundNode: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    interactiveControls: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    phoneCountryCodeInput: {\r\n      default: null,\r\n      type: cc.Node\r\n    },\r\n    phoneNumberInput: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    phoneNumberTips: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    smsLoginCaptchaInput: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    smsLoginCaptchaButton: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    captchaTips: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    loginButton: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    smsWaitCountdownPrefab: {\r\n      default: null,\r\n      type: cc.Prefab\r\n    },\r\n    loadingPrefab: {\r\n      default: null,\r\n      type: cc.Prefab\r\n    }\r\n  },\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n\r\n  onLoad() {\r\n    const self = this;\r\n    self.getRetCodeList();\r\n    self.getRegexList();\r\n    self.checkPhoneNumber = self.checkPhoneNumber.bind(self);\r\n    self.checkIntAuthTokenExpire = self.checkIntAuthTokenExpire.bind(self);\r\n    self.checkCaptcha = self.checkCaptcha.bind(self);\r\n    self.onSMSCaptchaGetButtonClicked = self.onSMSCaptchaGetButtonClicked.bind(self);\r\n    self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\r\n\r\n    self.loadingNode = cc.instantiate(this.loadingPrefab);\r\n    self.smsGetCaptchaNode = self.smsLoginCaptchaButton.getChildByName('smsGetCaptcha');\r\n    self.smsWaitCountdownNode = cc.instantiate(self.smsWaitCountdownPrefab);\r\n\r\n    cc.loader.loadRes(\"pbfiles/room_downsync_frame\", function(err, textAsset /* cc.TextAsset */) {\r\n      if (err) {\r\n        cc.error(err.message || err);\r\n        return;\r\n      }\r\n      let protoRoot = new protobuf.Root; \r\n      protobuf.parse(textAsset.text, protoRoot);\r\n      window.RoomDownsyncFrame = protoRoot.lookupType(\"models.RoomDownsyncFrame\");\r\n      self.checkIntAuthTokenExpire().then(\r\n        () => {\r\n          const intAuthToken = JSON.parse(cc.sys.localStorage.selfPlayer).intAuthToken;\r\n          self.useTokenLogin(intAuthToken);\r\n        },\r\n        () => {\r\n          // TODO: Handle expired intAuthToken appropriately.\r\n        }\r\n      );\r\n    });\r\n  },\r\n\r\n  getRetCodeList() {\r\n    const self = this;\r\n    self.retCodeDict = constants.RET_CODE;\r\n  },\r\n\r\n  getRegexList() {\r\n    const self = this;\r\n    self.regexList = {\r\n      EMAIL: /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/,\r\n      PHONE: /^\\+?[0-9]{8,14}$/,\r\n      STREET_META: /^.{5,100}$/,\r\n      LNG_LAT_TEXT: /^[0-9]+(\\.[0-9]{4,6})$/,\r\n      SEO_KEYWORD: /^.{2,50}$/,\r\n      PASSWORD: /^.{6,50}$/,\r\n      SMS_CAPTCHA_CODE: /^[0-9]{4}$/,\r\n      ADMIN_HANDLE: /^.{4,50}$/,\r\n    };\r\n  },\r\n\r\n  onSMSCaptchaGetButtonClicked(evt) {\r\n    var timerEnable = true;\r\n    const self = this;\r\n    if (!self.checkPhoneNumber('getCaptcha')) {\r\n      return;\r\n    }\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\r\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.GET,\r\n      type: 'GET',\r\n      data: {\r\n        phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\r\n        phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string\r\n      },\r\n      success: function(res) {\r\n        switch (res.ret) {\r\n          case self.retCodeDict.OK:\r\n            self.phoneNumberTips.getComponent(cc.Label).string = '';\r\n            self.captchaTips.getComponent(cc.Label).string = '';\r\n            break;\r\n          case self.retCodeDict.DUPLICATED:\r\n            self.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\r\n            break;\r\n          case self.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE_OR_NUMBER:\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n            break;\r\n          case self.retCodeDict.IS_TEST_ACC:\r\n            self.smsLoginCaptchaInput.getComponent(cc.EditBox).string = res.smsLoginCaptcha;\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.TEST_USER\");\r\n            timerEnable = false;\r\n            // clearInterval(self.countdownTimer);\r\n            break;\r\n          case self.retCodeDict.SMS_CAPTCHA_REQUESTED_TOO_FREQUENTLY:\r\n            self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_FREEQUENT_REQUIRE\");\r\n          default:\r\n            break;\r\n        }\r\n        if (timerEnable)\r\n          self.countdownTime(self);\r\n      }\r\n    });\r\n  },\r\n\r\n  countdownTime(self) {\r\n    self.smsLoginCaptchaButton.off('click', self.onSMSCaptchaGetButtonClicked);\r\n    self.smsLoginCaptchaButton.removeChild(self.smsGetCaptchaNode);\r\n    self.smsWaitCountdownNode.parent = self.smsLoginCaptchaButton;\r\n    var total = 20; // Magic number\r\n    self.countdownTimer = setInterval(function() {\r\n      if (total === 0) {\r\n        self.smsWaitCountdownNode.parent.removeChild(self.smsWaitCountdownNode);\r\n        self.smsGetCaptchaNode.parent = self.smsLoginCaptchaButton;\r\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = 20;\r\n        self.smsLoginCaptchaButton.on('click', self.onSMSCaptchaGetButtonClicked);\r\n        clearInterval(self.countdownTimer);\r\n      } else {\r\n        total--;\r\n        self.smsWaitCountdownNode.getChildByName('WaitTimeLabel').getComponent(cc.Label).string = total;\r\n      }\r\n    }, 1000)\r\n\r\n  },\r\n\r\n  checkIntAuthTokenExpire() {\r\n    return new Promise((resolve, reject) => {\r\n      if (!cc.sys.localStorage.selfPlayer) {\r\n        reject();\r\n        return;\r\n      }\r\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      (selfPlayer.intAuthToken && new Date().getTime() < selfPlayer.expiresAt) ? resolve() : reject();\r\n    })\r\n  },\r\n\r\n  checkPhoneNumber(type) {\r\n    const self = this;\r\n    const phoneNumberRegexp = self.regexList.PHONE;\r\n    var phoneNumberString = self.phoneNumberInput.getComponent(cc.EditBox).string;\r\n    if (phoneNumberString) {\r\n      return true;\r\n      if (!phoneNumberRegexp.test(phoneNumberString)) {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n        return false;\r\n      } else {\r\n        return true;\r\n      }\r\n    } else {\r\n      if (type === 'getCaptcha' || type === 'login') {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.PHONE_ERR\");\r\n      }\r\n      return false;\r\n    }\r\n  },\r\n\r\n  checkCaptcha(type) {\r\n    const self = this;\r\n    const captchaRegexp = self.regexList.SMS_CAPTCHA_CODE;\r\n    var captchaString = self.smsLoginCaptchaInput.getComponent(cc.EditBox).string;\r\n\r\n    if (captchaString) {\r\n      if (self.smsLoginCaptchaInput.getComponent(cc.EditBox).string.length !== 4 || (!captchaRegexp.test(captchaString))) {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\r\n        return false;\r\n      } else {\r\n        return true;\r\n      }\r\n    } else {\r\n      if (type === 'login') {\r\n        self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.CAPTCHA_ERR\");\r\n      }\r\n      return false;\r\n    }\r\n  },\r\n\r\n  useTokenLogin(_intAuthToken) {\r\n    var self = this;\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: {\r\n        intAuthToken: _intAuthToken\r\n      },\r\n      success: function(resp) {\r\n        self.onLoggedIn(resp)\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        cc.log(`Login attempt \"useTokenLogin\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\r\n      },\r\n      timeout: function() {\r\n        self.enableInteractiveControls(true);\r\n      },\r\n    });\r\n  },\r\n\r\n  enableInteractiveControls(enabled) {\r\n    this.smsLoginCaptchaButton.getComponent(cc.Button).interactable = enabled;\r\n    this.loginButton.getComponent(cc.Button).interactable = enabled;\r\n    this.phoneCountryCodeInput.getComponent(cc.EditBox).enabled = enabled;\r\n    this.phoneNumberInput.getComponent(cc.EditBox).enabled = enabled;\r\n    this.smsLoginCaptchaInput.getComponent(cc.EditBox).enabled = enabled;\r\n    if (enabled) {\r\n      setVisible(this.interactiveControls);\r\n    } else {\r\n      setInvisible(this.interactiveControls);\r\n    }\r\n  },\r\n\r\n  onLoginButtonClicked(evt) {\r\n    const self = this;\r\n    if (!self.checkPhoneNumber('login') || !self.checkCaptcha('login')) {\r\n      return;\r\n    }\r\n    self.loginParams = {\r\n      phoneCountryCode: self.phoneCountryCodeInput.getComponent(cc.EditBox).string,\r\n      phoneNum: self.phoneNumberInput.getComponent(cc.EditBox).string,\r\n      smsLoginCaptcha: self.smsLoginCaptchaInput.getComponent(cc.EditBox).string\r\n    };\r\n    self.enableInteractiveControls(false);\r\n\r\n    NetworkUtils.ajax({\r\n      url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER +\r\n        constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.SMS_CAPTCHA + constants.ROUTE_PATH.LOGIN,\r\n      type: \"POST\",\r\n      data: self.loginParams,\r\n      success: function(resp) {\r\n        self.onLoggedIn(resp);\r\n      },\r\n      error: function(xhr, status, errMsg) {\r\n        cc.log(`Login attempt \"onLoginButtonClicked\" failed, about to execute \"clearBoundRoomIdInBothVolatileAndPersistentStorage\".`);\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\r\n      },\r\n      timeout: function() {\r\n        self.enableInteractiveControls(true);\r\n      }\r\n    });\r\n  },\r\n\r\n  onLoggedIn(res) {\r\n    const self = this;\r\n    cc.log(`OnLoggedIn ${JSON.stringify(res)}.`)\r\n    if (res.ret === self.retCodeDict.OK) {\r\n      self.enableInteractiveControls(false);\r\n      const date = Number(res.expiresAt);\r\n      const selfPlayer = {\r\n        expiresAt: date,\r\n        playerId: res.playerId,\r\n        intAuthToken: res.intAuthToken,\r\n        displayName: res.displayName\r\n      }\r\n      cc.sys.localStorage.selfPlayer = JSON.stringify(selfPlayer);\r\n      cc.log(`cc.sys.localStorage.selfPlayer = ${cc.sys.localStorage.selfPlayer}`);\r\n      if (self.countdownTimer) {\r\n        clearInterval(self.countdownTimer);\r\n      }\r\n      const inputControls = self.backgroundNode.getChildByName(\"InteractiveControls\");\r\n      self.backgroundNode.removeChild(inputControls);\r\n      safelyAddChild(self.backgroundNode, self.loadingNode);\r\n      self.loadingNode.getChildByName('loadingSprite').runAction(\r\n        cc.repeatForever(cc.rotateBy(1.0, 360))\r\n      );\r\n      cc.director.loadScene('default_map');\r\n    } else {\r\n      self.enableInteractiveControls(true);\r\n      switch (res.ret) {\r\n        case self.retCodeDict.DUPLICATED:\r\n          this.phoneNumberTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.LOG_OUT;\r\n          break;\r\n        case this.retCodeDict.TOKEN_EXPIRED:\r\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.TOKEN_EXPIRED;\r\n          break;\r\n        case this.retCodeDict.SMS_CAPTCHA_NOT_MATCH:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_CAPTCHA:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.SMS_CAPTCHA_CODE_NOT_EXISTING:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.SMS_CAPTCHA_NOT_MATCH\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_PHONE_NUMBER:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\r\n          break;\r\n        case this.retCodeDict.INVALID_REQUEST_PARAM:\r\n          self.captchaTips.getComponent(cc.Label).string = i18n.t(\"login.tips.INCORRECT_PHONE_NUMBER\");\r\n          break;\r\n        case this.retCodeDict.INCORRECT_PHONE_COUNTRY_CODE:\r\n          this.captchaTips.getComponent(cc.Label).string = constants.ALERT.TIP_LABEL.INCORRECT_PHONE_COUNTRY_CODE;\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n  },\r\n});\r\n"]}