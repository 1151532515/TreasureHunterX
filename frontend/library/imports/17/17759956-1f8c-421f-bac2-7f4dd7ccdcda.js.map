{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\NPCPlayer.js"],"names":["COLLISION_WITH_PLAYER_STATE","WALKING_COLLIDABLE","STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM","STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM","STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM","STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM","STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM","STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM","WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER","STILL_NEAR_NOBODY_PLAYING_ANIM","STILL_NEAR_SELF_PLAYER_STATE_SET","Set","add","STILL_NEAR_OTHER_PLAYER_STATE_SET","STILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET","transitWalkingConditionallyCollidableToUnconditionallyCollidable","currentCollisionWithPlayerState","transitUponSelfPlayerLeftProximityArea","transitDueToNoBodyInProximityArea","transitToPlayingStunnedAnim","dueToSelfPlayer","dueToOtherPlayer","transitDuringPlayingStunnedAnim","dueToSelfPlayerComesIntoProximity","dueToOtherPlayerComesIntoProximity","transitStunnedAnimPlayingToPlayed","forceNotCollidableWithOtherPlayer","transitStunnedAnimPlayedToWalking","BasePlayer","require","cc","Class","extends","start","prototype","call","scheduleNewDirection","_generateRandomDirectionExcluding","onLoad","self","collisionWithPlayerState","clips","onStunnedAnimPlayedSafe","oldCollisionWithPlayerState","node","setTimeout","onStunnedAnimPlayedSafeAction","callFunc","playStunnedAnim","colliededAction1","rotateTo","colliededAction2","colliededAction3","runAction","sequence","player","pause","resume","_canMoveBy","vecToMoveBy","superRet","computedNewDifferentPosLocalToParentWithinCurrentFrame","position","currentSelfColliderCircle","getComponent","nextSelfColliderCircle","contactedBarriers","length","contactedNPCPlayers","contactedControlledPlayers","mutatedVecToMoveBy","mul","offset","radius","aCircleCollider","contactedCircleLocalToParentWithinCurrentFrame","Intersection","circleCircle","update","dt","scheduledDirection","dx","dy","tileCollisionManager","isOutOfMapNode","mapNode","onCollisionEnter","other","playerScriptIns","name","_addContactedControlledPlayers","has","oldState","onCollisionStay","onCollisionExit","_removeContactedControlledPlayer"],"mappings":"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","file":"NPCPlayer.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const COLLISION_WITH_PLAYER_STATE = {\r\n  WALKING_COLLIDABLE: 0,\r\n  STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM: 1,\r\n  STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM: 2,\r\n  STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM: 3,\r\n  STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM: 4,\r\n  STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM: 5,\r\n  STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM: 6,\r\n  WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER: 7,\r\n  STILL_NEAR_NOBODY_PLAYING_ANIM: 8,\r\n};\r\n\r\nconst STILL_NEAR_SELF_PLAYER_STATE_SET = new Set();\r\nSTILL_NEAR_SELF_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM);\r\nSTILL_NEAR_SELF_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM);\r\nSTILL_NEAR_SELF_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM);\r\nSTILL_NEAR_SELF_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM);\r\n\r\nconst STILL_NEAR_OTHER_PLAYER_STATE_SET = new Set();\r\nSTILL_NEAR_OTHER_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM);\r\nSTILL_NEAR_OTHER_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM);\r\nSTILL_NEAR_OTHER_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM);\r\nSTILL_NEAR_OTHER_PLAYER_STATE_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM);\r\n\r\nconst STILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET = new Set();\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM);\r\nSTILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.add(COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM);\r\n\r\nfunction transitWalkingConditionallyCollidableToUnconditionallyCollidable(currentCollisionWithPlayerState) {\r\n  switch (currentCollisionWithPlayerState) {\r\n    case COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER:\r\n      return COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE;\r\n  }\r\n\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitUponSelfPlayerLeftProximityArea(currentCollisionWithPlayerState) {\r\n  switch (currentCollisionWithPlayerState) {\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER;\r\n  }\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitDueToNoBodyInProximityArea(currentCollisionWithPlayerState) {\r\n  switch (currentCollisionWithPlayerState) {\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM:\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM:\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM:\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM:\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER;\r\n  }\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitToPlayingStunnedAnim(currentCollisionWithPlayerState, dueToSelfPlayer, dueToOtherPlayer) {\r\n  if (dueToSelfPlayer) {\r\n    switch (currentCollisionWithPlayerState) {\r\n      case COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE:\r\n      case COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM;\r\n    }\r\n  }\r\n\r\n  if (dueToOtherPlayer) {\r\n    switch (currentCollisionWithPlayerState) {\r\n      case COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM;\r\n    }\r\n  }\r\n  // TODO: Any error to throw?\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitDuringPlayingStunnedAnim(currentCollisionWithPlayerState, dueToSelfPlayerComesIntoProximity, dueToOtherPlayerComesIntoProximity) {\r\n  if (dueToSelfPlayerComesIntoProximity) {\r\n    switch (currentCollisionWithPlayerState) {\r\n      case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM;\r\n\r\n      case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM;\r\n    }\r\n  }\r\n\r\n  if (dueToOtherPlayerComesIntoProximity) {\r\n    switch (currentCollisionWithPlayerState) {\r\n      case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM;\r\n\r\n      case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM:\r\n        return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM;\r\n    }\r\n  }\r\n  // TODO: Any error to throw?\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitStunnedAnimPlayingToPlayed(currentCollisionWithPlayerState, forceNotCollidableWithOtherPlayer) {\r\n  switch (currentCollisionWithPlayerState) {\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYING_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM;\r\n\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_NOBODY_PLAYING_ANIM:\r\n      return (true == forceNotCollidableWithOtherPlayer ? COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER : COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE);\r\n  }\r\n  // TODO: Any error to throw?\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nfunction transitStunnedAnimPlayedToWalking(currentCollisionWithPlayerState) {\r\n  /*\r\n  * Intentionally NOT transiting for \r\n  *\r\n  * - STILL_NEAR_SELF_PLAYER_NEAR_OTHER_PLAYER_PLAYED_ANIM, or \r\n  * - STILL_NEAR_SELF_PLAYER_ONLY_PLAYED_ANIM,\r\n  *\r\n  * which should be transited upon leaving of \"SelfPlayer\".\r\n  */\r\n  switch (currentCollisionWithPlayerState) {\r\n    case COLLISION_WITH_PLAYER_STATE.STILL_NEAR_OTHER_PLAYER_ONLY_PLAYED_ANIM:\r\n      return COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER;\r\n  }\r\n  // TODO: Any error to throw?\r\n  return currentCollisionWithPlayerState;\r\n}\r\n\r\nconst BasePlayer = require(\"./BasePlayer\"); \r\n\r\ncc.Class({\r\n  extends: BasePlayer,\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n  start() {\r\n    BasePlayer.prototype.start.call(this);\r\n\r\n    this.scheduleNewDirection(this._generateRandomDirectionExcluding(0, 0));\r\n  },\r\n\r\n  onLoad() {\r\n    BasePlayer.prototype.onLoad.call(this);\r\n    const self = this;\r\n\r\n    this.collisionWithPlayerState = COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE;\r\n\r\n    this.clips = {\r\n      '01': 'FlatHeadSisterRunTop',\r\n      '0-1': 'FlatHeadSisterRunBottom',\r\n      '-20': 'FlatHeadSisterRunLeft',\r\n      '20': 'FlatHeadSisterRunRight',\r\n      '-21': 'FlatHeadSisterRunTopLeft',\r\n      '21': 'FlatHeadSisterRunTopRight',\r\n      '-2-1': 'FlatHeadSisterRunBottomLeft',\r\n      '2-1': 'FlatHeadSisterRunBottomRight'\r\n    };\r\n\r\n\r\n    self.onStunnedAnimPlayedSafe = () => {\r\n      const oldCollisionWithPlayerState = self.collisionWithPlayerState;\r\n      self.collisionWithPlayerState = transitStunnedAnimPlayingToPlayed(this.collisionWithPlayerState, true);\r\n      if (oldCollisionWithPlayerState == self.collisionWithPlayerState || !self.node) return;\r\n      \r\n      // TODO: Be more specific with \"toExcludeDx\" and \"toExcludeDy\".\r\n      self.scheduleNewDirection(self._generateRandomDirectionExcluding(0, 0)); \r\n      self.collisionWithPlayerState = transitStunnedAnimPlayedToWalking(self.collisionWithPlayerState);\r\n      setTimeout(() => {\r\n        self.collisionWithPlayerState = transitWalkingConditionallyCollidableToUnconditionallyCollidable(self.collisionWithPlayerState);\r\n      }, 5000);\r\n    };\r\n\r\n    self.onStunnedAnimPlayedSafeAction = cc.callFunc(self.onStunnedAnimPlayedSafe, self);\r\n\r\n    self.playStunnedAnim = () => {\r\n      let colliededAction1 = cc.rotateTo(0.2, -15);\r\n      let colliededAction2 = cc.rotateTo(0.3, 15);\r\n      let colliededAction3 = cc.rotateTo(0.2, 0);\r\n     \r\n      self.node.runAction(cc.sequence(\r\n        cc.callFunc(() => {\r\n          self.player.pause()\r\n        }, self), \r\n        colliededAction1, \r\n        colliededAction2, \r\n        colliededAction3, \r\n        cc.callFunc(() => {\r\n          self.player.resume()\r\n        }, self), \r\n        self.onStunnedAnimPlayedSafeAction\r\n      ));\r\n\r\n      // NOTE: Use <cc.Animation>.on('stop', self.onStunnedAnimPlayedSafe) if necessary.\r\n    }\r\n  },\r\n\r\n  _canMoveBy(vecToMoveBy) {\r\n    if (COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE_WITH_SELF_PLAYER_BUT_NOT_OTHER_PLAYER != this.collisionWithPlayerState && COLLISION_WITH_PLAYER_STATE.WALKING_COLLIDABLE != this.collisionWithPlayerState) {\r\n      return false;\r\n    }\r\n\r\n    const superRet = BasePlayer.prototype._canMoveBy.call(this, vecToMoveBy);\r\n    const self = this;\r\n\r\n    const computedNewDifferentPosLocalToParentWithinCurrentFrame = self.node.position.add(vecToMoveBy);\r\n\r\n    const currentSelfColliderCircle = self.node.getComponent(\"cc.CircleCollider\"); \r\n    let nextSelfColliderCircle = null;\r\n    if (0 < self.contactedBarriers.length || 0 < self.contactedNPCPlayers.length || 0 < self.contactedControlledPlayers) {\r\n      /* To avoid unexpected buckling. */\r\n      const mutatedVecToMoveBy = vecToMoveBy.mul(2);\r\n      nextSelfColliderCircle = {\r\n        position: self.node.position.add(vecToMoveBy.mul(2)).add(currentSelfColliderCircle.offset),  \r\n        radius: currentSelfColliderCircle.radius,\r\n      };\r\n    } else {\r\n      nextSelfColliderCircle = {\r\n        position: computedNewDifferentPosLocalToParentWithinCurrentFrame.add(currentSelfColliderCircle.offset),  \r\n        radius: currentSelfColliderCircle.radius,\r\n      };\r\n    }\r\n\r\n    for (let aCircleCollider of self.contactedControlledPlayers) {\r\n      let contactedCircleLocalToParentWithinCurrentFrame = {\r\n        position: aCircleCollider.node.position.add(aCircleCollider.offset),  \r\n        radius: aCircleCollider.radius,\r\n      };\r\n      if (cc.Intersection.circleCircle(contactedCircleLocalToParentWithinCurrentFrame, nextSelfColliderCircle)) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return superRet;\r\n  },\r\n\r\n  update(dt) {\r\n    const self = this;\r\n\r\n    BasePlayer.prototype.update.call(this, dt);\r\n\r\n    if (0 < self.contactedBarriers.length) {\r\n      self.scheduleNewDirection(self._generateRandomDirectionExcluding(self.scheduledDirection.dx, self.scheduledDirection.dy));\r\n    }\r\n\r\n    if (tileCollisionManager.isOutOfMapNode(self.mapNode, self.computedNewDifferentPosLocalToParentWithinCurrentFrame)) {\r\n      self.scheduleNewDirection(self._generateRandomDirectionExcluding(self.scheduledDirection.dx, self.scheduledDirection.dy));\r\n    } \r\n  },\r\n\r\n  onCollisionEnter(other, self) {\r\n    BasePlayer.prototype.onCollisionEnter.call(this, other, self);\r\n    const playerScriptIns = self.getComponent(self.node.name);\r\n    switch (other.node.name) {\r\n      case \"SelfPlayer\":\r\n        playerScriptIns._addContactedControlledPlayers(other);\r\n        if (1 == playerScriptIns.contactedControlledPlayers.length) {\r\n          // When \"SelfPlayer\" comes into proximity area.\r\n          if (!STILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.has(playerScriptIns.collisionWithPlayerState)) {\r\n            playerScriptIns.collisionWithPlayerState = transitToPlayingStunnedAnim(playerScriptIns.collisionWithPlayerState, true, false);\r\n            playerScriptIns.playStunnedAnim();\r\n          } else {\r\n            playerScriptIns.collisionWithPlayerState = transitDuringPlayingStunnedAnim(playerScriptIns.collisionWithPlayerState, true, false);\r\n          }\r\n        }\r\n        break;\r\n      case \"NPCPlayer\":\r\n        if (1 == playerScriptIns.contactedNPCPlayers.length) {\r\n          // When one of the other \"OtherPlayer\"s comes into proximity area.\r\n          if (!STILL_SHOULD_NOT_PLAY_STUNNED_ANIM_SET.has(playerScriptIns.collisionWithPlayerState)) {\r\n            const oldState = playerScriptIns.collisionWithPlayerState; \r\n            playerScriptIns.collisionWithPlayerState = transitToPlayingStunnedAnim(oldState, false, true);\r\n            if (playerScriptIns.collisionWithPlayerState != oldState) {\r\n              playerScriptIns.playStunnedAnim();\r\n            }\r\n          } else {\r\n            playerScriptIns.collisionWithPlayerState = transitDuringPlayingStunnedAnim(playerScriptIns.collisionWithPlayerState, false, true);\r\n          }\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  },\r\n\r\n  onCollisionStay(other, self) {\r\n    // TBD.\r\n  },\r\n\r\n  onCollisionExit(other, self) {\r\n    BasePlayer.prototype.onCollisionExit.call(this, other, self);\r\n    const playerScriptIns = self.getComponent(self.node.name);\r\n    switch (other.node.name) {\r\n      case \"SelfPlayer\":\r\n        playerScriptIns._removeContactedControlledPlayer(other);\r\n        if (0 == playerScriptIns.contactedControlledPlayers.length) {\r\n          // Special release step.\r\n          if (STILL_NEAR_SELF_PLAYER_STATE_SET.has(playerScriptIns.collisionWithPlayerState)) {\r\n            playerScriptIns.collisionWithPlayerState = transitUponSelfPlayerLeftProximityArea(playerScriptIns.collisionWithPlayerState);\r\n          }\r\n        }\r\n        if (0 == playerScriptIns.contactedControlledPlayers.length && 0 == playerScriptIns.contactedNPCPlayers.length) {\r\n          transitDueToNoBodyInProximityArea(playerScriptIns.collisionWithPlayerState);\r\n        }\r\n        break;\r\n      case \"NPCPlayer\":\r\n        if (0 == playerScriptIns.contactedControlledPlayers.length && 0 == playerScriptIns.contactedNPCPlayers.length) {\r\n          transitDueToNoBodyInProximityArea(playerScriptIns.collisionWithPlayerState);\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    } \r\n  },\r\n});\r\n"]}