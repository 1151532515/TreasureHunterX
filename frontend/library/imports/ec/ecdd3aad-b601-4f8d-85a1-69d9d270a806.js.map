{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\FindingPlayer.js"],"names":["cc","Class","extends","Component","properties","firstPlayerInfoNode","type","Node","default","secondPlayerInfoNode","findingAnimNode","myAvatarNode","exitBtnNode","onLoad","sys","platform","WECHAT_GAME","boundRoomId","window","getBoundRoomIdFromPersistentStorage","wxToShareMessage","title","imageUrl","imageUrlId","query","console","warn","wx","showShareMenu","onShareAppMessage","init","active","playersInfoNode","Object","assign","hideExitButton","exitBtnOnClick","evt","clearBoundRoomIdInBothVolatileAndPersistentStorage","closeWSConnection","director","loadScene","updatePlayersInfo","playerMetas","i","playerMeta","playerInfoNode","joinIndex","log","remoteUrl","avatar","loader","load","url","err","texture","error","sf","SpriteFrame","setTexture","getChildByName","getComponent","Sprite","spriteFrame","isEmptyString","str","nameNode","nameToDisplay","displayName","name","Label","string"],"mappings":"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","file":"FindingPlayer.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    firstPlayerInfoNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    secondPlayerInfoNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    findingAnimNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    myAvatarNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    exitBtnNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    }\r\n  },\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n  onLoad() {\r\n    // WARNING: 不能保证在ws连接成功并且拿到boundRoomId后才运行到此处。\r\n    if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n      const boundRoomId = window.getBoundRoomIdFromPersistentStorage();\r\n      const wxToShareMessage = {\r\n        title: '夺宝大作战',\r\n        imageUrl: 'https://mmocgame.qpic.cn/wechatgame/ibxA6JVNslX02zq6aAWCZiaWTXLYGorrVgUszo3WH1oL1CFDcFU7VKPRXPFiadxagMR/0',\r\n        imageUrlId: 'FiLZpa5FT5GgEeEagzGBsA',\r\n        query: 'expectedRoomId=' + boundRoomId,\r\n      };\r\n      console.warn(\"The boundRoomId for sharing: \", boundRoomId, \" wxToShareMessage \", wxToShareMessage);\r\n      wx.showShareMenu();\r\n      wx.onShareAppMessage(() => (wxToShareMessage));\r\n    }\r\n  },\r\n\r\n  init() {\r\n    this.firstPlayerInfoNode.active = false;\r\n    this.secondPlayerInfoNode.active = false;\r\n    this.playersInfoNode = {};\r\n    Object.assign(this.playersInfoNode, {\r\n      1: this.firstPlayerInfoNode\r\n    });\r\n    Object.assign(this.playersInfoNode, {\r\n      2: this.secondPlayerInfoNode\r\n    });\r\n\r\n    window.firstPlayerInfoNode = this.firstPlayerInfoNode;\r\n    this.findingAnimNode.active = true;\r\n\r\n  },\r\n  hideExitButton() {\r\n    if (this.exitBtnNode != null) {\r\n      this.exitBtnNode.active = false;\r\n    }\r\n  },\r\n\r\n  exitBtnOnClick(evt) {\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    window.closeWSConnection();\r\n    if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n      cc.director.loadScene('wechatGameLogin');\r\n    } else {\r\n      cc.director.loadScene('login');\r\n    }\r\n  },\r\n\r\n  updatePlayersInfo(playerMetas) {\r\n    if (!playerMetas) return;\r\n    for (let i in playerMetas) {\r\n      const playerMeta = playerMetas[i];\r\n      const playerInfoNode = this.playersInfoNode[playerMeta.joinIndex];\r\n      playerInfoNode.active = true;\r\n      if (2 == playerMeta.joinIndex) {\r\n        this.findingAnimNode.active = false;\r\n      }\r\n    }\r\n\r\n    //显示自己的头像名称以及他人的头像名称\r\n    for (let i in playerMetas) {\r\n      const playerMeta = playerMetas[i];\r\n      console.log(\"Showing playerMeta:\", playerMeta);\r\n      const playerInfoNode = this.playersInfoNode[playerMeta.joinIndex];\r\n\r\n      (() => { //远程加载头像\r\n        let remoteUrl = playerMeta.avatar;\r\n        if (remoteUrl == null || remoteUrl == '') {\r\n          cc.log(`No avatar to show for :`);\r\n          cc.log(playerMeta);\r\n          remoteUrl = 'http://wx.qlogo.cn/mmopen/PiajxSqBRaEJUWib5D85KXWHumaxhU4E9XOn9bUpCNKF3F4ibfOj8JYHCiaoosvoXCkTmOQE1r2AKKs8ObMaz76EdA/0'\r\n        }\r\n        cc.loader.load({\r\n          url: remoteUrl,\r\n          type: 'jpg'\r\n        }, function(err, texture) {\r\n          if (err != null) {\r\n            console.error(err);\r\n          } else {\r\n            const sf = new cc.SpriteFrame();\r\n            sf.setTexture(texture);\r\n            playerInfoNode.getChildByName('avatarMask').getChildByName('avatar').getComponent(cc.Sprite).spriteFrame = sf;\r\n          }\r\n        });\r\n      })();\r\n\r\n      function isEmptyString(str) {\r\n        return str == null || str == ''\r\n      }\r\n\r\n      const nameNode = playerInfoNode.getChildByName(\"name\");\r\n      const nameToDisplay = (() => {\r\n        if (!isEmptyString(playerMeta.displayName)) {\r\n          return playerMeta.displayName\r\n        } else if (!isEmptyString(playerMeta.name)) {\r\n          return playerMeta.name\r\n        } else {\r\n          return \"No name\"\r\n        }\r\n      })();\r\n      nameNode.getComponent(cc.Label).string = nameToDisplay;\r\n    }\r\n  },\r\n});\r\n"]}