{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\WsSessionMgr.js"],"names":["window","sendSafely","msgStr","clientSession","readyState","WebSocket","OPEN","send","closeWSConnection","console","log","close","getBoundRoomIdFromPersistentStorage","boundRoomIdExpiresAt","parseInt","cc","sys","localStorage","getItem","Date","now","clearBoundRoomIdInBothVolatileAndPersistentStorage","boundRoomId","removeItem","clearSelfPlayer","handleHbRequirements","resp","constants","RET_CODE","OK","ret","data","setItem","clientSessionPingInterval","setInterval","param","msgId","act","clientTimestamp","JSON","stringify","intervalToPing","handleHbPong","_base64ToUint8Array","base64","origBytes","atob","origBinaryStr","origLen","length","Uint8Array","i","charCodeAt","platform","WECHAT_GAME","Buffer","from","_base64ToArrayBuffer","buffer","getExpectedRoomIdSync","expectedRoomId","qDict","getQueryParamDict","history","state","unsetClientSessionCloseOrErrorFlag","setClientSessionCloseOrErrorFlag","oldVal","initPersistentSessionClient","onopenCb","intAuthToken","parse","urlToConnect","backendAddress","PROTOCOL","replace","HOST","PORT","WS_PATH_PREFIX","currentHistoryState","replaceState","document","title","location","pathname","onopen","event","onmessage","handleRoomDownsyncFrame","typedArray","parsedRoomDownsyncFrame","RoomDownsyncFrame","decode","handleGameReadyResp","e","warn","onerror","error","clearInterval","handleClientSessionCloseOrError","onclose","wasClean","code","PLAYER_NOT_FOUND","PLAYER_CHEATING","clearLocalStorageAndBackToLoginScene","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","mapIns","musicEffectManagerScriptIns","stopAllMusic","director","loadScene"],"mappings":"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","file":"WsSessionMgr.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["window.sendSafely = function(msgStr) {\r\n  /**\r\n  * - \"If the data can't be sent (for example, because it needs to be buffered but the buffer is full), the socket is closed automatically.\"\r\n  *\r\n  * from https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/send.\r\n  */\r\n  if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) return false;\r\n  window.clientSession.send(msgStr);\r\n}\r\n\r\nwindow.closeWSConnection = function() {\r\n  if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) return;\r\n  console.log(`Closing \"window.clientSession\" from the client-side.`);\r\n  window.clientSession.close();\r\n}\r\n\r\nwindow.getBoundRoomIdFromPersistentStorage = function() {\r\n  const boundRoomIdExpiresAt = parseInt(cc.sys.localStorage.getItem(\"boundRoomIdExpiresAt\"));\r\n  if (!boundRoomIdExpiresAt || Date.now() >= boundRoomIdExpiresAt) {\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    return null;\r\n  }\r\n  return cc.sys.localStorage.getItem(\"boundRoomId\");\r\n};\r\n\r\nwindow.clearBoundRoomIdInBothVolatileAndPersistentStorage = function() {\r\n  window.boundRoomId = null;\r\n  cc.sys.localStorage.removeItem(\"boundRoomId\");\r\n  cc.sys.localStorage.removeItem(\"boundRoomIdExpiresAt\");\r\n};\r\n\r\nwindow.clearSelfPlayer = function() {\r\n  cc.sys.localStorage.removeItem(\"selfPlayer\");\r\n};\r\n\r\nwindow.boundRoomId = getBoundRoomIdFromPersistentStorage();\r\nwindow.handleHbRequirements = function(resp) {\r\n  if (constants.RET_CODE.OK != resp.ret) return;\r\n  if (null == window.boundRoomId) {\r\n    window.boundRoomId = resp.data.boundRoomId;\r\n    cc.sys.localStorage.setItem('boundRoomId', window.boundRoomId);\r\n    cc.sys.localStorage.setItem('boundRoomIdExpiresAt', Date.now() + 10 * 60 * 1000); // Temporarily hardcoded, for `boundRoomId` only.\r\n  }\r\n\r\n  window.clientSessionPingInterval = setInterval(() => {\r\n    if (clientSession.readyState != WebSocket.OPEN) return;\r\n    const param = {\r\n      msgId: Date.now(),\r\n      act: \"HeartbeatPing\",\r\n      data: {\r\n        clientTimestamp: Date.now()\r\n      }\r\n    };\r\n    window.sendSafely(JSON.stringify(param));\r\n  }, resp.data.intervalToPing);\r\n};\r\n\r\nwindow.handleHbPong = function(resp) {\r\n  if (constants.RET_CODE.OK != resp.ret) return;\r\n// TBD.\r\n};\r\n\r\nfunction _base64ToUint8Array(base64) {\r\n  var origBytes = null;\r\n  if (null != window.atob) {\r\n    var origBinaryStr = window.atob(base64);\r\n    var origLen = origBinaryStr.length;\r\n    origBytes = new Uint8Array(origLen);\r\n    for (var i = 0; i < origLen; i++) {\r\n      origBytes[i] = origBinaryStr.charCodeAt(i);\r\n    }\r\n    return origBytes;\r\n  } else if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n    return Buffer.from(base64, 'base64');\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction _base64ToArrayBuffer(base64) {\r\n  return _base64ToUint8Array(base64).buffer;\r\n}\r\n\r\nwindow.getExpectedRoomIdSync = function() {\r\n  if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n    return window.expectedRoomId;\r\n  } else {\r\n    const qDict = window.getQueryParamDict();\r\n    if (qDict) {\r\n      return qDict[\"expectedRoomId\"];\r\n    } else {\r\n      if (window.history && window.history.state) {\r\n        return window.history.state.expectedRoomId;\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n};\r\n\r\nwindow.unsetClientSessionCloseOrErrorFlag = function() {\r\n  cc.sys.localStorage.removeItem(\"ClientSessionCloseOrErrorFlag\");\r\n  return;\r\n}\r\n\r\nwindow.setClientSessionCloseOrErrorFlag = function() {\r\n  const oldVal = cc.sys.localStorage.getItem(\"ClientSessionCloseOrErrorFlag\");\r\n  if (true == oldVal) return false;\r\n  cc.sys.localStorage.setItem(\"ClientSessionCloseOrErrorFlag\", true);\r\n  return true;\r\n}\r\n\r\nwindow.initPersistentSessionClient = function(onopenCb, expectedRoomId) {\r\n  if (window.clientSession && window.clientSession.readyState == WebSocket.OPEN) {\r\n    if (null != onopenCb) {\r\n      onopenCb();\r\n    }\r\n    return;\r\n  }\r\n\r\n  const intAuthToken = cc.sys.localStorage.getItem(\"selfPlayer\") ? JSON.parse(cc.sys.localStorage.getItem('selfPlayer')).intAuthToken : \"\";\r\n\r\n  let urlToConnect = backendAddress.PROTOCOL.replace('http', 'ws') + '://' + backendAddress.HOST + \":\" + backendAddress.PORT + backendAddress.WS_PATH_PREFIX + \"?intAuthToken=\" + intAuthToken;\r\n\r\n  if (null != expectedRoomId) {\r\n    console.log(\"initPersistentSessionClient with expectedRoomId == \" + expectedRoomId);\r\n    urlToConnect = urlToConnect + \"&expectedRoomId=\" + expectedRoomId;\r\n    if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n      // This is a dirty hack. -- YFLu\r\n      window.expectedRoomId = null;\r\n    }\r\n  } else {\r\n    window.boundRoomId = getBoundRoomIdFromPersistentStorage();\r\n    if (null != window.boundRoomId) {\r\n      console.log(\"initPersistentSessionClient with boundRoomId == \" + boundRoomId);\r\n      urlToConnect = urlToConnect + \"&boundRoomId=\" + window.boundRoomId;\r\n    }\r\n  }\r\n\r\n  const currentHistoryState = window.history && window.history.state ? window.history.state : {};\r\n\r\n  if (cc.sys.platform != cc.sys.WECHAT_GAME) {\r\n    window.history.replaceState(currentHistoryState, document.title, window.location.pathname);\r\n  }\r\n\r\n  const clientSession = new WebSocket(urlToConnect);\r\n\r\n  clientSession.onopen = function(event) {\r\n    console.log(\"The WS clientSession is opened.\");\r\n    window.clientSession = clientSession;\r\n    if (null == onopenCb) return;\r\n    onopenCb();\r\n  };\r\n\r\n  clientSession.onmessage = function(event) {\r\n    if (null == event || null == event.data) {\r\n      return;\r\n    }\r\n    try {\r\n      const resp = JSON.parse(event.data)\r\n      switch (resp.act) {\r\n        case \"HeartbeatRequirements\":\r\n          window.handleHbRequirements(resp); //获取boundRoomId并存储到localStorage\r\n          break;\r\n        case \"HeartbeatPong\":\r\n          window.handleHbPong(resp);\r\n          break;\r\n        case \"RoomDownsyncFrame\":\r\n          if (window.handleRoomDownsyncFrame) {\r\n            const typedArray = _base64ToUint8Array(resp.data);\r\n            const parsedRoomDownsyncFrame = (() => {\r\n              return window.RoomDownsyncFrame.decode(typedArray);\r\n            })();\r\n            window.handleRoomDownsyncFrame(parsedRoomDownsyncFrame);\r\n          }\r\n          break;\r\n        case \"Ready\": {\r\n          if (window.handleGameReadyResp) {\r\n            window.handleGameReadyResp(resp);\r\n          }\r\n          break;\r\n        }\r\n        default:\r\n          break;\r\n      }\r\n    } catch (e) {\r\n      console.warn(\"Unexpected error when parsing data of:\", event.data);\r\n    }\r\n  };\r\n\r\n  clientSession.onerror = function(event) {\r\n    if (!window.setClientSessionCloseOrErrorFlag()) {\r\n      return;\r\n    }\r\n    console.error(\"Error caught on the WS clientSession: \", event);\r\n    if (window.clientSessionPingInterval) {\r\n      clearInterval(window.clientSessionPingInterval);\r\n    }\r\n    if (window.handleClientSessionCloseOrError) {\r\n      window.handleClientSessionCloseOrError();\r\n    }\r\n    window.unsetClientSessionCloseOrErrorFlag();\r\n  };\r\n\r\n  clientSession.onclose = function(event) {\r\n    if (!window.setClientSessionCloseOrErrorFlag()) {\r\n      return;\r\n    }\r\n    console.warn(\"The WS clientSession is closed: \", event);\r\n    if (window.clientSessionPingInterval) {\r\n      clearInterval(window.clientSessionPingInterval);\r\n    }\r\n    if (false == event.wasClean) {\r\n      // Chrome doesn't allow the use of \"CustomCloseCode\"s (yet) and will callback with a \"WebsocketStdCloseCode 1006\" and \"false == event.wasClean\" here. See https://tools.ietf.org/html/rfc6455#section-7.4 for more information.\r\n      if (window.handleClientSessionCloseOrError) {\r\n        window.handleClientSessionCloseOrError();\r\n      }\r\n    } else {\r\n      switch (event.code) {\r\n        case constants.RET_CODE.PLAYER_NOT_FOUND:\r\n        case constants.RET_CODE.PLAYER_CHEATING:\r\n          window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n\r\n      if (window.handleClientSessionCloseOrError) {\r\n        window.handleClientSessionCloseOrError();\r\n      }\r\n    }\r\n    window.unsetClientSessionCloseOrErrorFlag();\r\n  };\r\n};\r\n\r\nwindow.clearLocalStorageAndBackToLoginScene = function(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n  console.warn(\"+++++++ Calling `clearLocalStorageAndBackToLoginScene`\");\r\n\r\n  if (window.mapIns && window.mapIns.musicEffectManagerScriptIns) {\r\n    window.mapIns.musicEffectManagerScriptIns.stopAllMusic();\r\n  }\r\n  /**\r\n   * Here I deliberately removed the callback in the \"common `handleClientSessionCloseOrError` callback\"\r\n   * within which another invocation to `clearLocalStorageAndBackToLoginScene` will be made.\r\n   *\r\n   * It'll be re-assigned to the common one upon reentrance of `Map.onLoad`.\r\n   *\r\n   * -- YFLu 2019-04-06\r\n   */\r\n  window.handleClientSessionCloseOrError = () => {\r\n    console.warn(\"+++++++ Special handleClientSessionCloseOrError() assigned within `clearLocalStorageAndBackToLoginScene`\");\r\n    // TBD.\r\n    window.handleClientSessionCloseOrError = null; // To ensure that it's called at most once. \r\n  };\r\n  window.closeWSConnection();\r\n  window.clearSelfPlayer();\r\n  if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n  }\r\n  if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n    cc.director.loadScene('wechatGameLogin');\r\n  } else {\r\n    cc.director.loadScene('login');\r\n  }\r\n};\r\n\r\n"]}