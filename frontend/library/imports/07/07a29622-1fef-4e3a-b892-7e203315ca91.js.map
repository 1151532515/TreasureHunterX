{"version":3,"sources":["../../../../assets/scripts/assets/scripts/WsSessionMgr.js"],"names":["window","sendSafely","msgStr","clientSession","readyState","WebSocket","OPEN","send","closeWSConnection","cc","log","close","getBoundRoomIdFromPersistentStorage","expiresAt","parseInt","sys","localStorage","Date","now","clearBoundRoomIdInBothVolatileAndPersistentStorage","boundRoomId","removeItem","handleHbRequirements","resp","constants","RET_CODE","OK","ret","data","clientSessionPingInterval","setInterval","param","msgId","act","clientTimestamp","JSON","stringify","intervalToPing","handleHbPong","getQueryVariable","variable","query","location","search","substring","vars","split","i","length","pair","_base64ToUint8Array","base64","binary_string","atob","len","bytes","Uint8Array","charCodeAt","_base64ToArrayBuffer","buffer","initPersistentSessionClient","onopenCb","intAuthToken","selfPlayer","parse","urlToConnect","backendAddress","PROTOCOL","replace","HOST","PORT","WS_PATH_PREFIX","expectedRoomId","history","replaceState","pathname","onopen","event","onmessage","handleRoomDownsyncFrame","typedArray","parsedRoomDownsyncFrame","RoomDownsyncFrame","decode","handleGameReadyResp","onerror","error","clearInterval","handleClientSessionCloseOrError","onclose","wasClean","code","LOCALLY_NO_SPECIFIED_ROOM","PLAYER_NOT_ADDABLE_TO_ROOM","PLAYER_NOT_READDABLE_TO_ROOM","PLAYER_NOT_FOUND","PLAYER_CHEATING"],"mappings":"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","file":"WsSessionMgr.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["\n\nwindow.sendSafely = function(msgStr) {\n  /**\n  * - \"If the data can't be sent (for example, because it needs to be buffered but the buffer is full), the socket is closed automatically.\"\n  *\n  * from https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/send.\n  */\n  if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) return false;\n  window.clientSession.send(msgStr);\n}\n\nwindow.closeWSConnection = function() {\n  if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) return;\n  cc.log(`Closing \"window.clientSession\" from the client-side.`);\n  window.clientSession.close();\n}\n\nwindow.getBoundRoomIdFromPersistentStorage = function() {\n  const expiresAt = parseInt(cc.sys.localStorage.expiresAt);\n  if(!expiresAt || Date.now() >= expiresAt) {\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage();    \n    return null;\n  }\n  return cc.sys.localStorage.boundRoomId;\n};\n\nwindow.clearBoundRoomIdInBothVolatileAndPersistentStorage = function() {\n  window.boundRoomId = null;\n  cc.sys.localStorage.removeItem(\"boundRoomId\");\n  cc.sys.localStorage.removeItem(\"expiresAt\");\n};\n\nwindow.boundRoomId = getBoundRoomIdFromPersistentStorage();\nwindow.handleHbRequirements = function(resp) {\n  if (constants.RET_CODE.OK != resp.ret) return;\n  if (null == window.boundRoomId) {\n    window.boundRoomId = resp.data.boundRoomId; \n    cc.sys.localStorage.boundRoomId = window.boundRoomId;\n    cc.sys.localStorage.expiresAt = Date.now() + 10 * 60 * 1000 ;//TODO: hardcoded, boundRoomId过期时间\n  } \n\n  window.clientSessionPingInterval = setInterval(() => {\n    if (clientSession.readyState != WebSocket.OPEN) return;\n    const param = {\n      msgId: Date.now(),\n      act: \"HeartbeatPing\",\n      data: {\n        clientTimestamp: Date.now()\n      }\n    };\n    window.sendSafely(JSON.stringify(param));\n  }, resp.data.intervalToPing);\n};\n\nwindow.handleHbPong = function(resp) {\n  if (constants.RET_CODE.OK != resp.ret) return;\n// TBD.\n};\nfunction getQueryVariable(variable) {\n    let query = window.location.search.substring(1);\n    let vars = query.split(\"&\");\n    for (let i = 0; i < vars.length; i++) {\n      let pair = vars[i].split(\"=\");\n      if (pair[0] == variable) {\n        return pair[1];\n      }\n    }\n    return (false);\n  }\n\nfunction _base64ToUint8Array(base64) {\n    var binary_string =  window.atob(base64);\n    var len = binary_string.length;\n    var bytes = new Uint8Array( len );\n    for (var i = 0; i < len; i++)        {\n        bytes[i] = binary_string.charCodeAt(i);\n    }\n    return bytes;\n}\n\nfunction _base64ToArrayBuffer(base64) {\n    return _base64ToUint8Array(base64).buffer;\n}\n\n\nwindow.initPersistentSessionClient = function(onopenCb) {\n  if (window.clientSession && window.clientSession.readyState == WebSocket.OPEN) {\n    if (null != onopenCb) {\n      onopenCb();\n    }\n    return;\n  }\n\n  const intAuthToken = cc.sys.localStorage.selfPlayer ? JSON.parse(cc.sys.localStorage.selfPlayer).intAuthToken : \"\";\n\n  let urlToConnect = backendAddress.PROTOCOL.replace('http', 'ws') + '://' + backendAddress.HOST + \":\" + backendAddress.PORT + backendAddress.WS_PATH_PREFIX + \"?intAuthToken=\" + intAuthToken;\n\n  window.boundRoomId = getBoundRoomIdFromPersistentStorage();\n  if (null != window.boundRoomId) {\n    urlToConnect = urlToConnect + \"&boundRoomId=\" + window.boundRoomId;\n  }else {\n      //处理expectedRoomId\n      const expectedRoomId = getQueryVariable(\"expectedRoomId\");\n      if(expectedRoomId) {\n        urlToConnect = urlToConnect + \"&expectedRoomId=\" + expectedRoomId;\n        window.history.replaceState({}, null, window.location.pathname); \n      }\n  }\n  const clientSession = new WebSocket(urlToConnect);\n\n  clientSession.onopen = function(event) {\n    cc.log(\"The WS clientSession is opened.\");\n    window.clientSession = clientSession;\n    if (null == onopenCb) return;\n    onopenCb();\n  };\n\n  clientSession.onmessage = function(event) {\n    const resp = JSON.parse(event.data)\n    switch (resp.act) {\n      case \"HeartbeatRequirements\":\n        window.handleHbRequirements(resp);\n        break;\n      case \"HeartbeatPong\":\n        window.handleHbPong(resp);\n        break;\n      case \"RoomDownsyncFrame\":\n        if (window.handleRoomDownsyncFrame) {\n          const typedArray = _base64ToUint8Array(resp.data);\n          const parsedRoomDownsyncFrame = window.RoomDownsyncFrame.decode(typedArray);\n          window.handleRoomDownsyncFrame(parsedRoomDownsyncFrame);\n        }\n        break; \n      case \"Ready\": {\n        if (window.handleGameReadyResp) {\n          window.handleGameReadyResp(resp);\n        }\n        break;\n      }\n      default:\n        cc.log(`${JSON.stringify(resp)}`);\n        break;\n    }\n  };\n\n  clientSession.onerror = function(event) {\n    cc.error(`Error caught on the WS clientSession:`, event);\n    if (window.clientSessionPingInterval) {\n      clearInterval(window.clientSessionPingInterval);\n    }\n    if (window.handleClientSessionCloseOrError) {\n      window.handleClientSessionCloseOrError();\n    }\n  };\n\n  clientSession.onclose = function(event) {\n    cc.log(`The WS clientSession is closed:`, event);\n    if (window.clientSessionPingInterval) {\n      clearInterval(window.clientSessionPingInterval);\n    }\n    if (!event.wasClean) {\n      // Chrome doesn't allow the use of \"CustomCloseCode\"s (yet) and will callback with a \"WebsocketStdCloseCode 1006\" and \"false == event.wasClean\" here. See https://tools.ietf.org/html/rfc6455#section-7.4 for more information.\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n    }\n    switch (event.code) {\n      case constants.RET_CODE.LOCALLY_NO_SPECIFIED_ROOM:\n      case constants.RET_CODE.PLAYER_NOT_ADDABLE_TO_ROOM:\n      case constants.RET_CODE.PLAYER_NOT_READDABLE_TO_ROOM:\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        window.initPersistentSessionClient(onopenCb);\n        return;\n      case constants.RET_CODE.PLAYER_NOT_FOUND:\n      case constants.RET_CODE.PLAYER_CHEATING:\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\n        break;\n      default:\n        break;\n    }\n    if (window.handleClientSessionCloseOrError) {\n      window.handleClientSessionCloseOrError();\n    }\n  };\n};\n\n"]}